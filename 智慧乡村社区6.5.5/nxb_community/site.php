<?php
 defined('IN_IA') or exit('Access Denied'); class Nxb_communityModuleSite extends WeModuleSite { protected function get_allnet() { goto fR1WX; fR1WX: global $_W, $_GPC; goto TiGKK; TiGKK: $config = $this->module['config']; goto k29v5; xMo17: RQgbd: goto LpBMP; k29v5: if (!($_W['container'] != 'wechat')) { goto Z_pyr; } goto w3b1t; w3b1t: if ($config['all_net']) { goto RQgbd; } goto R8Z3R; LpBMP: Z_pyr: goto OKvGm; R8Z3R: exit; goto xMo17; OKvGm: } protected function get_base() { goto Hb2iE; Hb2iE: global $_W, $_GPC; goto HFqP3; aTsge: return $res; goto FAwFM; HFqP3: $res = pdo_fetch('SELECT * FROM ' . tablename('bc_community_base') . ' WHERE weid=:uniacid', array(":uniacid" => $_W['uniacid'])); goto aTsge; FAwFM: } protected function get_mid() { goto gpVgu; RGVVL: NdZq1: goto gdliZ; J6RlP: mc_oauth_userinfo(); goto VmRJT; MAcyL: $member = $_W['fans']; goto GPW0I; sEF7l: if (!$result) { goto NdZq1; } goto cpWaJ; GPW0I: $user = pdo_fetch('SELECT * FROM ' . tablename('bc_community_member') . ' WHERE weid=:uniacid AND openid=:id', array(":uniacid" => $_W['uniacid'], ":id" => $member['openid'])); goto GKuQQ; gdliZ: cP7DU: goto S5py6; g7veR: goto cP7DU; goto gxZTu; cXtm0: $result = pdo_insert('bc_community_member', $data); goto sEF7l; jG7tR: trx8U: goto RGVVL; TyRYt: $data = array("nickname" => $member['tag']['nickname'], "avatar" => $member['avatar']); goto Dsqjn; cpWaJ: $userinfo = pdo_fetch('SELECT * FROM ' . tablename('bc_community_member') . ' WHERE weid=:uniacid AND openid=:id', array(":uniacid" => $_W['uniacid'], ":id" => $member['openid'])); goto LdNsd; LdNsd: if (empty($userinfo)) { goto trx8U; } goto LdDKt; LdDKt: $mid = $userinfo['mid']; goto jG7tR; Dsqjn: $result = pdo_update('nx_zhvillage_member', $data, array("mid" => $user['mid'])); goto dFmir; VmRJT: $mid = 0; goto MAcyL; GKuQQ: if (empty($user)) { goto TQSzp; } goto TyRYt; gxZTu: TQSzp: goto bvGlj; S5py6: return $mid; goto vXUAu; dFmir: $mid = $user['mid']; goto g7veR; bvGlj: $data = array("weid" => $_W['uniacid'], "openid" => $member['openid'], "idcard" => 0, "grade" => 0, "userip" => $_W['clientip'], "gag" => 0, "blacklist" => 0, "nickname" => $member['tag']['nickname'], "realname" => $member['tag']['nickname'], "tel" => "", "address" => "", "coid" => 0, "dong" => 0, "danyuan" => 0, "menpai" => 0, "avatar" => $member['avatar'], "integral" => "", "country" => $member['tag']['country'], "province" => $member['tag']['province'], "city" => $member['tag']['city'], "createtime" => time()); goto cXtm0; gpVgu: global $_W, $_GPC; goto J6RlP; vXUAu: } protected function getmember() { goto RBpMa; RBpMa: global $_W, $_GPC; goto WCu2a; aYyo9: return $res; goto cI2x1; qRFrr: $res = pdo_fetch('SELECT * FROM ' . tablename('bc_community_member') . ' WHERE weid=:uniacid AND mid=:mid', array(":uniacid" => $_W['uniacid'], ":mid" => $mid)); goto aYyo9; WCu2a: $mid = $this->get_mid(); goto qRFrr; cI2x1: } protected function getseller() { goto hvZvC; vJj7s: $mid = $this->get_mid(); goto AVZSD; hvZvC: global $_W, $_GPC; goto vJj7s; AVZSD: $res = pdo_fetch('SELECT * FROM ' . tablename('bc_community_mall_seller') . ' WHERE weid=:uniacid AND mid=:mid', array(":uniacid" => $_W['uniacid'], ":mid" => $mid)); goto AJMV7; AJMV7: return $res; goto WfXiJ; WfXiJ: } public function payResult($params) { goto kuFB3; eLCzm: if ($params['result'] == 'success') { goto Szp1H; } goto zZmiK; VwwnF: $goods = pdo_fetch('SELECT * FROM ' . tablename('bc_community_mall_goods') . ' WHERE id=:id', array(":id" => $cz['pid'])); goto fh0rB; fh0rB: if (!$goods) { goto TC1Yd; } goto WY4Oc; xJocr: $newdata = array("postatus" => 1, "potime1" => time()); goto PiFCJ; uda_U: $o = strstr($params['tid'], '_', TRUE); goto QNBZZ; DB35X: $tid = $params['tid']; goto rIW74; EWtQM: if (!($params['result'] == 'success' && $params['from'] == 'notify')) { goto GcxrK; } goto DB35X; o05_H: $res1 = pdo_insert('bc_community_mall_wallet', $data1); goto u2OKY; RWu1w: TC1Yd: goto ZjxQV; u2OKY: $data = array("weid" => $_W['uniacid'], "mid" => $cz['mid'], "usertype" => 2, "townid" => $cz['danyuan'], "villageid" => $cz['menpai'], "type" => 1, "title" => "新订单已付款了", "content" => '你的商品 ' . $cz['ptitle'] . ' 又卖出' . $cz['pnum'] . '件了,共收入了 ' . $cz['orderprice'] . '元。请尽快发货哦', "status" => 0, "ctime" => time()); goto MRC6C; dRFcv: $cz = pdo_fetch('SELECT a.*,b.ptitle FROM ' . tablename('bc_community_mall_orders') . ' as a left join ' . tablename('bc_community_mall_goods') . ' as b on a.pid=b.id WHERE a.weid=:uniacid AND a.id=:id', array(":uniacid" => $_W['uniacid'], ":id" => $oid)); goto eKvY7; GHXyi: if (!($params['from'] == 'return')) { goto knj1y; } goto eLCzm; vM7ut: goto PwpYg; goto vr095; c_2Ba: message('支付成功', $this->createMobileUrl('mall_myorders', array()), 'success'); goto khdvL; Kd2MN: knj1y: goto ysBZs; QNBZZ: $oid = intval($o); goto xJocr; PiFCJ: $result = pdo_update('bc_community_mall_orders', $newdata, array("id" => $oid)); goto dRFcv; MRC6C: $res = pdo_insert('bc_community_mall_messages', $data); goto VwwnF; cio5i: $data1 = array("weid" => $_W['uniacid'], "mid" => $cz['mid'], "amount" => $cz['orderprice'], "type" => 1, "status" => 1, "remark" => "", "ctime" => time(), "etime" => 0, "danyuan" => $cz['danyuan'], "menpai" => $cz['menpai']); goto o05_H; WY4Oc: $newnum = $goods['pyqty'] + $cz['pnum']; goto niuL7; ZjxQV: TZRI8: goto aF_UG; vr095: Szp1H: goto c_2Ba; aF_UG: GcxrK: goto GHXyi; eKvY7: if (!$cz) { goto TZRI8; } goto cio5i; niuL7: $data2 = array("pyqty" => $newnum); goto Twtap; rIW74: $tid = $params['tid']; goto uda_U; zZmiK: message('支付失败', $this->createMobileUrl('mall_myorders', array()), 'error'); goto vM7ut; Twtap: $res2 = pdo_update('bc_community_mall_goods', $data2, array("id" => $cz['pid'])); goto RWu1w; kuFB3: global $_W, $_GPC; goto EWtQM; khdvL: PwpYg: goto Kd2MN; ysBZs: } } ?>