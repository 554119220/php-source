<?php
 class WeixinPay { protected $appid; protected $mch_id; protected $key; protected $openid; protected $out_trade_no; protected $body; protected $total_fee; protected $attach; protected $notify_url; function __construct($appid, $openid, $mch_id, $key, $out_trade_no, $body, $total_fee, $attach = 0, $notify_url = "\150\x74\164\160\72\x2f\57\x77\167\x77\56\x77\145\x69\170\x69\x6e\x2e\161\x71\x2e\143\x6f\155\57\x77\170\160\141\x79\x2f\160\x61\x79\56\160\x68\160") { goto ithyQ; HcPIN: $this->openid = $openid; goto kpkM9; ihr1i: $this->notify_url = $notify_url; goto NZhtU; Z_u3C: $this->attach = $attach; goto ihr1i; U6jde: $this->key = $key; goto xZCyx; g5MOV: $this->total_fee = $total_fee; goto Z_u3C; ithyQ: $this->appid = $appid; goto HcPIN; nNHph: $this->body = $body; goto g5MOV; kpkM9: $this->mch_id = $mch_id; goto U6jde; xZCyx: $this->out_trade_no = $out_trade_no; goto nNHph; NZhtU: } public function pay() { $return = $this->weixinapp(); return $return; } private function unifiedorder() { goto DWH_6; D8kTN: return $return; goto ydWZI; DWH_6: $url = "\150\164\x74\160\163\x3a\57\57\141\160\x69\56\155\143\150\56\x77\145\151\x78\151\156\56\x71\161\x2e\x63\157\155\57\x70\x61\171\x2f\165\156\x69\146\151\x65\x64\x6f\x72\144\145\x72"; goto fuItf; C9YcI: $parameters["\x73\151\x67\x6e"] = $this->getSign($parameters); goto jvp5m; jvp5m: $xmlData = $this->arrayToXml($parameters); goto yfFg7; fuItf: $parameters = array("\x61\160\160\x69\x64" => $this->appid, "\x6d\x63\x68\137\151\x64" => $this->mch_id, "\x6e\x6f\x6e\143\x65\x5f\163\x74\x72" => $this->createNoncestr(), "\x62\157\144\171" => $this->body, "\141\164\x74\141\143\x68" => $this->attach, "\x6f\165\x74\137\x74\x72\x61\144\x65\137\156\157" => $this->out_trade_no, "\x74\x6f\x74\x61\x6c\x5f\146\x65\x65" => $this->total_fee, "\x73\160\x62\x69\154\154\137\143\162\x65\141\164\x65\137\x69\160" => $_SERVER["\x52\105\x4d\x4f\x54\x45\x5f\x41\x44\x44\122"], "\156\157\164\x69\146\x79\x5f\165\162\154" => $this->notify_url, "\x6f\x70\x65\156\x69\x64" => $this->openid, "\164\x72\141\x64\145\137\x74\x79\160\x65" => "\x4a\123\x41\120\111"); goto C9YcI; yfFg7: $return = $this->xmlToArray($this->postXmlCurl($xmlData, $url, 60)); goto D8kTN; ydWZI: } private static function postXmlCurl($xml, $url, $second = 30) { goto Zgb48; JvFNN: curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE); goto paDSn; Z_G2k: curl_close($ch); goto gbtmu; cbSyZ: curl_setopt($ch, CURLOPT_POSTFIELDS, $xml); goto J4YOu; EXyLN: if ($data) { goto lP3Or; } goto pQ0G7; K9NyZ: return $data; goto u8bcx; Vkp1k: goto W0i0a; goto gxxOr; vfDPI: curl_setopt($ch, CURLOPT_HEADER, FALSE); goto JvFNN; ZJZs8: curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE); goto vfDPI; PllX1: $data = curl_exec($ch); goto EXyLN; gbtmu: throw new WxPayException("\x63\x75\162\x6c\xe5\x87\272\351\224\231\xef\xbc\214\351\x94\x99\xe8\xaf\xaf\xe7\240\x81\x3a{$error}"); goto Vkp1k; vHTOF: curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE); goto ZJZs8; J4YOu: curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 20); goto L8gqS; u8bcx: W0i0a: goto J68MX; L8gqS: curl_setopt($ch, CURLOPT_TIMEOUT, 40); goto zmtDS; paDSn: curl_setopt($ch, CURLOPT_POST, TRUE); goto cbSyZ; c0WSp: curl_setopt($ch, CURLOPT_TIMEOUT, $second); goto KGRhJ; pQ0G7: $error = curl_errno($ch); goto Z_G2k; zmtDS: set_time_limit(0); goto PllX1; Zgb48: $ch = curl_init(); goto c0WSp; gxxOr: lP3Or: goto FU6PW; KGRhJ: curl_setopt($ch, CURLOPT_URL, $url); goto vHTOF; FU6PW: curl_close($ch); goto K9NyZ; J68MX: } private function arrayToXml($arr) { goto WbY8P; xyL18: foreach ($arr as $key => $val) { goto i16ah; i16ah: if (is_array($val)) { goto k7ZpL; } goto PVU1x; FWrOW: goto KQH5J; goto AgUug; ZjBE7: KQH5J: goto JGlo9; TA3y8: $xml .= "\x3c" . $key . "\x3e" . arrayToXml($val) . "\x3c\57" . $key . "\x3e"; goto ZjBE7; PVU1x: $xml .= "\74" . $key . "\x3e" . $val . "\74\57" . $key . "\76"; goto FWrOW; JGlo9: P7G8H: goto dT2sz; AgUug: k7ZpL: goto TA3y8; dT2sz: } goto mzMVM; WbY8P: $xml = "\x3c\x72\157\x6f\x74\76"; goto xyL18; ZPaDU: return $xml; goto zSFVn; mzMVM: E_FK8: goto Q8DYH; Q8DYH: $xml .= "\74\x2f\x72\x6f\x6f\164\x3e"; goto ZPaDU; zSFVn: } private function xmlToArray($xml) { goto ne7zL; ne7zL: libxml_disable_entity_loader(true); goto xkz0s; UF5kr: $val = json_decode(json_encode($xmlstring), true); goto oEc84; oEc84: return $val; goto EnpVO; xkz0s: $xmlstring = simplexml_load_string($xml, "\123\151\x6d\160\x6c\145\x58\115\114\105\154\x65\x6d\145\156\x74", LIBXML_NOCDATA); goto UF5kr; EnpVO: } private function weixinapp() { goto M0xY5; M0xY5: $unifiedorder = $this->unifiedorder(); goto FbJ7H; W3Hxs: $parameters["\x70\141\171\123\151\x67\x6e"] = $this->getSign($parameters); goto rmv1B; rmv1B: $parameters["\160\162\145\160\141\x79\137\x69\x64"] = $unifiedorder["\160\162\x65\160\x61\x79\x5f\151\144"]; goto rVWkV; rVWkV: return $parameters; goto Tyjqi; FbJ7H: $parameters = array("\x61\x70\160\x49\144" => $this->appid, "\x74\x69\x6d\x65\123\164\141\x6d\x70" => '' . time() . '', "\x6e\157\156\x63\145\x53\164\x72" => $this->createNoncestr(), "\160\x61\x63\x6b\141\147\145" => "\x70\162\145\x70\141\171\x5f\x69\144\75" . $unifiedorder["\160\162\x65\x70\141\171\137\x69\x64"], "\163\151\147\x6e\124\x79\x70\145" => "\115\104\65"); goto W3Hxs; Tyjqi: } private function createNoncestr($length = 32) { goto BhWax; VeNEr: $str = ''; goto xHjz1; LPp9q: OhMT4: goto TsCi0; xHjz1: $i = 0; goto BUFix; MXS_f: if (!($i < $length)) { goto pmIAu; } goto ENUsF; xNvvb: return $str; goto D0_2d; BhWax: $chars = "\141\142\143\x64\x65\x66\x67\150\x69\152\153\x6c\155\156\157\x70\x71\162\x73\x74\165\x76\167\x78\171\172\x30\x31\62\x33\64\x35\66\67\x38\71"; goto VeNEr; BUFix: C4NAN: goto MXS_f; qntAw: goto C4NAN; goto R1Kuz; ENUsF: $str .= substr($chars, mt_rand(0, strlen($chars) - 1), 1); goto LPp9q; R1Kuz: pmIAu: goto xNvvb; TsCi0: $i++; goto qntAw; D0_2d: } private function getSign($Obj) { goto i3cwB; GmuNk: $result_ = strtoupper($String); goto Hk21N; oHG57: ksort($Parameters); goto bWMK6; i3cwB: foreach ($Obj as $k => $v) { $Parameters[$k] = $v; VanzI: } goto kcrCx; Hk21N: return $result_; goto hPtel; kcrCx: Y0iZL: goto oHG57; bWMK6: $String = $this->formatBizQueryParaMap($Parameters, false); goto V_Hwn; kOYGN: $String = md5($String); goto GmuNk; V_Hwn: $String = $String . "\46\x6b\145\171\x3d" . $this->key; goto kOYGN; hPtel: } private function formatBizQueryParaMap($paraMap, $urlencode) { goto GPUXK; SBxgO: ksort($paraMap); goto GDHA1; DIu_P: if (!(strlen($buff) > 0)) { goto vKfW8; } goto iCI3K; iCI3K: $reqPar = substr($buff, 0, strlen($buff) - 1); goto ZOxMs; ZOxMs: vKfW8: goto Ly99_; GPUXK: $buff = ''; goto SBxgO; GDHA1: foreach ($paraMap as $k => $v) { goto W05cQ; eAqR3: $buff .= $k . "\75" . $v . "\x26"; goto Uas1t; Uas1t: Iuwpx: goto Az4bO; jMjfe: dvt9n: goto eAqR3; QsHg_: $v = urlencode($v); goto jMjfe; W05cQ: if (!$urlencode) { goto dvt9n; } goto QsHg_; Az4bO: } goto xKxvo; Ly99_: return $reqPar; goto OmUIJ; xKxvo: wG5t2: goto cPBnX; cPBnX: $reqPar; goto DIu_P; OmUIJ: } }