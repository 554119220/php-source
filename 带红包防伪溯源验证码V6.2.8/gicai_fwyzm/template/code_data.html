{template 'common/header'}
<div class="main">
	<style>
	.right-content{padding-top:0px !important;}
    .we7-form .form-group, form .form-group{margin-bottom:10px !important;}
	.right-content .nav.nav-tabs{margin-bottom:20px !important;}
	.text-center i{ line-height:40px; font-style:normal;}
	.nav-tabs li a{ cursor:pointer !important;}
	.nav-tabs{margin-bottom:20px;}
    </style>
	<ul class="nav nav-tabs" role="tablist">
		<li role="presentation"><a href="{php echo $this->createWebUrl('mlist');}&version_id=0" aria-controls="home" role="tab">返回列表</a></li>
        <li role="presentation" ><a href="{php echo $this->createWebUrl('mcode', array('mo'=>'list','fid'=>$_GPC['fid']));}" aria-controls="home" role="tab">项目列表</a></li>
        <li role="presentation" class="active"><a href="#" aria-controls="home" role="tab">数据列表</a></li> 
      	<li role="presentation"  class="dbxz" style=" {if !$filenass=='no'}display:none;{/if}"><a style=" background:#09F color:#FFF;" target="_blank" id="dbzip" href="JavaScript:;">打包下载</a></li>
        <li role="presentation"  class="sctp" style=" {if !$filenames=='no'}display:none;{/if}"><a style=" background:#09F color:#FFF;" target="_blank" id="sczip" href="JavaScript:;">生成图片</a></li>
         
        <li role="presentation" ><a style=" color:#C00;" onclick="DelIt('您确认要清空当前所有的防伪码？此操作不可逆！','{php echo $this->createWebUrl('AllDelete', array('mobs'=>'gicai_fwyzm_code_data','id'=>$_GPC['id'],'fid'=>$_GPC['fid']),true);}','{php echo $this->createWebUrl('mcode', array('mo'=>'code','id'=>$_GPC['id'],'fid'=>$_GPC['fid']),true);}');">清空所有防伪码</a></li>
        <li role="presentation" ><a style=" color:#C00;" onclick="DelIt('您确认要清空当前已验证过的防伪码？此操作不可逆！','{php echo $this->createWebUrl('AllDelete', array('mobs'=>'gicai_fwyzm_code_data','id'=>$_GPC['id'],'fid'=>$_GPC['fid'],'state'=>'0'),true);}','{php echo $this->createWebUrl('mcode', array('mo'=>'code','id'=>$_GPC['id'],'fid'=>$_GPC['fid']),true);}');">清空已验防伪码</a></li>
    </ul>
	
    <div class="panel panel-info">
		<div class="panel-heading">筛选</div>
		<div class="panel-body">
			<form action="./index.php" method="get" class="form-horizontal" role="form">
             
            
            
			<input type="hidden" name="c" value="site">
			<input type="hidden" name="a" value="entry">
			<input type="hidden" name="do" value="mcode">
			<input type="hidden" name="fid" value="{$_GPC['fid']}">
            <input type="hidden" name="mo" value="code">
            <input type="hidden" name="id" value="{$_GPC['id']}">
            <input type="hidden" name="m" value="gicai_fwyzm">
			<input type="hidden" name="searchtype" value="{$_GPC['searchtype']}">
				<div class="form-group">
					<label class="col-xs-12 col-sm-3 col-md-2 control-label">规则类型</label>
					<div class="col-sm-8 col-lg-9 col-xs-12">
						<div class="btn-group">
							<a href="{php echo filter_url('searchtype:');}"  class="btn {if $_GPC['searchtype'] == ''}btn-primary{else}btn-default{/if}">不限</a>
							<a href="{php echo filter_url('searchtype:0');}"  class="btn {if $_GPC['searchtype']== '0'}btn-primary{else}btn-default{/if}">已验证</a>
							<a href="{php echo filter_url('searchtype:1');}"  class="btn {if $_GPC['searchtype'] == '1'}btn-primary{else}btn-default{/if}">未验证</a>
						</div>
					</div>
				</div>
				<div class="form-group">
					<label class="col-xs-12 col-sm-3 col-md-2 control-label">防伪码</label>
					<div class="col-sm-6 col-lg-8 col-xs-12" >
						<input type="text" name="keyword" class="form-control" value="{$_GPC['keyword']}" placeholder="请输入防伪码">
					</div>
					<button class="btn btn-default"> 搜索</button> 
				</div>
				<div style="color: red !important;">&#22823;&#37327;&#28304;&#30721;&#65292;&#25345;&#32493;&#26356;&#26032;&#65306;&#119;&#119;&#119;&#46;&#108;&#97;&#110;&#114;&#101;&#110;&#122;&#104;&#105;&#106;&#105;&#97;&#46;&#99;&#111;&#109;</div>
				<div class="form-group">
					<label class="col-xs-12 col-sm-3 col-md-2 control-label">统计</label>
					<div class="col-sm-6 col-xs-12 col-lg-8 col-xs-12">
						<span style=" line-height:35px;">生成总数：{$total}个</span>
						 
					</div>
					 
				</div>
			</form>
            
			 

		</div>
	</div>
	
	<div class="panel panel-info">
		<div class="panel-heading">导入/导出</div>
		<div class="panel-body">
			 
            
			<form method="post" action="{php echo $this->createWebUrl('mcode', array('mo'=>'drxls','id'=>$_GPC['id'],'fid'=>$_GPC['fid']));}" enctype="multipart/form-data">
				<span style="line-height:35px; float:left;padding-right:10px;">　　上传必须是xls、xlsx格式，导入的文件内容格式演示案例：<a href="../addons/gicai_fwyzm/public/demo/code.xls" target="_blank" style="color:#390;">[点击下载]</a></span>
				<input  type="file" name="inputExcel" style="width:75px; float:left;height:40px; line-height:35px; display:block;" /><input type="submit"  style="float:left;margin-left:10px;" value="导入" class="btn btn-primary alerts" />
			</form>
			<a class="btn btn-primary alerts" style=" background:#090;margin-left:10px; color:#FFF;" href="{php echo $this->createWebUrl('phpexcel', array('mo'=>'export_submit','id'=>$_GPC['id'],'fid'=>$_GPC['fid'],'zs'=>$total,'minurl'=>$_GPC['minurl']),true);}">导出CSV</a>
						 
		</div>
	</div>
    <div class="category">
		<div class="panel panel-default">
			 
            <style>
			.row{padding-top:20px;padding-left:20px;padding-right:20px;}
            .thumbnail{ text-align:center;}
            </style>
            
            <div class="row" id="printContent">
            	{loop $account $key $item}
            	<div class="col-xs-2 col-md-2">
					{if $item['minurl']!='0'}
                	<a href="JavaScript:util.message('短连接：{$item['minurl']}','','info');" class="thumbnail">
					{else}
					<a href="JavaScript:;" class="thumbnail">
					{/if}
                      <img src="{php echo mobileurls($this->createmobileUrl('qr',array('url'=>mobileurls($this->createmobileUrl('index',array('fid'=>$item['fid'],'codekey'=>$item['code'])),'app'))),'app');}" alt="...">
                     	{$item['code']}
						 
                    </a>
                </div>
                {/loop}
                 
                
            
            </div>
            
            <div class="divline"></div>
            <div style="text-align:center;padding-bottom:15px;">{$pager}</div>
		</div>
	</div>
</div>
<style>
.modal-footer{ display:none;}
</style>
<script type="text/javascript">
$(document).ready(function(){
	//打印代码
 
	$("#sczip").click(function(){
		ajaxzip(1);
	});
	
	$("#dbzip").click(function(){
		util.message('打包也会需要些时间，请耐心等待！。打包成功后会自动弹出下载链接。<br>如果有FTP最好登陆FTP进行下载目录：addons/gicai_fwyzm/public/data_{$_GPC['fid']}/temp_{$_GPC['id']}.zip',"", 'ajax');
		$.ajax({ 
			url : "{php echo mobileurls($this->createmobileUrl('developers',array('cid'=>$_GPC['id'],'fid'=>$_GPC['fid'],'authkey'=>$_W['config']['setting']['authkey'],'dirs'=>'addons/gicai_fwyzm/public/data_'.$_GPC['fid'].'/temp_'.$_GPC['id'].'/','mo'=>'z')),'app');}", 
			data:"", 
			cache : false, 
			async : true, 
			type : "POST",
			success : function (v){
				resobj = JSON.parse(v);
				if(resobj.result=='10000'){
					window.location.href=resobj.data;
				}else{
					alert('打包失败，文件过大无法打包！建议在10万数据以内。');
				}
				 
			}
		});
		
	});
 
});

function ajaxzip(page){
	if(page==''){var page=1;};
	util.message('不要关闭浏览器，正在生成图片，当前第'+page+'页',"", 'ajax');
	var resobj;
	$.ajax({ 
		url : "{php echo $this->createWebUrl('echoqr',array('cid'=>$_GPC['id'],'fid'=>$_GPC['fid']));}", 
		data:"&page="+page, 
		cache : false, 
		async : true, 
		type : "POST",
		success : function (v){
			resobj = JSON.parse(v);
			if(resobj.dtotal>=resobj.total){
				$(".sctp").hide();
				$(".dbxz").show();
				util.message('生成完毕，点击确定打包ZIP。',"", 'ajax');
				$(".modal-footer").show();
			}else{
				ajaxzip(page+1);
			}
			 
		}
	});
	return '1';	
	
}
function DelIt(Cstr,Urls,Gourl){
	if(confirm(Cstr)){
		$.get(Urls,
			function(data){
				util.message(data,Gourl,'info');
				return true;
			}
		);
	}
	return;
}
</script>


{template 'common/footer'}