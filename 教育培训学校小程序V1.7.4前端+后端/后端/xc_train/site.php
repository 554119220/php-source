<?php
 goto AIkIK; yjwaP: global $xcmodule; goto TR_Nr; zon4q: include_once IA_ROOT . '/addons/xc_train/common/function.php'; goto qnH2c; TR_Nr: $xcmodule = 'xc_train'; goto zon4q; AIkIK: defined('IN_IA') or exit('Access Denied'); goto yjwaP; qnH2c: class Xc_trainModuleSite extends WeModuleSite { protected function createWebUrl($do, $query = array()) { goto ElbkX; UCA5l: $query['do'] = $do; goto gbm31; M0KzZ: return wurl('site/entry', $query); goto KZWzH; ElbkX: global $_GPC; goto UCA5l; gbm31: $query['m'] = strtolower($this->modulename); goto iAdQ9; iAdQ9: $query['version_id'] = intval($_GPC['version_id']); goto M0KzZ; KZWzH: } public function doWebExport() { goto RpLrP; AadMm: GoD3h: goto Kjda6; eSdq4: $data = '<tr>'; goto lN2zi; KQg7L: if (empty($_GPC['mobile'])) { goto DQ6rx; } goto mb2pz; TSO9Z: foreach ($order as $v) { goto iKqJ1; iKqJ1: if ($v['use'] == 1) { goto Khz8F; } goto PbZbF; qa7Wx: gNXDI: goto NWJq6; c77x2: VNCWs: goto VeQiL; VeQiL: $v['store_name'] = $store_list[$v['store']]['name']; goto Fsp37; UgIzQ: Khz8F: goto ZBUCo; d9d7g: $data = $data . '</tr>'; goto qa7Wx; Fsp37: $data = $data . '<tr>'; goto Kld4o; jtoYQ: LiVqX: goto d9d7g; PbZbF: $v['status_name'] = '未使用'; goto qXI7I; qXI7I: goto VNCWs; goto UgIzQ; Kld4o: foreach ($xc as $x) { goto K7S0G; TQ6aQ: if ($x['key'] == 'sign') { goto U3qKQ; } goto iMk6H; NGaOU: dRGO6: goto mSaXO; qhYQe: ZVo7c: goto HwZpB; HwZpB: $data .= '</td>'; goto OGyGf; OGyGf: NTTfW: goto TIekK; TIekK: RR7d6: goto NGaOU; Ltw7B: if (!(is_array($v['sign']) && !empty($v['sign']))) { goto edSbS; } goto kTHgY; kTHgY: foreach ($v['sign'] as $vs) { $data .= $vs['name'] . '：' . $vs['value'] . '<br/>'; w5qt5: } goto kpHjh; XapUe: goto NTTfW; goto ks9X2; vKeg0: edSbS: goto qhYQe; N3Fsb: $v['sign'] = json_decode($v['sign'], true); goto Ltw7B; ks9X2: U3qKQ: goto vkNo2; kpHjh: wV1Q1: goto vKeg0; K7S0G: if (!($x['status'] == 1)) { goto RR7d6; } goto TQ6aQ; vkNo2: $data .= '<td>'; goto dlDbV; dlDbV: if (empty($v['sign'])) { goto ZVo7c; } goto N3Fsb; iMk6H: $data .= '<td style=\'vnd.ms-excel.numberformat:@\'>' . $v[$x['key']] . '</td>'; goto XapUe; mSaXO: } goto jtoYQ; ZBUCo: $v['status_name'] = '已使用'; goto c77x2; NWJq6: } goto rRtq9; TXCec: $condition = array(); goto B2hek; mb2pz: $condition['mobile LIKE'] = '%' . $_GPC['mobile'] . '%'; goto eCe54; jDMKR: $data = '<table border=\'1\'>' . $data . '</table>'; goto cVqYd; xSDMN: if (!$store) { goto GoD3h; } goto npORO; UDbD2: $data .= '</tr>'; goto TSO9Z; CtD5s: $condition['uniacid'] = $_W['uniacid']; goto nbIbr; lN2zi: $xc = htmlspecialchars_decode($_GPC['xc']); goto IpFRr; GQaQI: vXazF: goto KQg7L; ol1gw: foreach ($xc as $x) { goto j6Z8J; j6Z8J: if (!($x['status'] == 1)) { goto YWL9M; } goto a5DZv; a5DZv: $data .= '<th>' . $x['name'] . '</th>'; goto PDX5l; PDX5l: YWL9M: goto VHuUp; VHuUp: YF8oA: goto m4LXI; m4LXI: } goto N0SyY; eCe54: DQ6rx: goto s_rAe; X9YO4: $store_list = array(); goto xSDMN; GhMhn: header('Content-Disposition: attachment; filename=order.xls'); goto eSdq4; rRtq9: vNAHd: goto jDMKR; JkNOH: tMpzO: goto AadMm; bimnB: $condition['use'] = $_GPC['use']; goto fzw69; GMww0: $store = pdo_getall('xc_train_school', array("uniacid" => $uniacid)); goto X9YO4; kdNyd: XLLRo: goto heSRw; nbIbr: if (empty($_GPC['out_trade_no'])) { goto WZEnx; } goto gJas8; s_rAe: if (empty($_GPC['use'])) { goto lSmnX; } goto bimnB; xiN7u: $uniacid = $_W['uniacid']; goto TXCec; GMObG: $condition['order_type IN'] = array(1, 2); goto CtD5s; Cgxyq: $order = pdo_getall('xc_train_order', $condition, array(), '', 'id DESC'); goto GMww0; fzw69: lSmnX: goto Cgxyq; ejKRk: $condition['openid LIKE'] = '%' . $_GPC['openid'] . '%'; goto GQaQI; DOpTL: header('Content-type: application/vnd.ms-excel; charset=utf8'); goto GhMhn; oF4ob: if (empty($_GPC['openid'])) { goto vXazF; } goto ejKRk; N0SyY: ndyF7: goto UDbD2; gJas8: $condition['out_trade_no LIKE'] = '%' . $_GPC['out_trade_no'] . '%'; goto fEYEI; oszEV: exit; goto kdNyd; npORO: foreach ($store as $s) { $store_list[$s['id']] = $s; KHyjw: } goto JkNOH; IpFRr: $xc = json_decode($xc, true); goto ol1gw; Kjda6: if (!$order) { goto XLLRo; } goto DOpTL; cVqYd: echo iconv('UTF-8', 'GBK//TRANSLIT', $data); goto oszEV; fEYEI: WZEnx: goto oF4ob; B2hek: $condition['status'] = 1; goto GMObG; RpLrP: global $_GPC, $_W; goto xiN7u; heSRw: } public function doWebPost() { goto s_Fgd; mxO91: $post = $sms['content']['post']; goto RX6Mi; LnSZ1: $post = str_replace('{{datex}}', date('Y-m-d H:i'), $post); goto nmqNe; oRoNF: $get = str_replace('{{trade}}', '1220171127101100000017', $get); goto bGWy3; UYKmc: o3rV7: goto mBZhE; AK96n: $post = str_replace('{{phonex}}', '18888888888', $post); goto O2L9j; A0Gjw: $url = $_GPC['url']; goto EiWtq; Abjoh: ubggn: goto BkPrC; PZ7Vh: GDuYB: goto QLOCS; IomnO: $post = str_replace('{{webnamex}}', '美容', $post); goto R56ut; bE656: $url = $url . $url_data; goto dB52O; SFD0K: lsqTm: goto bE656; HRlhW: $request_get = ihttp_get($url); goto uBLth; J2MRV: if (!is_array($customize)) { goto o3rV7; } goto f04i1; wy_We: $url = $url . '?' . $url_data; goto nWeLC; uBLth: echo $request_get['content']; goto i1Hu5; RtyjP: $get = str_replace('{{phonex}}', '18888888888', $get); goto E2acE; qyBBA: $get = json_encode($get); goto J2MRV; s_Fgd: global $_GPC, $_W; goto p9PI6; ZAvZw: $data = array(); goto Wt7EY; AvKDf: $get = json_decode($get, true); goto ePr52; bGWy3: $get = str_replace('{{amount}}', '199元', $get); goto JVCO3; Wt7EY: foreach ($post as $x2) { $data[$x2['attr']] = $x2['value']; sdy40: } goto ak5ts; pPU8H: $sms['content'] = json_decode($sms['content'], true); goto VM8kF; ysc2X: foreach ($get as $x3) { goto CJG78; k0sss: s8QdO: goto jVd0y; CJG78: if (empty($url_data)) { goto s8QdO; } goto yEtdX; iIRKV: PU5bD: goto Jfj_8; Jfj_8: A3sUs: goto pg_ny; jVd0y: $url_data = urlencode($x3['attr']) . '=' . urlencode($x3['value']); goto iIRKV; mBZ_D: goto PU5bD; goto k0sss; yEtdX: $url_data = $url_data . '&' . urlencode($x3['attr']) . '=' . urlencode($x3['value']); goto mBZ_D; pg_ny: } goto PZ7Vh; GQozp: MZF28: goto UYKmc; EiWtq: $sms = pdo_get('xc_beauty_config', array("xkey" => "sms")); goto BnlPH; QLOCS: if (strpos($url, '?') !== false) { goto lsqTm; } goto wy_We; VM8kF: $customize = $sms['content']['customize']; goto mxO91; dB52O: G1kzE: goto HRlhW; NUuiR: Oe7kQ: goto IomnO; nWeLC: goto G1kzE; goto SFD0K; R56ut: $post = str_replace('{{trade}}', '1220171127101100000017', $post); goto t7Ari; l1zxJ: if (!(is_array($get) && !empty($get))) { goto TJirM; } goto qyBBA; i1Hu5: TJirM: goto cHKFo; Z4wVU: $post = str_replace('{{namex}}', '张三', $post); goto AK96n; t7Ari: $post = str_replace('{{amount}}', '199元', $post); goto Z4wVU; f04i1: foreach ($customize as $x) { $get = str_replace('{{' . $x['attr'] . '}}', $x['value'], $get); YaceC: } goto GQozp; WES5W: $request_post = ihttp_post($url, $data); goto Abjoh; wdF19: foreach ($customize as $x) { $post = str_replace('{{' . $x['attr'] . '}}', $x['value'], $post); Megmj: } goto TPJRT; nmqNe: $post = json_decode($post, true); goto ZAvZw; RX6Mi: if (!(is_array($post) && !empty($post))) { goto ubggn; } goto X5vL5; mBZhE: $get = str_replace('{{webnamex}}', '美容', $get); goto oRoNF; ePr52: $url_data = ''; goto ysc2X; JVCO3: $get = str_replace('{{namex}}', '张三', $get); goto RtyjP; BkPrC: $get = $sms['content']['get']; goto l1zxJ; O2L9j: $post = str_replace('{{addrx}}', '中国北京', $post); goto LnSZ1; X5vL5: $post = json_encode($post); goto cFPbs; p9PI6: load()->func('communication'); goto A0Gjw; cHKFo: MyiZI: goto qe0vj; cFPbs: if (!is_array($customize)) { goto Oe7kQ; } goto wdF19; E2acE: $get = str_replace('{{addrx}}', '中国北京', $get); goto lCQ01; ak5ts: tr3NI: goto WES5W; lCQ01: $get = str_replace('{{datex}}', date('Y-m-d H:i'), $get); goto AvKDf; TPJRT: qJQsZ: goto NUuiR; BnlPH: if (!$sms) { goto MyiZI; } goto pPU8H; qe0vj: } public function doWebOrderRefund() { goto v1j2P; E3gZz: if (!(floatval($order['wxpay']) != 0)) { goto gBhCT; } goto pANWb; f1jZB: $order = pdo_get('xc_beauty_order', array("id" => $_GPC['id'], "uniacid" => $uniacid)); goto g_mdC; T6lhU: pdo_update('xc_beauty_userinfo', array("score" => $score), array("status" => 1, "openid" => $order['openid'], "uniacid" => $uniacid)); goto rDO6c; YULaH: $ref = strtoupper(md5('appid=' . $appid . '&mch_id=' . $config['payment']['wechat']['mchid'] . '&nonce_str=123456' . '&out_refund_no=' . $transaction_id . '&out_trade_no=' . $transaction_id . '&refund_fee=' . $refund_fee . '&total_fee=' . $total_fee . '&key=' . $config['payment']['wechat']['signkey'])); goto wNMhT; ClF_i: curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 1); goto fHG0y; pANWb: $config = pdo_get('uni_settings', array("uniacid" => $uniacid)); goto c8RXD; UkMiW: $money = round(floatval($userinfo['money']) + floatval($order['canpay']), 2); goto hiQMK; v1j2P: global $_GPC, $_W; goto mXWl8; KhN31: if (!(($TxtRes = fopen($cert_file, 'w+')) === FALSE)) { goto E_Z94; } goto LVa0E; kL2Iq: fclose($TxtRes); goto qgSc4; fdhsR: unlink($key_file); goto CcA9F; OBJWW: goto NAate; goto VKPm5; FmdFM: if (empty($order['score'])) { goto DH2dg; } goto XBc9B; RepVM: sTiEM: goto I9ITJ; tjFFW: $userinfo = pdo_get('xc_beauty_userinfo', array("status" => 1, "openid" => $order['openid'], "uniacid" => $uniacid)); goto FmdFM; GkYv_: $request = pdo_update('xc_beauty_order', array("refund_status" => 1, "status" => 2), array("id" => $_GPC['id'], "uniacid" => $uniacid)); goto A0geC; kATRw: $xml = arrayToXml($refund); goto RooEx; HWmEw: if ($data['return_code'] == 'SUCCESS') { goto S3u57; } goto k1P6l; wNMhT: $refund = array("appid" => $appid, "mch_id" => $config['payment']['wechat']['mchid'], "nonce_str" => "123456", "out_refund_no" => $transaction_id, "out_trade_no" => $transaction_id, "refund_fee" => $refund_fee, "total_fee" => $total_fee, "sign" => $ref); goto kATRw; nAx7Q: goto QfQYw; goto RepVM; RooEx: $ch = curl_init(); goto WwMCp; AFpL6: pdo_update('xc_beauty_userinfo', array("share_o_amount" => $share_o_amount, "share_empty" => $share_empty), array("status" => 1, "openid" => $order['openid'], "uniacid" => $uniacid)); goto IYgnC; IlZmG: if (!(floatval($order['canpay']) != 0)) { goto BmXUA; } goto UkMiW; FQ4YI: fclose($TxtRes); goto ibDEr; uNxrP: GGeim: goto wyxq5; rDO6c: DH2dg: goto IlZmG; i_zqK: $data = xmlToArray($data); goto HWmEw; DKaZt: goto XCkOq; goto rMr2x; VsGvO: JHy4I: goto FQ4YI; Rx9kz: RnXTI: goto kL2Iq; tKOy8: gBhCT: goto UO_n6; hiQMK: $request = pdo_update('xc_beauty_userinfo', array("money" => $money), array("status" => 1, "openid" => $order['openid'], "uniacid" => $uniacid)); goto gY6Nv; fHG0y: curl_setopt($ch, CURLOPT_SSLCERTTYPE, 'pem'); goto FCWOI; g_mdC: if ($order) { goto Rgv4N; } goto Hf5o4; I9ITJ: $config['payment'] = unserialize($config['payment']); goto ULcVD; dBN7X: echo '创建可写文件：' . $key_file . '失败'; goto dbr8R; j37V8: E_Z94: goto pB1lu; Vvlid: S3u57: goto O8vZK; A0geC: if ($request) { goto SQlc0; } goto zTcrz; r7Hp8: $cert['content'] = json_decode($cert['content'], true); goto lo4h3; r52nO: curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); goto ClF_i; yuW0q: unlink($cert_file); goto fdhsR; GtNJO: $key_file = '../addons/' . $_GPC['m'] . '/resource/' . rand(100000, 999999) . '.pem'; goto gZWtR; nxdGW: $data = curl_exec($ch); goto yuW0q; PWkCd: curl_setopt($ch, CURLOPT_POSTFIELDS, $xml); goto nxdGW; caTRf: if (fwrite($TxtRes, $StrConents)) { goto RnXTI; } goto Dg2uq; k1P6l: goto m4FZw; goto Vvlid; kQU4B: VeWcn: goto BiOsQ; A0V_M: if (!($config && $cert)) { goto T9Xg2; } goto r7Hp8; wK3DB: goto VeWcn; goto my77P; pB1lu: $StrConents = $cert['content']['cert']; goto vLhk8; t1Vkg: $error = curl_errno($ch); goto p38xH; LVa0E: echo '创建可写文件：' . $cert_file . '失败'; goto PqZFe; MIxi5: $json = array("status" => 1, "msg" => "操作成功"); goto AYYW1; kGSox: goto VcBCd; goto qlxDM; dbr8R: exit; goto uNxrP; SoVUL: NAate: goto ikvAj; UO_n6: $share = pdo_get('xc_beauty_share', array("status" => 1, "uniacid" => $uniacid, "openid" => $order['openid'], "out_trade_no" => $order['out_trade_no'])); goto B2m45; CcA9F: if ($data) { goto FMVmb; } goto t1Vkg; K0NZJ: curl_setopt($ch, CURLOPT_SSLCERTTYPE, 'pem'); goto GtNJO; WRFHX: curl_setopt($ch, CURLOPT_HEADER, 0); goto r52nO; RxwJS: exit; goto VsGvO; lo4h3: if (!empty($cert['content']['cert']) && !empty($cert['content']['key'])) { goto sTiEM; } goto nAx7Q; aV4Mz: $share_empty = round(floatval($userinfo['share_empty']) + floatval($share['amount'])); goto AFpL6; ikvAj: m4FZw: goto HJ17f; Vg1tN: $refund_fee = floatval($order['wxpay']) * 100; goto HJCjq; T8IOD: $share_o_amount = round(floatval($userinfo['share_o_amount']) - floatval($share['amount']), 2); goto aV4Mz; gZWtR: if (!(($TxtRes = fopen($key_file, 'w+')) === FALSE)) { goto GGeim; } goto dBN7X; ejWqi: H8mv_: goto GkYv_; c8RXD: $cert = pdo_get('xc_beauty_config', array("uniacid" => $uniacid, "xkey" => "refund")); goto A0V_M; HJ17f: XCkOq: goto A3XSQ; ULcVD: $appid = $_W['account']['key']; goto vDkmd; AYYW1: echo json_encode($json); goto kQU4B; B7nX7: T9Xg2: goto tKOy8; FCWOI: $cert_file = '../addons/' . $_GPC['m'] . '/resource/' . rand(100000, 999999) . '.pem'; goto KhN31; koLag: fclose($TxtRes); goto NFhvf; A3XSQ: QfQYw: goto B7nX7; gGmtD: echo json_encode($json); goto kGSox; ibDEr: curl_setopt($ch, CURLOPT_SSLCERT, $cert_file); goto K0NZJ; HJCjq: $url = 'https://api.mch.weixin.qq.com/secapi/pay/refund'; goto YULaH; rMr2x: FMVmb: goto sP1Dc; gY6Nv: BmXUA: goto E3gZz; vLhk8: if (fwrite($TxtRes, $StrConents)) { goto JHy4I; } goto rwtIZ; VKPm5: FzHUv: goto SoVUL; zTcrz: $json = array("status" => -1, "msg" => "操作失败"); goto D7vtY; Idf0F: fclose($TxtRes); goto RxwJS; WwMCp: curl_setopt($ch, CURLOPT_URL, $url); goto WRFHX; p38xH: curl_close($ch); goto DKaZt; IYgnC: pdo_update('xc_beauty_share', array("status" => 2), array("status" => 1, "uniacid" => $uniacid, "openid" => $order['openid'], "out_trade_no" => $order['out_trade_no'])); goto ejWqi; qgSc4: curl_setopt($ch, CURLOPT_SSLKEY, $key_file); goto jursO; wyxq5: $StrConents = $cert['content']['key']; goto caTRf; O8vZK: if ($data['result_code'] == 'SUCCESS') { goto FzHUv; } goto OBJWW; BiOsQ: VcBCd: goto pgLzB; XBc9B: $score = $userinfo['score'] - $order['score']; goto T6lhU; PqZFe: exit; goto j37V8; D7vtY: echo json_encode($json); goto wK3DB; Dg2uq: echo '尝试向文件' . $key_file . '写入' . $StrConents . '失败！'; goto koLag; vDkmd: $transaction_id = $order['wx_out_trade_no']; goto X0MZG; jursO: curl_setopt($ch, CURLOPT_POST, 1); goto PWkCd; sP1Dc: curl_close($ch); goto i_zqK; NFhvf: exit; goto Rx9kz; B2m45: if (!$share) { goto H8mv_; } goto T8IOD; my77P: SQlc0: goto MIxi5; qlxDM: Rgv4N: goto tjFFW; X0MZG: $total_fee = floatval($order['wxpay']) * 100; goto Vg1tN; rwtIZ: echo '尝试向文件' . $cert_file . '写入' . $StrConents . '失败！'; goto Idf0F; Hf5o4: $json = array("status" => -1, "msg" => "操作失败"); goto gGmtD; mXWl8: $uniacid = $_W['uniacid']; goto f1jZB; pgLzB: } public function doWebUpSql() { include_once '../addons/xc_train/upsql.php'; upsql(); } } ?>