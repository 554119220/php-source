<?php/** * Created by PhpStorm. * Time: 2019年3月15日14:58:35 */class Basis{    /*     * 添加from_id     * $uid     * $from_id     * 返回值 1     */    public function add_form_id($uid, $from_id){        global  $_W;        if(empty($uid)){            return 2;        }        if(empty($from_id) || $from_id == 'the formId is a mock one'){            return 3;        }        $data = array(            'uid'=>$uid,            'form_id'=>$from_id,            'uniacid'=>$_W['uniacid'],            'create_time'=>time(),        );        pdo_insert('ox_reclaim_formid',$data);        return 1;    }    /*	 * 资金处理通用方法	 * $money 余额变动	 * $uid 处理的用户id	 * $parame->from_uid 来源用户-可不填写	 * $parame->type 类型 0接单 1完工 2提现 3提现驳回	 * $parame->from_id 来源id 订单id或提现表id	 * $parame->from_table 来源表名，不带ims_     * $parame->desc 描述     * $pdo 是否开启事物 默认开启 1或ture 关闭     *     * return->code 0失败 1成功     * return->msg 失败原因	 */    public function money_change($money, $uid, $parame, $pdo=0)    {        global $_W;        $uniacid = $_W['uniacid'];        $ret = array(            'code' => 0,        );        if(!$pdo){            pdo()->begin();        }        $user_info = pdo_get('ox_reclaim_member', array('uid' => $uid, 'uniacid' => $uniacid));        $user_date = array();        //判断余额        if (!empty($money) || !empty($parame['integral'])) {            //余额            $user_date['money'] = $user_info['money'] + $money;            if ($user_date['money'] < 0) {                $ret['msg'] = '用户金额不足';                return $ret;            }            $parame['money'] = $money;            $parame['last_money'] = $user_date['money'];            //积分            $user_date['integral'] = $user_info['integral'] + $parame['integral'];            if ($user_date['integral'] < 0) {                $ret['msg'] = '用户积分不足';                return $ret;            }            $parame['last_integral'] = $user_date['integral'];            //处理会员余额及积分            $user_up = pdo_update('ox_reclaim_member', $user_date, array('uid' => $uid, 'uniacid' => $uniacid));            if (!$user_up) {                if(!$pdo){                    pdo()->rollback();                }                $ret['msg'] = '修改用户金额失败';                return $ret;            }        } else {            $parame['money'] = 0;            $parame['last_money'] = $user_info['money'];        }        //资金记录表添加记录        $parame['uniacid'] = $uniacid;        $parame['uid'] = $uid;        $parame['create_time'] = time();        $result_log = pdo_insert('ox_reclaim_money_log', $parame);        if (empty($result_log)) {            if(!$pdo){                pdo()->rollback();            }            $ret['msg'] = '添加资金记录失败';            return $ret;        }        if(!$pdo){            pdo()->commit();        }        $ret['code'] = 1;        return $ret;    }}