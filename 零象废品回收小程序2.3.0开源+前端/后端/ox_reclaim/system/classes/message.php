<?php/** * 模板消息发送 */class Message{    public static  $instance;    public static  function Instance(){        if(!self::$instance) {            self::$instance = new self();        }        return self::$instance;    }    /**     * 发送消息模板     * @param     * array(     *  "touser" => $params['touser'],     *  "template_id" => '', 模板id     *  "page"=>  '',       跳转路径     *  "form_id"=>  '',     * "emphasis_keyword"=>  '',     *  "keyword" => array(     *       "顺丰，     *       "sdhkjhk"，     *   )     * )     * @return array AT0007     */    public function send($params){        $url = "https://api.weixin.qq.com/cgi-bin/message/wxopen/template/send?access_token=".$this->getToken();        $data = array(              "touser" => $params['touser'],              "template_id" => $params['template_id'],              "page"=>  $params['page'],              "form_id"=>  $params['form_id'],              "data"=>  array(              ),              "emphasis_keyword"=>  $params['emphasis_keyword'] ?: '',        );        if(is_array($params['keyword'])){            foreach ($params['keyword'] as $k => $v){                $data['data']['keyword'.($k+1)] = array("value" => $v);            }        }        $result = ihttp_post($url,json_encode($data));        return $result;    }    /**     * 获取token     * @return mixed     * @throws     */    private function getToken()    {        global $_W, $_GPC;        $url = 'https://api.weixin.qq.com/cgi-bin/token';        $result = cache_load("{$_W['uniacid']}_newsharing_token");        if(is_array($result) && $result['end_time'] > TIMESTAMP){            return $result['access_token'];        }        $query = [            'grant_type' => "client_credential",            'appid' => $_W['uniaccount']['key'],            'secret' => $_W['uniaccount']['secret'],        ];        $result = ihttp_request($url,$query);        $result = json_decode($result['content'],1);        if (isset($result['access_token'])) {            $access_token = $result['access_token'];            $data = [            'access_token' =>    $result['access_token'],            'end_time' => TIMESTAMP +  $result['expires_in'] - 600,            ];            cache_write("{$_W['uniacid']}_newsharing_token", $data);        }        return $access_token;    }    /**     * 统一模板消息     */    public function uniformSend($params){        global $_W;//        $params = [//            'template_id' => '3GoeFiceNrTEbwGDOGETigntWOayWg37IFpx_mtr1Bo',//            'uid' => 1,//                'type' => 1,//            'first' => '新服务订单通知',//            'keyword' => [//                '已','sdfs','sdff','dfd'//            ],//            'remark' => '快去出价抢单吧',//        ];        //获取openid        $openid = pdo_getcolumn('mc_mapping_fans',['uid' => $params['uid']],'openid');        $appid= pdo_getcolumn('ox_reclaim_info',['uniacid' => $_W['uniacid']],'appid');        $template = pdo_get('ox_reclaim_uniform_template',['uniacid' => $_W['uniacid'],'type'=>$params['type']]);        if(!$openid || !$appid){            return '';        }        $url = "https://api.weixin.qq.com/cgi-bin/message/wxopen/template/uniform_send?access_token=".$this->getToken();        $message = [            'touser' => $openid,            "mp_template_msg" => [                "appid" => $appid,                "template_id"=>$template['template_id'],                "miniprogram"=> [                    "appid"=>$_W['uniaccount']['key'],                    "pagepath"=>$params['pagepath'] ?: '',                ],                'data' => [                    'first' => [                        'value' => $template['first'],                        'color' => '',                    ],                    'remark' => [                        'value' => $template['remark'],                        'color' => '',                    ],                ],            ]        ];        if(is_array($params['keyword'])){            foreach ($params['keyword'] as $k => $v){                $message['mp_template_msg']['data']['keyword'.($k+1)] = array("value" => $v,'color' => '');            }        }        // 通知管理员        $uids = pdo_getall('ox_reclaim_member',['uniacid' => $_W['uniacid'],'jiedan' => 1],['uid']);        $uids = array_column($uids,'uid');        if($uids){            $openids = pdo_getall('mc_mapping_fans',['uid' =>$uids ],['openid']);           // $openids = array_column($openids,'openid');        }        if($openids){            foreach ($openids as $k => $v){                $message['touser'] = $v['openid'];                 ihttp_post($url,json_encode($message));            }        }        return '';    }}