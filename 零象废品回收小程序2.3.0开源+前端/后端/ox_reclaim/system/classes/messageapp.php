<?php/** * 模板消息发送 */class Messageapp{    public static  $instance;    public static  function Instance(){        if(!self::$instance) {            self::$instance = new self();        }        return self::$instance;    }    /**     * 发送消息模板     * @param     * array(     *  "touser" => $params['touser'],     *  "template_id" => '', 模板id     *  "page"=>  '',       跳转路径     *  "form_id"=>  '',     * "emphasis_keyword"=>  '',     *  "keyword" => array(     *       "顺丰，     *       "sdhkjhk"，     *   )     * )     * @return array AT0007     */    /**     * 参数说明     * uid     *mes_id    发送的模板消息表type     *page 跳转页面     *keyword   传数组值     *     */    public function send($params){        global $_W;        //获取openid        $openid = pdo_getcolumn('mc_mapping_fans',['uid' => $params['uid']],'openid');        //获取模板消息id        $template_id = pdo_getcolumn('ox_reclaim_uniform_template',["uniacid" => $_W['uniacid'],'type' => $params['mes_id']],'template_id');        if(empty($template_id)){            return 0;        }        //获取form_id        //删除大于7天前的form_id        pdo_delete('ox_reclaim_formid',array('create_time <'=>time()-604800));        $from_arr = pdo_getall('ox_reclaim_formid',['uid'=>$params['uid'],'status'=>0],'','',['create_time asc'],'1');        if(empty($from_arr)){            return 0;        }        pdo_update('ox_reclaim_formid',array('status'=>1),$from_arr[0]);        $url = "https://api.weixin.qq.com/cgi-bin/message/wxopen/template/send?access_token=".$this->getToken();        $data = array(              "touser" => $openid,              "template_id" => $template_id,              "page"=>  $params['page'],              "form_id"=>  $from_arr[0]['form_id'],              "data"=>  array(),              "emphasis_keyword"=>  $params['emphasis_keyword'] ?: '',        );        if(is_array($params['keyword'])){            foreach ($params['keyword'] as $k => $v){                $data['data']['keyword'.($k+1)] = array("value" => $v);            }        }        $result = ihttp_post($url,json_encode($data));        return $result;    }    /**     * 获取token     * @return mixed     * @throws     */    private function getToken()    {        global $_W, $_GPC;        $url = 'https://api.weixin.qq.com/cgi-bin/token';        $result = cache_load("{$_W['uniacid']}_repair_token");        if(is_array($result) && $result['end_time'] > TIMESTAMP){            return $result['access_token'];        }        $query = [            'grant_type' => "client_credential",            'appid' => $_W['uniaccount']['key'],            'secret' => $_W['uniaccount']['secret'],        ];        $result = ihttp_request($url,$query);        $result = json_decode($result['content'],1);        if (isset($result['access_token'])) {            $access_token = $result['access_token'];            $data = [            'access_token' =>    $result['access_token'],            'end_time' => TIMESTAMP +  $result['expires_in'] - 600,            ];            cache_write("{$_W['uniacid']}_repair_token", $data);        }        return $access_token;    }}