<?php/** * 积分处理 * Class Integral */class Integral {    private static $type = array(        1 => array('name'=>'签到', 'change'=>'+'),        2 => array('name'=>'消费', 'change'=>'+'),        3 => array('name'=>'兑换', 'change'=>'-')    );    /**     * 积分操作     * @param $param     *     uid     用户uid     *     number  积分数     *     type    操作类型     *     remark  备注     *     * @return bool     */    public static function add($param) {        global $_W;        // 检查是否开启积分商城模块，如果没有直接返回false        /*if (self::check_switch() == false) {            return false;        }*/        $now_time = time();        $type = self::$type[ $param['type'] ];        // 更新积分数据        $line = pdo_get('monai_newsharing_integral', array('uid'=>$param['uid'], 'uniacid'=>$_W['uniacid']), array('id', 'total_number', 'rest_number'));        if (empty($line)) {            if ($type['change'] == '-') {                return false;            }            $data = array(                'uniacid' => $_W['uniacid'],                'uid' => $param['uid'],                'total_number' => $param['number'],                'rest_number' => $param['number'],                'create_time' => $now_time,                'save_time' => $now_time            );            $res1 = pdo_insert('monai_newsharing_integral', $data);        } else {            $total_number = $line['total_number'];            $rest_number = $line['rest_number'];            if ($type['change'] == '+') {                $total_number += $param['number'];                $rest_number += $param['number'];            } else {                $rest_number -= $param['number'];                if ($rest_number < 0) {                    return false;                }            }            $data = array(                'total_number' => $total_number,                'rest_number' => $rest_number,                'save_time' => $now_time            );            $res1 = pdo_update('monai_newsharing_integral', $data, array('id'=>$line['id']));        }        // 添加积分记录        $data = array(            'uniacid' => $_W['uniacid'],            'uid' => $param['uid'],            'number' => $param['number'],            'change' => $type['change'],            'type' => $param['type'],            'remark' => $param['remark'],            'create_time' => $now_time        );        $res2 = pdo_insert('monai_newsharing_integral_log', $data);        if ($res1 && $res2) {            return true;        } else {            return false;        }    }    /**     * 检查积分商城模块是否开启     * @return bool     */    private static function check_switch() {        global $_W;        $line = pdo_get('monai_newsharing_plugin', array('type'=>3, 'uniacid'=>$_W['uniacid']), array('status'));        if ($line['status'] == 1) {            return true;        } else {            return false;        }    }}