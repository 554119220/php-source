<?phpif (!(defined('IN_IA'))){    exit('Access Denied');}class Api_Me extends WeModuleWxapp{    /*     * 会员中心     */    public function getInfo(){        global $_GPC, $_W;        $params = [            'uid' => $_GPC['uid'],        ];        if(empty($_GPC['uid'])){            return $this->result(0, '', array());        }        $result = pdo_get('ox_reclaim_member',$params);        if(empty($result)){            $data = array(                'uniacid'=>$_W['uniacid'],                'uid'=>$_GPC['uid'],                'create_time'=>time()            );            $user_info2 = pdo_get('mc_members',['uid'=>$_GPC['uid']]);            $data['nickname'] = $user_info2['nickname'];            $data['avatar'] = $user_info2['avatar'];            pdo_insert('ox_reclaim_member',$data);            $result = pdo_get('ox_reclaim_member',$params);        }        $store = pdo_get('ox_reclaim_info',array('uniacid'=>$_W['uniacid']));        $result['store_phone'] = $store['phone'];        $shop_info = pdo_get('ox_reclaim_shop_info',array('uniacid'=>$_W['uniacid']));        $result['shop_open'] = $shop_info['open'];        if(empty($shop_info)){            $result['shop_open'] = 0;        }        return $this->result(0, '', $result);    }    /**     * 个人详情     */    public function detail(){        global $_GPC, $_W;        $params = [            'uid' => $_GPC['uid'],            'uniacid'=>$_W['uniacid'],        ];        if(empty($_GPC['uid'])){            return $this->result(0, '', array());        }        $result = pdo_get('ox_reclaim_member',$params);        return $this->result(0, '', $result);    }    public function editDetail(){        global $_GPC, $_W;        $params = [            'uid' => $_GPC['uid'],            'uniacid'=>$_W['uniacid'],        ];        $result = pdo_update('ox_reclaim_member',['name' => $_GPC['name'],'phone' => $_GPC['phone']],$params);        return $this->result(0, '', $result);    }    /**     * 反馈建议     */    public function suggest(){        global $_GPC, $_W;        $params = [            'content' => $_GPC['suggest'],            'uniacid'=>$_W['uniacid'],            'create_time' => $_SERVER['REQUEST_TIME']        ];        $result = pdo_insert('ox_reclaim_suggest',$params);        return $this->result(0, '', $result);    }    /*     * 收款方式     */    public function collect(){        global $_GPC, $_W;        $params = [            'uid' => $_GPC['uid'],        ];        if(empty($_GPC['uid'])){            return $this->result(0, '', array());        }        $result = pdo_get('ox_reclaim_member',$params);        if(empty($result)){            $data = array(                'uniacid'=>$_W['uniacid'],                'uid'=>$_GPC['uid'],                'create_time'=>time()            );            $user_info2 = pdo_get('mc_members',['uid'=>$_GPC['uid']]);            $data['nickname'] = $user_info2['nickname'];            $data['avatar'] = $user_info2['avatar'];            pdo_insert('ox_reclaim_member',$data);            $result = pdo_get('ox_reclaim_member',$params);        }        return $this->result(0, '', $result);    }    /*     * 收款方式提交     */    public function collect_sub(){        global $_GPC, $_W;        $params = [            'uid' => $_GPC['uid'],        ];        if($_GPC['type']==1){            //支付宝            $data['ali_id'] = $_GPC['code'];            $data['ali_name'] = $_GPC['username'];        }else{            //微信            $data['wx_id'] = $_GPC['code'];        }        $result = pdo_update('ox_reclaim_member',$data,$params);        if($result){            return $this->result(0, '', $result);        }        else{            return $this->result(-1, '修改失败', $result);        }    }    /**     * 检测是否是黑名单会员     */    public function userblack(){        global $_GPC, $_W;        $user = pdo_get('ox_master_black',array('uniacid'=>$_W['uniacid'],'uid'=>$_GPC['uid'],'black_time >'=>time()));        if(!empty($user)){            if($user['black_time'] == 0){                $user['black_time'] ='无';            }else{                $user['black_time'] = date('Y-m-d H:i');            }            $result['user'] = $user;        }else{            $result['user'] = 0;        }        return $this->result(0, '', $result);    }    /**     * webview     */    public function webView(){        global $_W, $_GPC;        $params = [            'uniacid' => $_W['uniacid'],        ];        if($_GPC['type'] == 1){            $detail = pdo_get('ox_reclaim_info',['uniacid' => $_W['uniacid']]);            $detail['content'] = htmlspecialchars_decode($detail['about']);        }else{            $params['id'] = $_GPC['id'];            $detail = pdo_get('ox_reclaim_view',$params);            $detail['content'] = htmlspecialchars_decode($detail['content']);        }        return $this->result(0,'',$detail);    }    /*     * 添加form_id     */    public function add_formid(){        global $_GPC;        $ceshi = new Basis();        $result = $ceshi->add_form_id($_GPC['uid'],$_GPC['formid']);        return $this->result(0, '', $result);    }    /**     * 资金列表     */    public function moneyList(){        global $_GPC, $_W;        $params = [            "uniacid" => $_W['uniacid'],            "uid"=> $_GPC['uid']        ];        if($_GPC['status'] == 1){            $params['lock_money <>']=0;        }else{            $params['money <>']=0;        }        $pageSize = 10;        $pageCur = $_GPC['page'] ?: 1;        $list = pdo_getall('ox_master_money_log',$params,'','',['id desc'],[$pageCur,$pageSize]);        foreach ($list as $k => $v){            $list[$k]['create_time'] = date('Y-m-d H:i',$v['create_time']);            if($_GPC['status'] == 1){                $list[$k]['zengjian'] = $v['lock_money']>0?'+':'';                $list[$k]['money'] = $v['lock_money'];                $list[$k]['last_money'] = $v['last_lock_money'];            }else{                $list[$k]['zengjian'] = $v['money']>0?'+':'';            }        }        return $this->result(0, '', $list);    }    /**     * 提现列表     */    public function takeList(){        global $_GPC, $_W;        $params = [            "uniacid" => $_W['uniacid'],            "uid"=> $_GPC['uid']        ];        $status_arr = ['0'=>'未审核','1'=>'已通过','2'=>'已驳回'];        $pageSize = 10;        $pageCur = $_GPC['page'] ?: 1;        $list = pdo_getall('ox_master_take_log',$params,'','',['id desc'],[$pageCur,$pageSize]);        foreach ($list as $k => $v){            $list[$k]['create_time'] = date('Y-m-d H:i',$v['create_time']);            $list[$k]['status_text'] = $status_arr[$v['status']];        }        $res['list'] =  $list;        $res['userinfo'] = pdo_get('ox_master_store',["uniacid" => $_W['uniacid'], "uid"=> $_GPC['uid']]);        $base_info = pdo_get('ox_master',array("uniacid" => $_W['uniacid']));        $res['userinfo']['points'] = $base_info['points'];        $res['userinfo']['min_cash'] = $base_info['min_cash'];        return $this->result(0, '', $res);    }    /**     * 提现提交     */    public function takeAdd(){        global $_GPC, $_W;        $ceshi = new Basis();        $result = $ceshi->add_form_id($_GPC['uid'],$_GPC['formid']);        //判断账户余额是否小于当前余额        $userinfo = pdo_get('ox_reclaim_member',['uniacid'=>$_W['uniacid'],'uid'=>$_GPC['uid']]);        if($userinfo['money']<$_GPC['takemoney']){            return $this->result(200, '账户余额不足', $userinfo);        }        if($userinfo['black']>0){            return $this->result(200, '账户冻结请联系管理员', $userinfo);        }        //增加提现记录        $take_arr = [            'uniacid'=>$_W['uniacid'],            'uid'=>$_GPC['uid'],            'money'=>$_GPC['takemoney'],            'status'=>0,            'create_time'=>time(),            'type'=>$_GPC['paytype'],            'num'=>$_GPC['paytype']==1?$userinfo['ali_id']:'',            'name'=>$_GPC['paytype']==1?$userinfo['ali_name']:''        ];        $res = pdo_insert('ox_reclaim_take_log',$take_arr);        if(!$res){            return $this->result(200, '添加记录失败', $take_arr);        }        $take_id = pdo_insertid();        $money = (-1)*$_GPC['takemoney'];    //变动可用资金        $uid = $_GPC['uid'];       //用户uid        $parame = array(            'from_uid'=>$_GPC['uid'],  //来源用户-可不填写            'type'=>2, //类型 0接单 1完工 2提现 3提现驳回            'from_id'=>$take_id,   //来源id 订单id或提现表id(非小程序form_id)            'from_table'=>'ox_reclaim_take_log', //来源表名，不带ims_            'desc'=>'提现申请，扣除余额'        );        $result = $ceshi->money_change($money,$uid,$parame);        if($result['code']){            Message::Instance()->uniformSend([                'type' => 2,                'uid' => $_GPC['uid'],                'keyword' => [                    $_GPC['takemoney'],                    $userinfo['money'],                    date('Y-m-d H:i',$_SERVER['REQUEST_TIME']),                ]            ]);            return $this->result(0, '', $res);        }else{            pdo_delete('ox_reclaim_take_log',array('id'=>$take_id));            return $this->result(200, $result['msg'], $take_arr);        }    }    /**     * 小程序信息     */    public function about(){        global $_GPC, $_W;        $detail = pdo_get('ox_reclaim_info',['uniacid'=>$_W['uniacid']]);        $list = pdo_getall('ox_reclaim_view',['uniacid'=>$_W['uniacid']],['id','title'],'',['sort desc']);        if($detail){            if($detail['logo']){                $detail['logo'] = tomedia($detail['logo']);            }else{                $detail['logo'] = tomedia('/addons/ox_reclaim/icon.jpg');            }        }        $result = [            'detail' => $detail,            'list' => $list,        ];        return $this->result(0, '', $result);    }    /**     * 提现记录     */    public function takelog(){        global $_GPC, $_W;        $pageSize = 15;        $pageCur = $_GPC['page'] ? $_GPC['page'] : 0;        $list = pdo_getall('ox_reclaim_take_log',['uid'=>$_GPC['uid'],'uniacid'=>$_W['uniacid']],[],'',array('id desc'),[$pageCur,$pageSize]);        $status = ['0'=>'未审核','1'=>'已通过','2'=>'已驳回'];        foreach ($list as $k=>$v){            $list[$k]['datetime'] = date('Y-m-d H:i:s',$v['create_time']);            $list[$k]['status_text'] = $status[$v['status']];        }        return $this->result(0, '', array('list'=>$list));    }    /**     * 资金记录     */    public function moneylog(){        global $_GPC, $_W;        $pageSize = 15;        $pageCur = $_GPC['page'] ? $_GPC['page'] : 0;        $list = pdo_getall('ox_reclaim_money_log',['uid'=>$_GPC['uid'],'uniacid'=>$_W['uniacid'],'money <>'=>0],[],'',array('id desc'),[$pageCur,$pageSize]);        foreach ($list as $k=>$v){            $list[$k]['datetime'] = date('Y-m-d H:i:s',$v['create_time']);        }        return $this->result(0, '', array('list'=>$list));    }    /**     * 积分记录     */    public function jifenlog(){        global $_GPC, $_W;        $pageSize = 15;        $pageCur = $_GPC['page'] ? $_GPC['page'] : 0;        $list = pdo_getall('ox_reclaim_money_log',['uid'=>$_GPC['uid'],'uniacid'=>$_W['uniacid'],'integral <>'=>0],[],'',array('id desc'),[$pageCur,$pageSize]);        foreach ($list as $k=>$v){            $list[$k]['datetime'] = date('Y-m-d H:i:s',$v['create_time']);        }        return $this->result(0, '', array('list'=>$list));    }}