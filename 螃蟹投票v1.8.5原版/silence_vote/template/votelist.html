{template 'common/header'}
{if IMS_VERSION<1}
<link href="{MODULE_URL}/template/static/css/wq1.0.css" rel="stylesheet">
{/if}
<style>

.audit,.lock,.clearposter{cursor:pointer;}
.table>thead>tr>td, .table>tbody>tr>td, .table>tfoot>tr>td{
white-space: normal;
word-wrap: break-word;
word-break: normal;
}
.label {
    line-height: 1.8;
}
.MagicThumb img,.MagicThumb-container img{margin:2px;padding:1px;border:1px solid #ccc;}
.label{margin:3px 0;}
.we7-margin-right{margin-right: 10px;}
.kaozuo
{
	width: 100%;
	float: left;
	margin-top: 25px;
}
.zouyi
{
	margin-right: 20px;
}
.jiakuan
{
	width: 100px;
}
.wuyu
{
	width: 130px;
	height: 35px;
	border-radius:5px;
	border: 1px solid #C2C2C2;
	position: absolute;
	right: 30px;
	top: 80px;
	display: -webkit-flex;
	flex-direction: row;
	cursor: pointer;
}
.wuyu_one
{
	flex: 4;
	text-align: center;
	line-height: 35px;
	font-family: "微软雅黑";
	font-size: 14px;
	color: #000000;
}	
.wuyu_two
{
	flex: 1;
	text-align: center;
	line-height: 35px;
	color: #666666;
}
.xuanxiang
{
	width: 130px;
	position: absolute;
	top: 37px;
	left: 0;
	z-index: 999;
	border: 1px solid #EEEEEE;
	display: none;
}
.xuanxiang ul
{
	margin: 0;
	padding: 0;
	list-style: none;
}
.xuanxiang ul li
{
	width: 100%;
	height: 40px;
	background: white;
	text-align: center;
	line-height: 40px;
	font-family: "微软雅黑";
	font-size: 14px;
	color: #666666;
	
}
.xuanxiang ul li:hover
{
	background: #F5F5F5;
}
.zhongyao
{
	background: #e95c5c !important ;
	border-color:#db4a4a !important ;
}
.zhongyao:hover
{
	background: #dd3f3f !important;
	border-color:#bd2d2d !important;
}
.yunduan
{
	width: 75px;
	height: 26px;
	background: #428bca;
	color: white;
	text-align: center;
	line-height: 26px;
	border-radius:5px;
	margin-top: 5px;
}
.vertical-middle
{
	padding: 6px !important;
}
.jiahua
{
	display: -webkit-flex;
	flex-direction: row;
}

</style>
<link href="{MODULE_URL}/template/static/css/font-awesome.css" rel="stylesheet">
<script src="{MODULE_URL}/template/static/js/mzp-packed-me.js"></script>
<script>
	$(document).ready(function(){
		$(".wuyu").click(function(){
			$(".xuanxiang").toggle();
		});
	});
</script>
<div class="main1">

    <div class="we7-page-title">选手管理 [ {$reply['activecode']} ]</div>
    <ul class="we7-page-tab">
         <li{if $_GPC['ty'] == '' && $_GPC['do'] == 'votelist' && $_GPC['ranking'] == ''  } class="active"{/if}><a href="{php echo $this->createWebUrl('votelist',array('rid'=>$_GPC['rid']));}">全部投票</a></li>
    <li{if $_GPC['ty'] == '2'} class="active"{/if}><a href="{php echo $this->createWebUrl('votelist',array('rid'=>$_GPC['rid'],'ty'=>2));}">待审核</a></li>
	<li{if $_GPC['ty'] == '1'} class="active"{/if}><a href="{php echo $this->createWebUrl('votelist',array('rid'=>$_GPC['rid'],'ty'=>1));}">已审核</a></li>
	<li{if $_GPC['ranking'] == '0'} class="active"{/if}><a href="{php echo $this->createWebUrl('votelist',array('rid'=>$_GPC['rid'],'ranking'=>0));}">票数排行</a></li>
	<li{if $_GPC['ranking'] == '1'} class="active"{/if}><a href="{php echo $this->createWebUrl('votelist',array('rid'=>$_GPC['rid'],'ranking'=>1));}">礼物排行</a></li>
	<li{if $_GPC['do'] == 'giftlist'} class="active"{/if}><a href="{php echo $this->createWebUrl('giftlist',array('rid'=>$_GPC['rid']));}">全部订单</a></li>
	<li{if $_GPC['do'] == 'votedata'} class="active"{/if}><a href="{php echo $this->createWebUrl('edit',array('id'=>$_GPC['id'],'rid'=>$_GPC['rid']));}">{if $_GPC['id'] > 0}编辑投票用户{else}添加投票用户{/if}</a></li>
    </ul>

<div class="wuyu">
	<div class="wuyu_one">快捷管理菜单</div>
	<div class="wuyu_two">
		<span class="icon-caret-down"></span>
	</div>
	<div class="xuanxiang">
		<ul>
			<a href="{php echo $this->createWebUrl('votelist',array('rid'=>$reply['rid']))}" rel="tooltip" title="选手&订单"><li>选手&订单</li></a>
			<a href="{php echo $this->createWebUrl('robotmanage',array('reply_id'=>$reply['id'],'rid'=>$reply['rid'],'op'=>'display'))}"  rel="tooltip" title="机器人管理" {if $this->module['config']['ischeatshow'] == 1}hidden{/if}><li>机器人管理</li></a>
			<a href="{php echo $this->createWebUrl('commandvote',array('reply_id'=>$reply['id'],'rid'=>$reply['rid'],'op'=>'display'))}" rel="tooltip" title="口令管理"><li>口令管理</li></a>
			<a href="{php echo $this->createWebUrl('mirrorvote',array('reply_id'=>$reply['id'],'rid'=>$reply['rid'],'op'=>'display'))}" rel="tooltip" title="镜像管理"><li>镜像管理</li></a>
			<a href="{php echo $this->createWebUrl('agenthb',array('reply_id'=>$reply['id'],'rid'=>$reply['rid'],'op'=>'display'))}"  rel="tooltip" title="经纪人海报"><li>经纪人海报</li></a>
            <a href="{php echo $this->createWebUrl('voteaddps',array('reply_id'=>$reply['id'],'rid'=>$reply['rid'],'op'=>'display'))}"  rel="tooltip" title="造势" {if $this->module['config']['ischeatshow'] == 1}hidden{/if}><li>造势</li></a>
            <a href="{php echo $this->createWebUrl('voteaddgift',array('reply_id'=>$reply['id'],'rid'=>$reply['rid'],'op'=>'display'))}"  rel="tooltip" title="刷礼物" {if $this->module['config']['ischeatshow'] == 1}hidden{/if}><li>刷礼物</li></a>
            <a href="{php echo $this->createWebUrl('detailset',array('reply_id'=>$reply['id'],'rid'=>$reply['rid'],'op'=>'display'))}"  rel="tooltip" title="模板管理"><li>模板管理</li></a>
            <a href="{php echo $this->createWebUrl('htmlmode',array('reply_id'=>$reply['id'],'rid'=>$reply['rid'],'op'=>'display'))}"  rel="tooltip" title="主题模板设置"><li hidden>主题模板设置</li></a>
            <a href="{php echo $this->createWebUrl('domainlist',array('reply_id'=>$reply['id'],'rid'=>$reply['rid']))}"  rel="tooltip" title="域名防封"><li>域名防封</li></a>
            {if $reply['config']['isredpack']==1}
            <a href="{php echo $this->createWebUrl('lottery',array('rid'=>$reply['rid']))}" rel="tooltip" title="红包管理"> <li>红包管理</li></a>
            {/if}
            {if $reply['saiqustatus']==1}
            <a href="{php echo $this->createWebUrl('saiqumanage',array('reply_id'=>$reply['id'],'rid'=>$reply['rid'],'op'=>'display'))}"  rel="tooltip" title="赛区管理"><li>赛区管理</li></a>
            {/if}
            <a rel="tooltip" href="{php echo url('platform/reply/post',array('m'=>'silence_vote','rid'=>$reply['rid']));}" title="编辑活动"><li class="bianjiea">编辑活动</li></a>
            
		</ul>
	</div>
</div>

    <div class="we7-padding-bottom clearfix">
        <form action="./index.php" method="get" role="form" >
            <div class="input-group pull-left col-sm-4 jiahua">
            <input type="hidden" name="c" value="site" />
			<input type="hidden" name="a" value="entry" />
        	<input type="hidden" name="m" value="silence_vote" />
        	<input type="hidden" name="do" value="votelist" />
			<input type="hidden" name="rid" value="{$_GPC['rid']}" />
                        <input type="hidden" name="flag" value="1" />
                        <input type="hidden" name="ranking" value="{$_GPC['ranking']}" />
            <select class='easyui-combobox' name='saiquid' id='saiquid'  style='width:200px; height: 34px;'
                                  data-options=''></select>
            <script type="text/javascript" src="{MODULE_URL}/template/static/web/jquery-easyui/jquery.easyui.min.js"></script>
<script type="text/javascript" src="{MODULE_URL}/template/static/web/jquery-easyui/jquery.portal.js"></script>
<script type="text/javascript" src="{MODULE_URL}/template/static/web/jquery-easyui/locale/easyui-lang-zh_CN.js"></script>

<link rel="stylesheet" type="text/css" href="{MODULE_URL}/template/static/web/jquery-easyui/themes/gray/easyui.css" />
<link rel="stylesheet" type="text/css" href="{MODULE_URL}/template/static/web/jquery-easyui/themes/color.css" />
<link rel="stylesheet" type="text/css" href="{MODULE_URL}/template/static/web/jquery-easyui/themes/icon.css" />
<link rel="stylesheet" type="text/css" href="{MODULE_URL}/template/static/web/jquery-easyui/themes/IconExtension.css" />
            <script>
                $('#saiquid').combobox({
                    valueField:'id',
                    textField:'text',
                    url:"{php echo $this->createWebUrl('votelist',array('op'=>'getsaiqu',rid=>$_GPC['rid']))}",
                    filter: function(q, row){
                        var opts = $(this).combobox('options');
                        return row[opts.textField].indexOf(q) != -1;
                    },
                    onLoadSuccess:function(){
                        {if $_GPC['flag']}
                            $(this).combobox('select',{$_GPC['saiquid']});
                        {else}
                            $(this).combobox('select',-1);
                        {/if}
                        
                    }
                }); 
            </script>
            <input type="text" name="keyword" value="{$keyword}" class="form-control" placeholder="输入姓名，手机号或ID" style="margin-left: 10px;"/>
            <span class="input-group-btn"><button class="btn btn-default"><i class="fa fa-search"></i></button></span>
            </div>
        </form>
        <div class="kaozuo">
             <input name="deleteall" type="button" class="btn btn-primary" value="批量删除">
             <script>
                $("input[name=deleteall]").click(function () {
               var check = $("input[type=checkbox][class!=check_all]:checked");
               if (check.length < 1) {
                   alert('请选择要删除的数据!');
                   return false;
               }
               if (confirm("确认要删除选择的数据?")) {
                   var id = new Array();
                   check.each(function (i) {
                       id[i] = $(this).val();
                       console.log(id[i]);
                   });
                   
                   var url = "{php echo $this->createWebUrl('votelist', array('op' => 'deleteall'))}";
                   $.post(
                       url,
                       {idArr: id},
                       function (data) {
                           console.log(data);
                           top.location.reload();
                       }, 'json');
               }
           });
             </script>
        <a href="{php echo $this->createWebUrl('uploadvote',array('rid'=>$_GPC['rid']));}" class="btn btn-primary  zouyi">+图片批量导入用户</a>
        <a href="{php echo $this->createWebUrl('excelvote',array('rid'=>$_GPC['rid']));}" class="btn btn-primary  zouyi">+excel批量导入用户</a>
        <a href="{php echo $this->createWebUrl('cloudvote',array('rid'=>$_GPC['rid']));}" class="btn btn-primary zouyi zhongyao">+云端导入选手</a>
            <a href="{php echo $this->createWebUrl('edit',array('rid'=>$_GPC['rid']));}" class="btn btn-primary  zouyi">+添加投票用户</a>
            <a href="{php echo $this->createWebUrl('download',array('rid'=>$_GPC['rid']));}" class="btn btn-primary  zouyi">导出用户数据</a>
        </div>
    </div>
        <table class="table we7-table table-hover">
            <thead class="navbar-inner">
                <tr>
				<th style="width:90px;">选手ID</th>
				<th  width="60">用户</th>	
                <th>用户信息</th>
                <th>赛区</th>	
                <th width="60">图片</th>	
                <th hidden>视频</th>
				<th  width="125">数据</th>
				<th width="95">参加时间</th>
                <th width="95">状态</th>
                <th width="130">操作</th>
                </tr>
            </thead>
            <tbody>
                {loop $list $row}
                <tr>
                    <td  class="text-left vertical-middle"><input type="checkbox" name="uid[]" value="{$row['id']}" class="">{$row['id']}</td>
					<td  class="text-left vertical-middle">
						<div class="jiakuan">
							<img src="{php  echo tomedia($row['avatar']);}" width="48">
						</div>
						<div class="jiakuan">
							{$row['nickname']}
						</div>
						<div class="jiakuan">
							编号：{$row['noid']}
						</div>
                                            {if $row['agent_id']>0}
                                            <div class="jiakuan">
                                                经纪人：{$row['agentname']}
                                            </div>
                                            {/if}
                                            {if $row['source_id']>0}
                                            <div class="jiakuan">
							<div class="yunduan">
								云端导入
							</div>
						</div>
                                            {/if}
                                            {if $row['robotmode'] != 0}
                                            <div class="jiakuan">
							<div class="yunduan" style='width:110px;text-align:center; background: #f0ad4e;'>
								 {if $row['robotmode'] == 1}快速跟随机器人{elseif $row['robotmode'] == 2}缓慢跟随机器人{elseif $row['robotmode'] == 3}快速超越机器人{else}缓慢超越机器人{/if}
							</div>
						</div>
                                            {/if}
					</td>
					
					<td class="text-left vertical-middle" style="max-width:180px;display: inline-block; overflow-x: auto;">
					<p>姓名：<span class="label label-success">{$row['name']}</span></p>
					<p>{php echo $reply['bmzdy']?:'参赛简历'}：<span class="label label-default">{$row['resume']}</span></p>
					 {loop $row['joindata'] $join}
					 <p >
					     {if $join['name']=="性别"}
						    {$join['name']}：<span class="label label-default">
						    {if $join['val']==2}
							  女
							{else}
							  男
							{/if}({$join['val']})
							</span><br>
						 {else}

						    {$join['name']}：<span class="label label-default" >{$join['val']}</span><br/>
						 {/if}
					 </p>
					 {/loop}
					</td>	
                                        <td  class="text-left vertical-middle" >
						<p>赛区：<span class="label label-default">{$row['saiqu']}</span></p>
					</td>
                    <td  class="text-left vertical-middle">
					<a  href="{php  echo tomedia($row['img1']);}" class=" MagicThumb">
					<img src="{php  echo tomedia($row['img1']);}" width="48"></a>
					{if $row['img2']!=""}<a  href="{php  echo tomedia($row['img2']);}" class=" MagicThumb"><img src="{php  echo tomedia($row['img2']);}" width="48"></a>{/if}
					{if $row['img3']!=""}<a  href="{php  echo tomedia($row['img3']);}" class=" MagicThumb"><img src="{php  echo tomedia($row['img3']);}" width="48"></a>{/if}
					{if $row['img4']!=""}<a  href="{php  echo tomedia($row['img4']);}" class=" MagicThumb"><img src="{php  echo tomedia($row['img4']);}" width="48"></a>{/if}
					{if $row['img5']!=""}<a  href="{php  echo tomedia($row['img5']);}" class=" MagicThumb"><img src="{php  echo tomedia($row['img5']);}" width="48"></a>{/if}
					
					</td>
					<td class="text-left vertical-middle" hidden>
						<!-- 按钮触发模态框 -->
					<button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#myModal{$row['id']}">预览</button>
					<!-- 模态框（Modal） -->
					<div class="modal fade" id="myModal{$row['id']}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
					    <div class="modal-dialog">
					        <div class="modal-content">
					            <div class="modal-header">
					                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times</button>
					                <h4 class="modal-title" id="myModalLabel">视频预览</h4>
					            </div>
					            <div class="modal-body">
					            	<video src="{php  echo tomedia($row['video']);}" width="100%" height="500" style="background: #000;" controls preload="metadata"></video>
					            </div>
					            <!--<div class="modal-footer">
					                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
					            </div>-->
					        </div><!-- /.modal-content -->
					    </div><!-- /.modal -->
					</div>
					
					<script>
					   $(function () { $('#myModal{$row['id']}').on('hide.bs.modal', function () {
					   	 $('video').trigger('pause');
					   })
					   });
					</script>
					</td>                                        
	                <td class="text-left vertical-middle">
<p>
	                票数：<span class="label label-primary">{$row['votenum']}</span>
</p><p>
	                礼物：<span class="label label-success">{$row['giftcount']}元</span>
</p><p>
	                浏览：<span class="label label-info">{$row['pvtotal']}</span>
</p><p>
	                分享：<span class="label label-warning">{$row['sharetotal']}</span>
</p>
	                </td>
					<td class="text-left vertical-middle">{php echo date('Y-m-d H:i:s',$row['createtime'])}</td>
                    <td class="text-left vertical-middle">
                    <p>
                    {if $row['status']==0}<span class="label label-info audit" data-id="{$row['id']}" data-s="1">待审核</span> {elseif $row['status']==1}<span class="label label-success audit" data-id="{$row['id']}" data-s="0">已审核</span>{/if}
					</p>
					<p>
					{if $row['locktime']>time() }<span class="label label-danger lock" data-id="{$row['id']}" data-s="1" title="点击解锁">已锁定</span> {elseif $row['locktime']<time()}<span class="label label-success lock" data-id="{$row['id']}" data-s="0"title="点击锁定">非锁定</span>{/if}
					</p>
					<p>
					<span class="label label-danger clearposter" data-id="{$row['id']}" title="点击清除个人海报"title="点击锁定">清除海报</span>
					</p>
					<p>
					</td>
                    <td  class="text-left vertical-middle">
					<p>
					<a class="color-default we7-margin-right" title="投票数据" href="{php echo $this->createWebUrl('votedata',array('rid'=>$row['rid'],'id'=>$row['id'],'ty'=>'votenum'))}" ><i class="fa fa-star-o"></i> 投票数据</a>
					</p><p>
					<a class="color-default we7-margin-right" title="礼物数据" href="{php echo $this->createWebUrl('giftlist',array('rid'=>$row['rid'],'id'=>$row['id']))}" ><i class="fa fa-codepen"></i> 礼物订单</a>
					</p><p>
					<a class="color-default we7-margin-right" title="编辑" href="{php echo $this->createWebUrl('edit',array('rid'=>$row['rid'],'id'=>$row['id']))}" ><i class="fa fa-edit"></i> 编辑</a>
					</p><p>
                    <a class="color-default we7-margin-right" title="他的评论" href="{php echo $this->createWebUrl('voteagree_sel',array('op'=>'sel','id'=>$row['id']))}"><i class="fa fa-search"></i> 他的评论</a>
                    </p><p>

					<a class="color-default we7-margin-right" rel="tooltip" href="#" onclick="drop_confirm('您确定要删除吗?删除不可恢复，同时删除所有相关数据！', '{php echo $this->createWebUrl('otherset',array('ty'=>'deletevoteuser','id'=>$row['id'],'rid'=>$row['rid']))}');" title="删除"><i class="fa fa-times"></i> 删除</a></p>
                    </td>
                </tr>
                {/loop}
				<tr>
			<td><input type="checkbox" name="" onclick="var ck = this.checked;$(':checkbox').each(function(){this.checked = ck});"></td>
			<td colspan="7"><input type="hidden" name="isstatus" class="btn btn-primary" value="审核"></td>
		</tr>
            </tbody>
        </table>
      <div class="pull-right">
        {$pager}
    </div>
</div>
<script>
$(function(){

            $(".check_all").click(function(){
            var checked = $(this).get(0).checked;
                    $("input[type=checkbox]").attr("checked", checked);
            });
            $("input[name=isstatus]").click(function(){

				var check = $("input:checked");
						if (check.length < 1){
				err('请选择要删除的记录!');
						return false;
				}
				if (confirm("确认要删除选择的记录?")){
				var id = new Array();
						check.each(function(i){
						id[i] = $(this).val();
						});
						$.post('{php echo create_url('site/entry', array('do' => 'otherset','rid' => $_GPC["rid"],'ty' => 'statusAll', 'm' => 'silence_vote'))}', {idArr:id}, function(data){
						if (data.errno == 0)
						{
						    location.reload();
						} else {
						    alert(data.error);
						}
						}, 'json');
				}

            });
			
			

$(".audit").click(function(){
    var clickthis=$(this);
    var did=clickthis.attr('data-id');
	var audit=clickthis.attr('data-s');
	$.ajax({
		type : "post",
		url : "{php echo $this->createWebUrl('otherset',array('rid'=>$_GPC['rid'],'ty'=>'audit'))}",
		data : {
			id : did,
			audit : audit,
		},
		dataType : "json",
		success : function(res) {
			if (res.status == 200) {
			    clickthis.attr('data-s',(1-audit));
				if(clickthis.hasClass('label-success')){
				    clickthis.removeClass("label-success");
                    clickthis.addClass('label-info');
					clickthis.html('待审核');
                }else{
				    clickthis.removeClass("label-info");
				    clickthis.addClass('label-success');
					clickthis.html('已审核');
				}
			}
		}

	});
});		
			

$(".lock").click(function(){
    var clickthis=$(this);
    var did=clickthis.attr('data-id');
	var lock=clickthis.attr('data-s');
	$.ajax({
		type : "post",
		url : "{php echo $this->createWebUrl('otherset',array('rid'=>$_GPC['rid'],'ty'=>'lock'))}",
		data : {
			id : did,
			lock : lock,
		},
		dataType : "json",
		success : function(res) {
			if (res.status == 200) {
			    clickthis.attr('data-s',(1-lock));
				if(clickthis.hasClass('label-success')){
				    clickthis.removeClass("label-success");
                    clickthis.addClass('label-danger');
					clickthis.html('已锁定');
                }else{
				    clickthis.removeClass("label-danger");
				    clickthis.addClass('label-success');
					clickthis.html('非锁定');
				}
			}
		}

	});
});	

$(".clearposter").click(function(){
    var clickthis=$(this);
    var did=clickthis.attr('data-id');
	$.ajax({
		type : "post",
		url : "{php echo $this->createWebUrl('otherset',array('rid'=>$_GPC['rid'],'ty'=>'clearposter'))}",
		data : {
			id : did
		},
		dataType : "json",
		success : function(res) {
			if (res.status == 200) {
			    alert("清除成功，可以重新生成！");
			}else if(res.status == 404){
			    alert("该用户还没有生成海报。");
			}else{
			     alert("删除失败，请检查是否有删除权限！");
			}
		}

	});
});	

	
			
});


</script>
<script>
            function drop_confirm(msg, url){
            if (confirm(msg)){
            window.location = url;
            }
            }

</script>

{template 'common/footer'}