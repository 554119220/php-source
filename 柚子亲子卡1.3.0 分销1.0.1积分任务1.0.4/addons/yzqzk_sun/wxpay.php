<?php
 class WeixinPay { protected $appid; protected $mch_id; protected $key; protected $openid; protected $out_trade_no; protected $body; protected $total_fee; protected $attach; protected $notify_url; function __construct($appid, $openid, $mch_id, $key, $out_trade_no, $body, $total_fee, $attach = 0, $notify_url = "\150\164\164\x70\x3a\x2f\57\x77\167\x77\56\167\x65\151\170\151\x6e\x2e\161\x71\x2e\x63\x6f\x6d\x2f\167\170\160\141\171\57\x70\x61\171\56\160\x68\x70") { goto m5Pf9; Sdjiw: $this->notify_url = $notify_url; goto vGMgh; QaOMH: $this->total_fee = $total_fee; goto TFAbr; z4NMG: $this->key = $key; goto eWt4Z; TFAbr: $this->attach = $attach; goto Sdjiw; m5Pf9: $this->appid = $appid; goto EcAxm; FVPUy: $this->body = $body; goto QaOMH; eWt4Z: $this->out_trade_no = $out_trade_no; goto FVPUy; EcAxm: $this->openid = $openid; goto XSD2g; XSD2g: $this->mch_id = $mch_id; goto z4NMG; vGMgh: } public function pay() { $return = $this->weixinapp(); return $return; } private function unifiedorder() { goto UbPDc; UbPDc: $url = "\150\x74\x74\160\x73\72\x2f\x2f\x61\x70\x69\x2e\x6d\x63\x68\56\167\x65\151\x78\151\156\56\x71\161\56\x63\x6f\155\x2f\160\141\171\57\x75\156\151\146\151\145\144\x6f\x72\x64\x65\162"; goto X50lC; GBN7q: $xmlData = $this->arrayToXml($parameters); goto mWuXt; mWuXt: $return = $this->xmlToArray($this->postXmlCurl($xmlData, $url, 60)); goto VxGx4; VxGx4: return $return; goto MorkE; X50lC: $parameters = array("\x61\x70\160\151\x64" => $this->appid, "\155\143\x68\x5f\151\x64" => $this->mch_id, "\156\157\156\143\x65\x5f\x73\164\x72" => $this->createNoncestr(), "\x62\157\144\x79" => $this->body, "\141\x74\164\x61\x63\150" => $this->attach, "\157\165\x74\137\164\162\x61\x64\145\x5f\x6e\x6f" => $this->out_trade_no, "\x74\157\164\141\154\x5f\x66\145\145" => $this->total_fee, "\163\x70\x62\151\x6c\x6c\x5f\143\162\145\x61\164\x65\137\x69\x70" => $_SERVER["\x52\x45\115\117\x54\105\x5f\101\x44\104\122"], "\x6e\x6f\164\151\146\171\137\x75\x72\x6c" => $this->notify_url, "\x6f\x70\x65\x6e\151\144" => $this->openid, "\x74\162\141\x64\145\x5f\x74\171\x70\145" => "\112\x53\101\x50\x49"); goto cza3b; cza3b: $parameters["\x73\151\147\x6e"] = $this->getSign($parameters); goto GBN7q; MorkE: } private static function postXmlCurl($xml, $url, $second = 30) { goto qsb2w; g1NBg: curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE); goto mb0H1; psJuH: if ($data) { goto wrSCt; } goto Vunx_; yvw_J: curl_setopt($ch, CURLOPT_POSTFIELDS, $xml); goto MsG0n; AzKb4: curl_close($ch); goto i3bH2; sibqN: curl_setopt($ch, CURLOPT_POST, TRUE); goto yvw_J; kVf2G: goto n_pUM; goto rCfaY; MsG0n: curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 20); goto QPRBd; qsb2w: $ch = curl_init(); goto ih0Th; MmnZl: curl_close($ch); goto u235F; kqNHE: curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE); goto sibqN; tnbzM: n_pUM: goto WVUi7; i3bH2: return $data; goto tnbzM; z8L3d: set_time_limit(0); goto LSned; QPRBd: curl_setopt($ch, CURLOPT_TIMEOUT, 40); goto z8L3d; jSw64: curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE); goto g1NBg; u235F: throw new WxPayException("\x63\165\x72\x6c\xe5\207\xba\xe9\224\x99\357\274\x8c\xe9\x94\231\350\257\257\xe7\240\201\x3a{$error}"); goto kVf2G; ih0Th: curl_setopt($ch, CURLOPT_TIMEOUT, $second); goto uvjhV; rCfaY: wrSCt: goto AzKb4; mb0H1: curl_setopt($ch, CURLOPT_HEADER, FALSE); goto kqNHE; Vunx_: $error = curl_errno($ch); goto MmnZl; LSned: $data = curl_exec($ch); goto psJuH; uvjhV: curl_setopt($ch, CURLOPT_URL, $url); goto jSw64; WVUi7: } private function arrayToXml($arr) { goto ydVg3; Q6eSe: $xml .= "\x3c\x2f\x72\157\157\x74\76"; goto hfSBD; bUU95: foreach ($arr as $key => $val) { goto ECh2A; ZQE72: goto igR2d; goto GRkdG; GRkdG: G0FIf: goto rRw9q; ECh2A: if (is_array($val)) { goto G0FIf; } goto yiFYe; w2jJv: zKXTH: goto c7xmZ; SKuuV: igR2d: goto w2jJv; yiFYe: $xml .= "\x3c" . $key . "\76" . $val . "\74\x2f" . $key . "\76"; goto ZQE72; rRw9q: $xml .= "\74" . $key . "\x3e" . arrayToXml($val) . "\x3c\57" . $key . "\76"; goto SKuuV; c7xmZ: } goto pPf5j; ydVg3: $xml = "\74\162\157\x6f\x74\76"; goto bUU95; hfSBD: return $xml; goto gPsEL; pPf5j: N8Lc8: goto Q6eSe; gPsEL: } private function xmlToArray($xml) { goto IWapT; IWapT: libxml_disable_entity_loader(true); goto FdhDN; FdhDN: $xmlstring = simplexml_load_string($xml, "\123\x69\155\160\x6c\145\130\115\x4c\105\154\145\155\x65\156\x74", LIBXML_NOCDATA); goto VeCbR; ihrk0: return $val; goto pT_yD; VeCbR: $val = json_decode(json_encode($xmlstring), true); goto ihrk0; pT_yD: } private function weixinapp() { goto A94pE; A94pE: $unifiedorder = $this->unifiedorder(); goto T7Cru; T7Cru: $parameters = array("\x61\160\x70\x49\144" => $this->appid, "\164\x69\x6d\145\x53\164\141\155\160" => '' . time() . '', "\156\x6f\x6e\143\x65\123\x74\162" => $this->createNoncestr(), "\x70\x61\143\x6b\141\x67\145" => "\x70\162\x65\160\x61\x79\x5f\x69\144\75" . $unifiedorder["\x70\x72\145\x70\141\171\x5f\x69\144"], "\x73\151\x67\156\124\171\x70\x65" => "\115\x44\x35"); goto WfXo_; WfXo_: $parameters["\160\x61\171\x53\x69\x67\156"] = $this->getSign($parameters); goto N6EVq; N6EVq: $parameters["\x70\x72\145\x70\141\171\x5f\x69\x64"] = $unifiedorder["\160\162\145\160\141\x79\137\151\x64"]; goto oGu2f; oGu2f: return $parameters; goto s2QWf; s2QWf: } private function createNoncestr($length = 32) { goto Yv4k3; cDZ5m: iXehA: goto ssj4_; P1pIb: $i++; goto nfO4M; ssj4_: if (!($i < $length)) { goto JWGYl; } goto bgJua; RgnqS: return $str; goto gaw4d; Yv4k3: $chars = "\141\x62\x63\x64\x65\146\147\150\x69\x6a\153\154\x6d\x6e\x6f\x70\161\x72\x73\x74\x75\x76\167\x78\x79\172\60\x31\62\63\x34\65\x36\x37\70\71"; goto MHUlO; bgJua: $str .= substr($chars, mt_rand(0, strlen($chars) - 1), 1); goto WUtjB; nfO4M: goto iXehA; goto ItfbW; ItfbW: JWGYl: goto RgnqS; N40O6: $i = 0; goto cDZ5m; MHUlO: $str = ''; goto N40O6; WUtjB: Dx8Gf: goto P1pIb; gaw4d: } private function getSign($Obj) { goto X9MBE; X9MBE: foreach ($Obj as $k => $v) { $Parameters[$k] = $v; WNn_l: } goto G0iqA; OGcD4: $String = md5($String); goto gcyux; B1FbB: ksort($Parameters); goto PR8f5; PR8f5: $String = $this->formatBizQueryParaMap($Parameters, false); goto kHYFt; G0iqA: VbBFm: goto B1FbB; gcyux: $result_ = strtoupper($String); goto wrnAo; kHYFt: $String = $String . "\46\153\x65\171\75" . $this->key; goto OGcD4; wrnAo: return $result_; goto ex9bn; ex9bn: } private function formatBizQueryParaMap($paraMap, $urlencode) { goto OUstE; OUstE: $buff = ''; goto bd5S2; yT8ni: if (!(strlen($buff) > 0)) { goto pK1HQ; } goto pWDba; oFjiT: $reqPar; goto yT8ni; bd5S2: ksort($paraMap); goto is2Bb; pWDba: $reqPar = substr($buff, 0, strlen($buff) - 1); goto ZQlkp; dagos: Gub42: goto oFjiT; is2Bb: foreach ($paraMap as $k => $v) { goto M8O7M; Z77E4: oMdPa: goto Mb2S6; CX1kf: $v = urlencode($v); goto s7iOz; oB96p: $buff .= $k . "\75" . $v . "\x26"; goto Z77E4; M8O7M: if (!$urlencode) { goto su6mf; } goto CX1kf; s7iOz: su6mf: goto oB96p; Mb2S6: } goto dagos; ZQlkp: pK1HQ: goto TMxhs; TMxhs: return $reqPar; goto rC4Hl; rC4Hl: } }