<?phpif (!(defined('IN_IA'))){    exit('Access Denied');}class Api_Me extends WeModuleWxapp{    /**     * 反馈建议     */    public function suggest(){        global $_GPC, $_W;        $params = [            'content' => $_GPC['suggest'],            'uniacid'=>$_W['uniacid'],            'create_time' => $_SERVER['REQUEST_TIME']        ];        $result = pdo_insert('musen_repair_suggest',$params);        return $this->result(0, '', $result);    }    /**     * 检测是否是黑名单会员     */    public function userblack(){        global $_GPC, $_W;        $user = pdo_get('ox_master_black',array('uniacid'=>$_W['uniacid'],'uid'=>$_GPC['uid'],'black_time >'=>time()));        if(!empty($user)){            if($user['black_time'] == 0){                $user['black_time'] ='无';            }else{                $user['black_time'] = date('Y-m-d H:i');            }            $result['user'] = $user;        }else{            $result['user'] = 0;        }        return $this->result(0, '', $result);    }    /**     * webview     */    public function webView(){        global $_W, $_GPC;        $params = [            'uniacid' => $_W['uniacid'],            'type' => $_GPC['type']        ];        if($_GPC['type'] == 2){            $detail = pdo_get('ox_master_view',$params);        }else{            $params['id'] = $_GPC['id'];            $detail = pdo_get('ox_master_view',$params);        }        if($detail){            $detail['content'] = htmlspecialchars_decode($detail['content']);        }        return $this->result(0,'保存成功',$detail);    }    /*     * 添加form_id     */    public function add_formid(){        global $_GPC;        $ceshi = new Basis();        $result = $ceshi->add_form_id($_GPC['uid'],$_GPC['formid']);        return $this->result(0, '', $result);    }    /**     * 资金列表     */    public function moneyList(){        global $_GPC, $_W;        $params = [            "uniacid" => $_W['uniacid'],            "uid"=> $_GPC['uid']        ];        if($_GPC['status'] == 1){            $params['lock_money <>']=0;        }else{            $params['money <>']=0;        }        $pageSize = 10;        $pageCur = $_GPC['page'] ?: 1;        $list = pdo_getall('ox_master_money_log',$params,'','',['id desc'],[$pageCur,$pageSize]);        foreach ($list as $k => $v){            $list[$k]['create_time'] = date('Y-m-d H:i',$v['create_time']);            if($_GPC['status'] == 1){                $list[$k]['zengjian'] = $v['lock_money']>0?'+':'';                $list[$k]['money'] = $v['lock_money'];                $list[$k]['last_money'] = $v['last_lock_money'];            }else{                $list[$k]['zengjian'] = $v['money']>0?'+':'';            }        }        return $this->result(0, '', $list);    }    /**     * 提现列表     */    public function takeList(){        global $_GPC, $_W;        $params = [            "uniacid" => $_W['uniacid'],            "uid"=> $_GPC['uid']        ];        $status_arr = ['0'=>'未审核','1'=>'已通过','2'=>'已驳回'];        $pageSize = 10;        $pageCur = $_GPC['page'] ?: 1;        $list = pdo_getall('ox_master_take_log',$params,'','',['id desc'],[$pageCur,$pageSize]);        foreach ($list as $k => $v){            $list[$k]['create_time'] = date('Y-m-d H:i',$v['create_time']);            $list[$k]['status_text'] = $status_arr[$v['status']];        }        $res['list'] =  $list;        $res['userinfo'] = pdo_get('ox_master_store',["uniacid" => $_W['uniacid'], "uid"=> $_GPC['uid']]);        $base_info = pdo_get('ox_master',array("uniacid" => $_W['uniacid']));        $res['userinfo']['points'] = $base_info['points'];        $res['userinfo']['min_cash'] = $base_info['min_cash'];        return $this->result(0, '', $res);    }    /**     * 提现提交     */    public function takeAdd(){        global $_GPC, $_W;        $ceshi = new Basis();        $result = $ceshi->add_form_id($_GPC['uid'],$_GPC['formid']);        //判断账户余额是否小于当前余额        $userinfo = pdo_get('ox_master_store',['uniacid'=>$_W['uniacid'],'uid'=>$_GPC['uid']]);        if($userinfo['money']<$_GPC['takemoney']){            return $this->result(200, '账户余额不足', $userinfo);        }        //手续费        $info = pdo_get('ox_master',array('uniacid'=>$_W['uniacid']));        //增加提现记录        $take_arr = [            'uniacid'=>$_W['uniacid'],            'uid'=>$_GPC['uid'],            'money'=>$_GPC['takemoney'],            'arrival_money'=>$_GPC['takemoney']-($_GPC['takemoney']*$info['points']),            'status'=>0,            'create_time'=>time(),        ];        $res = pdo_insert('ox_master_take_log',$take_arr);        if(!$res){            return $this->result(200, '添加记录失败', $take_arr);        }        $take_id = pdo_insertid();        $money = (-1)*$_GPC['takemoney'];    //变动可用资金        $lock_money = $_GPC['takemoney'];//变动冻结资金        $uid = $_GPC['uid'];       //用户uid        $parame = array(            'from_uid'=>$_GPC['uid'],  //来源用户-可不填写            'type'=>2, //类型 0接单 1完工 2提现 3到账(无实际作用,可不设置)            'from_id'=>$take_id,   //来源id 订单id或提现表id(非小程序form_id)            'from_table'=>'ox_master_take_log', //来源表名，不带ims_            'desc'=>'提现申请，扣除余额'        );        $result = $ceshi->money_change($money,$lock_money,$uid,$parame);        if($result['code']){            return $this->result(0, '', $res);        }else{            pdo_delete('ox_master_take_log',array('id'=>$take_id));            return $this->result(200, $result['msg'], $take_arr);        }    }    /**     * 小程序信息     */    public function about(){        global $_GPC, $_W;        $detail = pdo_get('ox_master',['uniacid'=>$_W['uniacid']]);        $list = pdo_getall('ox_master_view',['uniacid'=>$_W['uniacid'],'type'=>1],['id','title'],'',['sort desc']);        if($detail){            if($detail['logo']){                $detail['logo'] = tomedia($detail['logo']);            }else{                $detail['logo'] = tomedia('/addons/ox_master/icon.jpg');            }        }        $result = [            'detail' => $detail,            'list' => $list,        ];        return $this->result(0, '', $result);    }    /**     * 退款记录     */    public function refund(){        global $_GPC, $_W;        $params = [            "uniacid" => $_W['uniacid'],            "uid"=> $_GPC['uid']        ];        $pageSize = 10;        $pageCur = $_GPC['page'] ?: 1;        $list = pdo_getall('ox_master_refund',$params,'','',['id desc'],[$pageCur,$pageSize]);        foreach ($list as $k => $v){            $list[$k]['create_time'] = date('Y-m-d H:i',$v['create_time']);            //订单信息            $list[$k]['sn'] = pdo_getcolumn('ox_master_order',array("uniacid" => $_W['uniacid'],'id' => $v['order_id']),'o_sn');        }        return $this->result(0, '', $list);    }}