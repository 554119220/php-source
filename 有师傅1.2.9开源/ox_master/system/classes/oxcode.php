<?php/** * Created by PhpStorm. * User: Administrator * Date: 2018/5/8 * Time: 16:33 */include __DIR__ . "/../../plugin/qrcode/phpqrcode.php";class Oxcode{    public static  $instance;    public static  function Instance(){        if(!self::$instance) {            self::$instance = new self();        }        return self::$instance;    }    /**     * 生成通用二维码     * @param $str     */    public function phpqrcode($params){        global $_W;        $image_path = '/images/' . MODEL_NAME. '/qrcode/' . date('Y-m-d') . '/';        if (!is_dir(ATTACHMENT_ROOT .$image_path)) {            $re = @mkdir(ATTACHMENT_ROOT . $image_path, '0755', true);         }        $filename = order_sn().'.png';        QRcode::png('13864984442',ATTACHMENT_ROOT . $image_path.$filename,'L');        return $image_path.$filename;    }    /**     * 生成太阳码     * @param array $params [scene]     * @return mixed     * @throws     */    public function getwxacodeunlimit($params = [])    {        global $_W, $_GPC;        $url = "https://api.weixin.qq.com/wxa/getwxacodeunlimit?access_token=" . $this->getToken();        $params = [            'scene' => isset($params['scene']) ? $params['scene'] : "123",            'page' => isset($params['page']) ? $params['page'] : "",            'width' => 200,            'auto_color' => false,            'is_hyaline' => true,            'line_color' => [                'r' => 0,                'g' => 0,                'b' => 0,            ]        ];        $params = json_encode($params);        $image = ihttp_post($url, $params);//        header('Content-type: image/jpeg');//        echo $image['content'];die;        if ($image['code'] == '200') {            //        $image =  $this->curl1($url,$params,$method = 'POST', $header = array(), $multi = true);            $image_path = '/images/' . MODEL_NAME. '/qrcode/' . date('Y-m-d') . '/';            if (!is_dir($image_path)) {                $re = @mkdir(ATTACHMENT_ROOT . $image_path, '0755', true);            }//判断目录存在否，存在不创建     echo "目录'" . $path . "'已经存在";  //已经存在则输入路径   }            $filename = order_sn(). '.png';            $result = file_put_contents(ATTACHMENT_ROOT . $image_path . $filename, $image['content']);            load()->func('file');            @file_remote_upload($image_path.$filename);            $re=['all'=>tomedia($image_path.$filename),'short'=>($image_path.$filename)];            return $re;        }else{            return ['fail'];          //var_dump($image);        }    }    /**     * 获取token     * @return mixed     * @throws     */    private function getToken()    {        global $_W, $_GPC;        $url = 'https://api.weixin.qq.com/cgi-bin/token';        $result = cache_load("{$_W['uniacid']}_".MODEL_NAME."_token");        if(is_array($result) && $result['end_time'] > TIMESTAMP){            return $result['access_token'];        }        $query = [            'grant_type' => "client_credential",            'appid' => $_W['uniaccount']['key'],            'secret' => $_W['uniaccount']['secret'],        ];        $result = ihttp_request($url,$query);        $result = json_decode($result['content'],1);        if (isset($result['access_token'])) {            $access_token = $result['access_token'];            $data = [                'access_token' =>    $result['access_token'],                'end_time' => TIMESTAMP +  $result['expires_in'] - 600,            ];            cache_write("{$_W['uniacid']}_newsharing_token", $data);        }        return $access_token;    }}