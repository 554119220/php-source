<?php/** * 模板消息发送 */class Wxdata{    public static  $instance;    public static  function Instance(){        if(!self::$instance) {            self::$instance = new self();        }        return self::$instance;    }    /**     * 获取用户访问小程序数据周趋势     * @param     * string begin_date     * 开始日期，为周一日期。格式为 yyyymmdd     * string end_date     * 结束日期，为周日日期，限定查询一周数据。格式为 yyyymmdd     * @return array AT0007     */    public function weeklyVisitTrend($params){        $url = "https://api.weixin.qq.com/datacube/getweanalysisappidweeklyvisittrend?access_token=".$this->getToken();        $data = [            'begin_date' => $params['begin_date'],            'end_date' => $params['end_date']        ];        $result = ihttp_post($url,json_encode($data));        $result = json_decode($result['content'],1);        return $result;    }    /**     * 获取用户访问小程序数据概况     * @param     * string begin_date     * 开始日期。格式为 yyyymmdd     * string end_date     * 结束日期，限定查询1天数据，允许设置的最大值为昨日。格式为 yyyymmdd     * @return array AT0007     */    public function dailySummary($params){        $url = "https://api.weixin.qq.com/datacube/getweanalysisappiddailysummarytrend?access_token=".$this->getToken();        $data = [            'begin_date' => $params['begin_date'],            'end_date' => $params['end_date']        ];        $result = ihttp_post($url,json_encode($data));        $result = json_decode($result['content'],1);        return $result;    }    /**     * 获取用户访问小程序数据日趋势     * @param     * string begin_date     * 开始日期。格式为 yyyymmdd     * string end_date     * 结束日期，限定查询1天数据，允许设置的最大值为昨日。格式为 yyyymmdd     * @return array AT0007     */    public function dailyVisitTrend($params){        $url = "https://api.weixin.qq.com/datacube/getweanalysisappiddailyvisittrend?access_token=".$this->getToken();        $data = [            'begin_date' => $params['begin_date'],            'end_date' => $params['end_date']        ];        $result = ihttp_post($url,json_encode($data));        $result = json_decode($result['content'],1);        return $result;    }    /**     * 获取用户访问小程序周留存     * @param     * string begin_date     * 开始日期，为自然月第一天。格式为 yyyymmdd     *string end_date     *结束日期，为自然月最后一天，限定查询一个月数据。格式为 yyyymmdd     * @return array AT0007     */    public function monthlyRetain($params){        $url = "https://api.weixin.qq.com/datacube/getweanalysisappidmonthlyretaininfo?access_token=".$this->getToken();        $data = [            'begin_date' => $params['begin_date'],            'end_date' => $params['end_date']        ];        $result = ihttp_post($url,json_encode($data));        $result = json_decode($result['content'],1);        return $result;    }    /**     * 获取用户访问小程序日留存     * @param     * string begin_date     *开始日期。格式为 yyyymmdd     *string end_date     *结束日期，限定查询1天数据，允许设置的最大值为昨日。格式为 yyyymmdd     * @return array AT0007     */    public function dailyRetain($params){        $url = "https://api.weixin.qq.com/datacube/getweanalysisappiddailyretaininfo?access_token=".$this->getToken();        $data = [            'begin_date' => $params['begin_date'],            'end_date' => $params['end_date']        ];        $result = ihttp_post($url,json_encode($data));        $result = json_decode($result['content'],1);        return $result;    }    /**     * 获取小程序新增或活跃用户的画像分布数据     * @param     * @return ar     * string begin_date     * 开始日期。格式为 yyyy-mm-dd     * string end_date     * 结束日期，开始日期与结束日期相差的天数限定为0/6/29，分别表示查询最近1/7/30天数据，允许设置的最大值为昨日。格式为 yyyy-mm-dd     * ray AT0007     */    public function userPortrait($params){        $url = "https://api.weixin.qq.com/datacube/getweanalysisappiduserportrait?access_token=".$this->getToken();        $data = [            'begin_date' => $params['begin_date'],            'end_date' => $params['end_date']        ];        $result = ihttp_post($url,json_encode($data));        $result = json_decode($result['content'],1);        return $result;    }    /**     * 获取用户小程序访问分布数据     * @param     * string begin_date     * 开始日期。格式为 yyyymmdd     * string end_date     * 结束日期，限定查询 1 天数据，允许设置的最大值为昨日。格式为 yyyymmdd     * @return array AT0007     */    public function visitDistribution($params){        $url = "https://api.weixin.qq.com/datacube/getweanalysisappidvisitdistribution?access_token=".$this->getToken();        $data = [            'begin_date' => $params['begin_date'],            'end_date' => $params['end_date']        ];        $result = ihttp_post($url,json_encode($data));        $result = json_decode($result['content'],1);        return $result;    }    /**     * 获取用户小程序访问分布数据     * @param     * string begin_date     * 开始日期。格式为 yyyymmdd     * string end_date     * 结束日期，限定查询1天数据，允许设置的最大值为昨日。格式为 yyyy-mm-dd     * @return array AT0007     */    public function visitPage($params){        $url = "https://api.weixin.qq.com/datacube/getweanalysisappidvisitpage?access_token=".$this->getToken();        $data = [            'begin_date' => $params['begin_date'],            'end_date' => $params['end_date']        ];        $result = ihttp_post($url,json_encode($data));        $result = json_decode($result['content'],1);        return $result;    }    /**     * 获取用户访问小程序周留存     * @param     * string begin_date     * 开始日期，为周一日期。格式为 yyyymmdd     * string end_date     * 结束日期，为周日日期，限定查询一周数据。格式为 yyyymmdd     * @return array AT0007     */    public function weeklyRetain($params){        $url = "https://api.weixin.qq.com/datacube/getweanalysisappidweeklyretaininfo?access_token=".$this->getToken();        $data = [            'begin_date' => $params['begin_date'],            'end_date' => $params['end_date']        ];        $result = ihttp_post($url,json_encode($data));        $result = json_decode($result['content'],1);        return $result;    }    /**     * 获取用户访问小程序数据月趋势     * @param     * string begin_date     * 开始日期，为自然月第一天。格式为 yyyymmdd     * string end_date     * 结束日期，为自然月最后一天，限定查询一个月的数据。格式为 yyyymmdd     * @return array AT0007     */    public function monthlyVisitTrend($params){        $url = "https://api.weixin.qq.com/datacube/getweanalysisappidmonthlyvisittrend?access_token=".$this->getToken();        $data = [            'begin_date' => $params['begin_date'],            'end_date' => $params['end_date']        ];        $result = ihttp_post($url,json_encode($data));        $result = json_decode($result['content'],1);        return $result;    }    /**     * 获取token     * @return mixed     * @throws     */    private function getToken()    {        global $_W, $_GPC;        $url = 'https://api.weixin.qq.com/cgi-bin/token';        $result = cache_load("{$_W['uniacid']}_newsharing_token");        if(is_array($result) && $result['end_time'] > TIMESTAMP){            return $result['access_token'];        }        $query = [            'grant_type' => "client_credential",            'appid' => $_W['uniaccount']['key'],            'secret' => $_W['uniaccount']['secret'],        ];        $result = ihttp_request($url,$query);        $result = json_decode($result['content'],1);        if (isset($result['access_token'])) {            $access_token = $result['access_token'];            $data = [            'access_token' =>    $result['access_token'],            'end_time' => TIMESTAMP +  $result['expires_in'] - 600,            ];            cache_write("{$_W['uniacid']}_newsharing_token", $data);        }        return $access_token;    }}