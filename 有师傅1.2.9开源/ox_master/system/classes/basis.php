<?php/** * Created by PhpStorm. * Time: 2019年3月15日14:58:35 */class Basis{    /*     * 添加from_id     * $uid     * $from_id     * 返回值 1     */    public function add_form_id($uid, $from_id){        global  $_W;        if(empty($uid)){            return 2;        }        if(empty($from_id) || $from_id == 'the formId is a mock one'){            return 3;        }        $data = array(            'uid'=>$uid,            'form_id'=>$from_id,            'uniacid'=>$_W['uniacid'],            'create_time'=>time(),        );        pdo_insert('ox_master_formid',$data);        return 1;    }    /*	 * 资金处理通用方法	 * $money 余额变动	 * $lock_money 冻结余额变动	 * $uid 处理的用户id	 * $parame->from_uid 来源用户-可不填写	 * $parame->type 类型 0接单 1完工 2提现 3到账	 * $parame->from_id 来源id 订单id或提现表id	 * $parame->from_table 来源表名，不带ims_     * $parame->desc 描述     * $pdo 是否开启事物 默认开启 1或ture 关闭     *     * return->code 0失败 1成功     * return->msg 失败原因	 */    public function money_change($money, $lock_money, $uid, $parame, $pdo=0)    {        global $_W;        $uniacid = $_W['uniacid'];        $ret = array(            'code' => 0,        );        if(!$pdo){            pdo()->begin();        }        $user_info = pdo_get('ox_master_store', array('uid' => $uid, 'uniacid' => $uniacid));        $user_date = array();        //判断余额        if (!empty($money)) {            $user_date['money'] = $user_info['money'] + $money;            if ($user_date['money'] < 0) {                $ret['msg'] = '用户金额不足';                return $ret;            }            $parame['money'] = $money;            $parame['last_money'] = $user_date['money'];        } else {            $parame['money'] = 0;            $parame['last_money'] = $user_info['money'];        }        //判断冻结余额        if (!empty($lock_money)) {            $user_date['lock_money'] = $user_info['lock_money'] + $lock_money;            if ($user_date['lock_money'] < 0) {                $ret['msg'] = '用户冻结金额不足';                return $ret;            }            $parame['lock_money'] = $lock_money;            $parame['last_lock_money'] = $user_date['lock_money'];        } else {            $parame['lock_money'] = 0;            $parame['last_lock_money'] = $user_info['lock_money'];        }        //处理会员余额及冻结余额        $user_up = pdo_update('ox_master_store', $user_date, array('uid' => $uid, 'uniacid' => $uniacid));        if (!$user_up) {            if(!$pdo){                pdo()->rollback();            }            $ret['msg'] = '修改用户金额失败';            return $ret;        }        //资金记录表添加记录        $parame['uniacid'] = $uniacid;        $parame['uid'] = $uid;        $parame['create_time'] = time();        $result_log = pdo_insert('ox_master_money_log', $parame);        if (empty($result_log)) {            if(!$pdo){                pdo()->rollback();            }            $ret['msg'] = '添加资金记录失败';            return $ret;        }        if(!$pdo){            pdo()->commit();        }        $ret['code'] = 1;        return $ret;    }    /**     * 初始化短信模板     */    public function initSmsTemplate(){        global $_W;        $uniacid = $_W['uniacid'];        $data = [            [                'uniacid'=>$uniacid,                'template_name'=>'用户发布需求通知师傅',                'template_code'=>'order_notify',                'template_title'=>'',                'template_content'=>'您好，{1}发布了{2}新需求，赶快接单吧。',                'is_enable'=> 1,                'update_time'=>time()            ]        ];        pdo()->begin();        foreach ($data as $key=>$value){            $data = [];            $templateData = pdo_get('ox_master_sms_template',['template_code'=>'order_notify','uniacid'=>$uniacid]);            if(!$templateData){                $indata = [];                $indata['uniacid'] = $value['uniacid'];                $indata['template_name'] = $value['template_name'];                $indata['template_code'] = $value['template_code'];                $indata['template_title'] = $value['template_title'];                $indata['template_content'] = $value['template_content'];                $indata['is_enable'] = $value['is_enable'];                $indata['update_time'] = time();                $rs = pdo_insert('ox_master_sms_template',$indata);                if(!$rs){                    pdo()->rollback();                    return false;                }            }        }        pdo_commit();        return true;    }    /**     * 下单后发送短信公众号通知师傅     */    public function orderNotify( $order_id = '' ){        global $_W;        //订单        $order = pdo_get( 'ox_master_order',["id" => $order_id] );        if(!$order){            return false;        }        $info = pdo_get( 'ox_master',["uniacid" => $_W['uniacid']] );        if($info['notify_rule']==1){//分类            $sql =" SELECT phone,uid FROM ".tablename('ox_master_store')." where type_name like '%".$order['type_name']."%' AND uniacid = {$_W['uniacid']} AND status =1 AND black= 0 limit 200";        }elseif ($info['notify_rule']==2){            $distance = $info['distance']*10;            $sql = "SELECT phone,uid          ROUND(6378.138 * 2 * ASIN(SQRT(POW(SIN(({$order['mapx']} * PI() / 180- mapx * PI() / 180) / 2), 2) + COS({$order['mapx']}* PI() / 180) * COS(mapx * PI() / 180) * POW(SIN(({$order['mapy']} * PI() / 180- mapy * PI() / 180) / 2), 2))) * 10) AS juli         FROM           ".tablename('ox_master_store')."           where uniacid = {$_W['uniacid']} AND status =1 AND black= 0 Having juli<={$distance} limit 200";        }elseif ($info['notify_rule']==3){            $distance = $info['distance']*10;            $sql = "SELECT phone,uid          ROUND(6378.138 * 2 * ASIN(SQRT(POW(SIN(({$order['mapx']} * PI() / 180- mapx * PI() / 180) / 2), 2) + COS({$order['mapx']}* PI() / 180) * COS(mapx * PI() / 180) * POW(SIN(({$order['mapy']} * PI() / 180- mapy * PI() / 180) / 2), 2))) * 10) AS juli         FROM           ".tablename('ox_master_store')."           where uniacid = {$_W['uniacid']} AND status =1 AND black= 0  and type_name like '%".$order['type_name']."%'  Having juli<={$distance} limit 200";        }else{            return false;        }        $list = pdo_fetchall($sql);        $config = pdo_get( 'ox_master_code',["uniacid" => $_W['uniacid']] );        if($config && $config['status'] == 1){            $phones = [];            foreach ($list as $key=>$value){                if($value['phone']){                    $phones[]=$value['phone'];                }            }            //发送短信            $qcloud= new Qcloud();            $data['template_code'] = 'order_notify';            $data['phone'] = $phones;            $data['records_type'] = 1;            if($data['phone']){                 $qcloud->tempGroupSend($data,[$order['name'],$order['type_name']]);            }        }        $uniform = pdo_get( 'ox_master_uniform',["uniacid" => $_W['uniacid']] );        $template = pdo_get( 'ox_master_uniform_template',["uniacid" => $_W['uniacid']] );        if($uniform && $uniform['status']  == 1 && $template){            $params = [                'appid' => $uniform['appid'],                'template_id' => $template['template_id'],                'wxapp' =>$template['appid'],                'pagepath' => "pages/store/pages/manage/index",                'uid' => '',                'first' => $template['first'],                'keyword' => [                    $order['type_name'],$order['remark']                ],                'remark' => $template['remark'],            ];            foreach ($list as $k=>$v){                $params['uid'] = $v['uid'];                $res = Message::Instance()->uniformSend($params);                //var_dump($res);die;                //ox_log($v['uid']);            }        }        return;    }}