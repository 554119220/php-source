<?php
 namespace app\api\model; use app\api\service\Token; use app\api\model\User as UserModel; use app\api\service\Order as OrderService; use app\api\model\Vip as VipModel; use think\Log; use think\Request; use app\api\model\Integral as IntegralModel; class User extends BaseModel { public $uid; public function __construct($data = array()) { parent::__construct($data); } public static function checkCoupon() { goto W1RMy; jayYI: foreach ($coupon as $k => $v) { goto e0n22; YmkXR: if (!($v["\x65\x6e\144\x5f\164\x69\x6d\x65"] < time() || empty($result))) { goto WFhr2; } goto J8Kta; WVFsN: WFhr2: goto apoum; J8Kta: self::updateUserCoupon($v["\151\x64"], 0); goto WVFsN; e0n22: $result = Coupon::get($v["\x63\157\165\x70\x6f\156\137\151\x64"]); goto YmkXR; apoum: Nu59r: goto nIguU; nIguU: } goto oKsFs; W1RMy: $uid = Token::getCurrentUid(); goto uy7A2; uy7A2: $coupon = UserCoupon::where(["\x75\156\151\141\x63\x69\144" => session("\x75\x6e\151\x61\x63\x69\144"), "\165\x73\145\x72\137\151\144" => $uid])->select(); goto jayYI; oKsFs: UY__W: goto URK7w; URK7w: } private function updateUserCoupon($couponId, $status) { goto ILERs; s_J5Z: return $result ? true : false; goto Mxtp3; bxHd6: $result = UserCoupon::update($data); goto s_J5Z; ILERs: $data = ["\x69\144" => $couponId, "\163\x74\x61\164\x75\163" => $status, "\165\x6e\151\141\x63\151\x64" => session("\165\x6e\151\x61\143\151\x64")]; goto bxHd6; Mxtp3: } public static function updateUser() { goto OWfTT; fTIYp: $total = $total_amount; goto Bj6G1; HWiZp: foreach ($vips as $key => $vip) { goto B1eKa; B1eKa: if (!($user["\x69\156\164\145\x67\162\141\154"] >= $vip["\151\x6e\164\145\147\162\x61\154"])) { goto cBP8J; } goto yW_o8; LqpjQ: UserModel::update($users); goto WX3HI; tRZBu: $users["\x69\144"] = $uid; goto LqpjQ; KLSsF: cBP8J: goto giaOT; giaOT: W0OyB: goto fS7r5; WX3HI: goto GI7LH; goto KLSsF; yW_o8: $users["\x76\151\160\x5f\151\x64"] = $vip["\x69\144"]; goto tRZBu; fS7r5: } goto eTclx; TRZ4L: UserModel::update($userDatas); goto aaxEq; pijjg: $userDatas["\151\x6e\x74\x65\147\x72\x61\154"] += $integral; goto XFk4T; zTnS6: $user = UserModel::get($uid); goto yprAA; OWfTT: $uid = Token::getCurrentUid(); goto zTnS6; IWVwf: if (empty($order)) { goto SgEWU; } goto VrK2I; XFk4T: Hf1He: goto TRZ4L; UvZ1N: $total = 0; goto v8pSw; Bj6G1: if (!($total < 0)) { goto VQNK8; } goto UvZ1N; yprAA: if (empty($user)) { goto uKQCR; } goto dVCjv; biJlO: $integralSetting = IntegralModel::where($where)->where(["\x74\171\160\x65" => 1])->find(); goto BtcCp; dVCjv: $userData["\151\x64"] = $uid; goto M_2oh; BtcCp: if (!(!empty($integralSetting) && $integralSetting["\151\x6e\x74\x65\x67\x72\x61\x6c"] > 0)) { goto Hf1He; } goto VXV4a; aaxEq: SgEWU: goto Q8_h3; x0DOG: $order = OrderService::getDealOrderByUser($uid); goto IWVwf; eTclx: GI7LH: goto Kx7Jo; Dmy1i: UserAccess::checkIsAccess($uid); goto mr6r1; zFEoh: UserModel::update($userData); goto Kr7je; E4ymt: foreach ($order as $key => $value) { goto emQUF; ohnhY: DLupb: goto e56ke; JUfsr: $share = UserShareMoney::where($where)->where(["\x75\x73\x65\162\x5f\x69\x64" => $value["\x75\x73\x65\162\x5f\x69\x64"], "\x6f\162\x64\145\x72\137\x69\144" => $value["\x69\144"], "\x69\x73\x5f\x73\145\164\x74\x6c\145" => 0, "\151\x73\x5f\x64\x65\x6c\145\x74\x65" => 0])->select(); goto ILpbu; e56ke: MrPpq: goto tRKsU; c5rYq: $data["\151\156\164\145\x67\162\141\x6c"] = round($money); goto qAR_k; zTJD5: foreach ($share as $k => $v) { goto edyCM; SS_qJ: $parentData["\151\144"] = $v["\x70\141\x72\x65\156\164\137\151\x64"]; goto aQiUe; BjdLY: UexSP: goto FFV5i; FFV5i: $userShareMoneyData = ["\151\144" => $v["\151\x64"], "\151\163\x5f\163\x65\164\x74\154\145" => 1]; goto Py4FS; p3KIw: F7s_p: goto tvhfZ; DQgO2: if (empty($parent)) { goto UexSP; } goto SS_qJ; aQiUe: $parentData["\x74\x6f\x74\x61\154\x5f\x73\x68\141\162\145\137\x6d\x6f\156\x65\x79"] += $v["\x6d\157\x6e\x65\x79"]; goto FG2dx; FG2dx: $parentData["\x73\x68\x61\x72\145\137\x6d\157\x6e\x65\171"] += $v["\x6d\x6f\x6e\145\x79"]; goto DJC1O; DJC1O: UserModel::update($parentData); goto BjdLY; Py4FS: UserShareMoney::update($userShareMoneyData); goto p3KIw; edyCM: $parent = self::get($v["\x70\141\x72\x65\156\x74\137\x69\144"]); goto DQgO2; tvhfZ: } goto ohnhY; y3Jl7: S5g1j: goto xbTzI; mDcJj: if (!($money < 0)) { goto S5g1j; } goto niDtt; B7yn7: jUO_A: goto JUfsr; qAR_k: UserMoneyDetail::create($data); goto B7yn7; TPrvG: $data["\157\x72\144\145\x72\137\x69\x64"] = $value["\151\144"]; goto rE_Ig; rE_Ig: $money = $value["\157\137\141\x6d\157\x75\x6e\x74"]; goto mDcJj; Je3i4: if ($haveDetail) { goto jUO_A; } goto YMS5v; YMS5v: $total_freight += $value["\x65\x78\x70\162\x65\163\x73\x5f\160\162\151\143\x65"]; goto LPmMY; DV9ld: $data["\x75\x73\145\x72\137\x69\x64"] = $uid; goto TPrvG; emQUF: $haveDetail = UserMoneyDetail::where(["\x75\x73\145\x72\137\151\144" => $uid, "\157\162\x64\x65\x72\x5f\151\144" => $value["\151\x64"]])->find(); goto Je3i4; niDtt: $money = 0; goto y3Jl7; tRKsU: buyB0: goto T6wPN; LPmMY: $total_amount += $value["\x6f\x5f\x61\155\157\165\156\164"]; goto DV9ld; ILpbu: if (empty($share)) { goto MrPpq; } goto zTJD5; xbTzI: $data["\x6d\x6f\x6e\145\x79"] = $money; goto c5rYq; T6wPN: } goto lOziU; mr6r1: $where = "\x75\156\x69\141\143\x69\144\x20\75\40" . session("\165\156\151\x61\x63\x69\144"); goto x0DOG; VXV4a: $integral = round($total) * $integralSetting["\151\x6e\164\x65\x67\x72\x61\154"]; goto pijjg; P7EDC: $userDatas["\151\x64"] = $uid; goto Z7067; M_2oh: $userData["\141\143\x63\x65\x73\x73\x5f\x74\151\x6d\x65"] = time(); goto zFEoh; VrK2I: $total_freight = $total_amount = 0; goto E4ymt; lOziU: WHvkB: goto fTIYp; Z7067: $userDatas["\164\x6f\x74\141\x6c\x5f\155\157\156\145\x79"] += $total; goto biJlO; v8pSw: VQNK8: goto P7EDC; Kr7je: uKQCR: goto Dmy1i; Q8_h3: $vips = VipModel::where($where)->where("\x73\x74\141\x74\x75\163", "\x3d", 1)->order("\151\x6e\x74\x65\147\x72\x61\154", "\x64\145\x73\x63")->select(); goto HWiZp; Kx7Jo: } public function getBindTimeAttr($value) { goto BjXlS; k8Hf_: return date("\x59\55\155\55\144\40\110\72\151\72\x73", $value); goto e7kcS; J3Zvs: S4P34: goto k8Hf_; BjXlS: if (!empty($value)) { goto S4P34; } goto OpUdL; OpUdL: return null; goto J3Zvs; e7kcS: } public static function getUserLevel() { goto LNpGC; LNpGC: $uid = Token::getCurrentUid(); goto BTepW; BTepW: $user = self::get($uid); goto dKpLI; dKpLI: return $user; goto OXwtg; OXwtg: } public function address() { return $this->hasOne("\x55\x73\x65\x72\x41\x64\144\x72\145\x73\163", "\x75\163\145\162\x5f\x69\144", "\x69\144"); } public function userBalance() { return $this->hasOne("\x55\x73\x65\x72\x42\x61\x6c\141\156\143\x65", "\x75\163\145\x72\137\x69\x64", "\151\x64"); } public static function getByOpenID($openid) { $user = self::where("\157\160\145\156\151\x64", "\x3d", $openid)->find(); return $user; } public static function getById($id) { $user = self::where("\x69\144", "\x3d", $id)->find(); return $user; } public function comments() { return $this->hasMany("\123\x74\157\x72\145\103\157\x6d\155\145\156\164", "\x69\x64", "\165\163\x65\162\x5f\x69\x64"); } public static function updateUserWithData($data = array()) { $result = self::where("\x75\156\151\x61\143\151\144", "\x3d", session("\165\156\151\141\x63\x69\144"))->update($data); return $result !== false ? true : false; } public function getUserByParentId($parentId) { $user = self::where(["\x75\x6e\x69\x61\x63\151\144" => session("\165\x6e\151\141\x63\151\x64"), "\x70\141\x72\x65\156\164\137\151\144" => $parentId, "\151\x73\x5f\x64\x65\x6c\145\164\145" => 0])->field("\x69\144\x2c\x61\x76\141\164\141\162\54\156\x69\x63\x6b\156\141\x6d\x65\54\142\151\x6e\144\137\x74\151\x6d\145\54\x70\x61\x72\145\x6e\x74\137\151\x64")->order("\142\151\x6e\x64\x5f\x74\x69\x6d\145", "\144\x65\x73\143")->select(); return $user; } public static function userInfo() { goto eNvXM; j0VjU: TOylA: goto vSDTk; PGWyZ: $parent = self::get($user["\x70\141\162\145\156\x74\137\x69\x64"]); goto FQbft; vqL4_: $user["\160\x61\162\145\x6e\x74"] = "\xe6\200\xbb\345\272\x97"; goto kaYJ2; Q20kg: return $data; goto aZ78X; vRa0I: if (!empty($curLevel)) { goto TOylA; } goto VC8Os; jiPg0: $data = ["\x69\x64" => $user["\x69\144"], "\x6e\x69\143\x6b\x6e\141\155\145" => $user["\x6e\x69\x63\x6b\156\141\x6d\x65"], "\141\166\x61\164\141\x72" => $user["\x61\x76\141\x74\141\x72"], "\x69\163\x5f\x64\151\x73\x74\162\x69\142\x75\164\x6f\162" => $user["\151\163\x5f\x64\151\x73\x74\162\x69\142\165\164\x6f\162"], "\151\163\137\155\x6f\142\x69\x6c\145" => $user["\151\163\137\x6d\157\142\151\154\x65"], "\160\x61\162\145\x6e\x74" => $user["\x70\141\x72\x65\x6e\164"], "\151\x73\137\166\151\160" => $user["\151\x73\137\166\x69\x70"], "\143\157\x6c\154\x65\143\x74\137\x63\x6f\x75\x6e\x74" => Collect::countCollectByUid($uid) + ContentCollect::countContentCollectByUid($uid), "\x66\157\x6f\x74\x70\x72\x69\156\x74\137\x63\x6f\165\x6e\x74" => Footprint::countFootprintByUid($uid), "\x69\156\x74\145\147\162\x61\154" => $user["\151\x6e\164\145\147\x72\x61\154"], "\161\162\x5f\x63\157\x64\x65" => $user["\161\162\137\143\x6f\144\x65"], "\x76\x69\x70\x5f\x6e\x61\x6d\x65" => $user["\143\x75\x72\137\154\145\166\x65\x6c"], "\x62\x61\143\x6b\x67\162\x6f\x75\156\x64\137\151\x6d\x61\x67\x65" => $curLevel["\x69\155\141\147\145"], "\x61\147\x72\145\145" => $shareSetting["\141\147\162\x65\x65"]]; goto Q20kg; a7Ch0: $curLevel = VipModel::where("\x75\156\x69\141\143\x69\x64", "\75", session("\165\x6e\151\141\x63\x69\144"))->where("\x69\144", "\x3d", $user["\166\151\x70\137\151\x64"])->where("\163\x74\141\164\165\x73", "\x3d", 1)->find(); goto vRa0I; rl0PY: $shareSetting = ShareSetting::where("\x75\156\151\141\143\x69\x64", "\x3d", session("\165\x6e\151\x61\143\x69\144"))->field("\141\x67\x72\145\x65")->find(); goto jiPg0; PkWYE: $user["\x6e\x65\x78\164\137\155\x6f\x6e\145\x79"] = 0; goto CsIJ2; dtac4: goto yg4CE; goto j0VjU; xhJRW: $user["\151\x73\x5f\x76\x69\x70"] = 0; goto dtac4; WaAGK: yg4CE: goto EhM2H; c1eDw: $user["\x69\163\x5f\x76\x69\x70"] = 1; goto WaAGK; CsIJ2: $user["\x70\145\162\143\145\x6e\164"] = 0; goto xhJRW; vSDTk: $user["\143\165\162\137\154\145\x76\x65\x6c"] = $curLevel["\156\141\155\145"]; goto c1eDw; FQbft: $user["\x70\x61\x72\145\x6e\x74"] = $parent["\156\x69\143\153\x6e\x61\155\145"]; goto H5Nuk; VC8Os: $user["\x63\x75\162\x5f\x6c\x65\166\x65\154"] = "\xe6\x99\xae\xe9\x80\x9a\347\224\250\xe6\210\xb7"; goto PkWYE; eNvXM: $uid = Token::getCurrentUid(); goto uKFrH; mawJs: DTbi4: goto PGWyZ; EhM2H: if ($user["\160\141\x72\145\156\164\137\151\x64"] > 0 || $user["\x70\x61\162\x65\x6e\x74\x5f\x69\x64"] != '') { goto DTbi4; } goto vqL4_; uKFrH: $user = self::where("\165\x6e\151\x61\143\x69\x64", "\75", session("\x75\x6e\x69\x61\143\x69\x64"))->find($uid); goto a7Ch0; kaYJ2: goto SdgI3; goto mawJs; H5Nuk: SdgI3: goto rl0PY; aZ78X: } }