<?php
 namespace app\api\service; use think\Exception; use app\api\model\PlatformSettings; use app\boguan\model\PublicSettings; class AccessToken { private $tokenUrl; private $app_id; private $app_secret; const TOKEN_CACHED_KEY = "\141\143\x63\x65\163\x73"; const TOKEN_EXPIRE_IN = 7000; function __construct($type = '', $uniacid = '') { goto CGDOb; UTjBn: $acid = $uniacid; goto rOIEB; CGDOb: if ($uniacid != '') { goto nzX2b; } goto jlP6E; NrnoJ: $platform = PublicSettings::where("\165\x6e\151\x61\143\151\144", $acid)->find(); goto CJDBp; rz37H: $this->app_secret = $platform["\141\x70\x70\137\x73\145\x63\162\x65\164"]; goto tP3KQ; eyQ2x: $platform = PlatformSettings::where("\165\156\151\x61\143\151\144", $acid)->find(); goto t5uMP; CJDBp: NmYSX: goto d_GE3; rFdI_: $url = sprintf($url, $this->app_id, $this->app_secret); goto CzmgR; tP3KQ: $url = config("\163\145\x74\x74\x69\156\147\x73\x2e\141\x63\x63\145\163\163\137\x74\x6f\153\145\x6e\137\x75\x72\x6c"); goto rFdI_; nqsyv: ZzSKa: goto NrnoJ; t5uMP: goto NmYSX; goto nqsyv; CzmgR: $this->tokenUrl = $url; goto gZnWX; cI7oh: nzX2b: goto UTjBn; yfl0k: if ($type == "\x6f\x66\x66\x69\143\151\x61\x6c") { goto ZzSKa; } goto eyQ2x; yCBWd: goto WL4M6; goto cI7oh; jlP6E: $acid = session("\x75\x6e\151\x61\143\x69\144"); goto yCBWd; rOIEB: WL4M6: goto yfl0k; d_GE3: $this->app_id = $platform["\141\x70\x70\x69\144"]; goto rz37H; gZnWX: } public function get() { goto eYEKK; LHIGq: goto OIHek; goto hL_AG; OGLBe: return $token; goto LHIGq; ZxH78: if (!$token) { goto BOTmm; } goto OGLBe; b6uqx: return $this->getFromWxServer(); goto y882o; y882o: OIHek: goto ZZNZv; hL_AG: BOTmm: goto b6uqx; eYEKK: $token = $this->getFromCache(); goto ZxH78; ZZNZv: } private function getFromCache() { goto MGblX; MGblX: $token = cache(self::TOKEN_CACHED_KEY); goto GhFM5; BB0pR: NqFL8: goto OLYlh; GhFM5: if ($token) { goto NqFL8; } goto EP88y; OLYlh: return null; goto aSMpV; EP88y: return $token; goto BB0pR; aSMpV: } private function getFromWxServer() { goto wpUrd; UJZvO: BnDuJ: goto crf9C; crf9C: $this->saveToCache($token); goto Q8qbh; Q8qbh: return $token["\x61\143\x63\145\x73\x73\x5f\x74\x6f\153\145\x6e"]; goto iTDvu; K6NFE: if (empty($token["\145\162\162\x63\157\x64\x65"])) { goto BnDuJ; } goto G7Bv3; G7Bv3: throw new Exception($token["\x65\x72\x72\x6d\163\x67"]); goto UJZvO; VO6zw: if ($token) { goto K_wxy; } goto CCo7B; K1r8k: K_wxy: goto K6NFE; TOpSR: $token = json_decode($token, true); goto VO6zw; wpUrd: $token = curl_get($this->tokenUrl); goto TOpSR; CCo7B: throw new Exception("\xe8\216\267\xe5\217\226\101\x63\x63\145\163\x73\124\157\153\145\156\xe5\xbc\202\xe5\270\xb8"); goto K1r8k; iTDvu: } private function saveToCache($token) { cache(self::TOKEN_CACHED_KEY, $token, self::TOKEN_EXPIRE_IN); } }