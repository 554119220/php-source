<?php
 namespace app\api\service; use app\lib\enum\OrderStatusEnum; use app\lib\exception\OrderException; use app\lib\exception\TokenException; use think\Exception; use app\api\model\Order as OrderModel; use think\Loader; use think\Log; use app\api\model\Product as ProductModel; use app\api\service\Product as ProductService; use app\api\model\PlatformSettings; use app\api\model\User as UserModel; use app\api\model\Integral as IntegralModel; Loader::import("\x57\x78\120\x61\171\56\x57\170\x50\x61\171", EXTEND_PATH, "\x2e\101\160\x69\56\160\x68\x70"); class Pay { private $orderID; private $orderNo; function __construct($orderID) { goto GIyHA; h3zop: $setting = PlatformSettings::where(["\x75\156\x69\x61\x63\151\144" => session("\x75\x6e\151\x61\143\151\x64")])->find(); goto SYQwZ; wqkgl: $this->mch_key = $setting["\x6d\x63\150\137\x6b\145\x79"]; goto r3cqb; e3fdp: throw new Exception("\xe8\256\xa2\xe5\x8d\x95\345\x8f\xb7\344\xb8\215\345\x85\x81\350\256\270\344\xb8\272\x4e\125\x4c\x4c"); goto GuCOb; yqPu5: $this->app_secret = $setting["\x61\x70\160\137\163\145\143\162\145\164"]; goto FNywS; rx_5m: $this->orderID = $orderID; goto h3zop; GuCOb: fm9Wl: goto rx_5m; GIyHA: if ($orderID) { goto fm9Wl; } goto e3fdp; FNywS: $this->mch_id = $setting["\x6d\x63\x68\137\151\144"]; goto wqkgl; SYQwZ: $this->app_id = $setting["\141\x70\160\x69\144"]; goto yqPu5; r3cqb: } public function pay() { goto Acvnp; I2ujl: $data["\x63\x61\x6e\x63\x65\154\x5f\x74\x69\155\x65"] = time(); goto xefTv; GyVIn: $integral = ["\165\163\x65\162\137\151\x64" => $order["\165\163\145\x72\x5f\x69\144"], "\157\x72\144\145\x72\x5f\151\x64" => $order["\151\144"], "\x69\156\x74\145\x67\x72\x61\154" => $order["\151\x6e\164\145\x67\x72\141\x6c"]]; goto VOQLg; VHttq: Jl2Dz: goto vlYjY; Kwr1j: $user->integral += $order["\151\x6e\164\x65\x67\x72\x61\x6c"]; goto YAYp6; oYj3m: kdTzD: goto VHttq; Acvnp: $this->checkOrderValid(); goto wMXd0; IetcZ: $setting = PlatformSettings::where("\165\156\151\x61\x63\151\x64", session("\x75\156\x69\141\143\x69\x64"))->find(); goto pqM3O; pqM3O: if (!($setting["\x6f\x72\144\x65\162\137\x74\151\x6d\x65"] > 0 && $order)) { goto udfeI; } goto Up43m; b8aXK: $data["\151\x73\137\x63\141\156\x63\x65\x6c"] = 1; goto I2ujl; wMXd0: $order = OrderModel::get($this->orderID); goto IetcZ; viOLt: $this->checkSendTime($order); goto LEPEG; U22H2: if (!($overdue >= $setting["\x6f\162\144\x65\162\137\164\x69\155\x65"])) { goto Jl2Dz; } goto UgtsU; VOQLg: IntegralModel::returnIntegral($integral); goto q1KK4; xefTv: $result = OrderModel::update($data); goto E_j4B; YAYp6: $user->save(); goto GyVIn; E0IwH: $user = UserModel::get($order["\x75\x73\x65\x72\137\151\x64"]); goto Kwr1j; E_j4B: if (!($order["\x69\x73\137\151\156\164\145\x67\x72\x61\154"] == 1)) { goto q3BBy; } goto E0IwH; TCdOC: return ["\x6d\x73\x67" => "\xe8\xaf\245\xe8\xae\xa2\xe5\215\x95\xe5\xb7\262\350\xb6\x85\xe8\xbf\x87\346\x9c\211\xe6\x95\210\346\x9c\x9f\357\xbc\214\xe8\257\267\xe9\x87\x8d\346\226\260\xe4\270\x8b\xe5\x8d\x95", "\145\x72\x72\x6f\x72\x43\x6f\144\145" => 0]; goto oYj3m; Up43m: if (!($setting["\x6f\x72\144\x65\162\137\x74\151\x6d\145"] != '' && $setting["\x6f\x72\144\x65\162\x5f\x74\x69\x6d\x65"] > 0)) { goto Jqqmn; } goto oiV8E; Nzp3s: udfeI: goto viOLt; oiV8E: $overdue = floor((time() - strtotime($order["\143\x72\145\141\164\x65\x5f\164\x69\x6d\x65"])) % 86400 / 60); goto U22H2; ciY0B: if (!($result !== false)) { goto kdTzD; } goto TCdOC; vlYjY: Jqqmn: goto Nzp3s; UgtsU: $data["\151\x64"] = $order["\151\x64"]; goto b8aXK; LEPEG: return $this->makeWxPreOrder($order); goto O9aHs; q1KK4: q3BBy: goto ciY0B; O9aHs: } private function checkStock($data = array()) { goto ETaUu; Vwni6: return true; goto gy3Sm; QPJJd: foreach ($data as $key => $value) { goto TBhWM; DhZEF: throw new OrderException(["\x6d\x73\x67" => $str, "\145\x72\x72\157\162\143\157\144\145" => 0, "\x63\157\144\x65" => 200]); goto yg5Jc; nQ3XY: $str = $product["\156\x61\x6d\145"] . "\xe5\xba\223\xe5\255\230\xe9\x87\217\xe4\270\x8d\350\266\263"; goto mCnEA; hwM1D: Fj0ZE: goto pnWQP; yg5Jc: Xp9bJ: goto K5FIC; S_51P: j2ZUa: goto hwM1D; mCnEA: if ($product["\151\x73\137\x61\164\164\x72"] == 1) { goto XPoaM; } goto ZDh8n; i3bKZ: if (!($attr["\x73\164\157\143\x6b"] - $value["\156\x75\x6d"] < 0)) { goto j2ZUa; } goto pvyv3; P9QA_: $attr_id_list = json_encode($value["\141\x74\x74\x72\137\151\144\x5f\154\x69\x73\x74"]); goto nQ3XY; TBhWM: $product = ProductModel::get($value["\160\x72\157\x64\x75\x63\x74\111\x64"]); goto P9QA_; K5FIC: goto Fj0ZE; goto Er0_d; Er0_d: XPoaM: goto NHTZX; pvyv3: throw new OrderException(["\x6d\x73\x67" => $str, "\x65\162\162\x6f\162\143\157\144\x65" => 0, "\x63\157\x64\145" => 200]); goto S_51P; pnWQP: B6qF0: goto dZo98; ZDh8n: if (!($product["\x73\164\x6f\143\x6b"] - $value["\156\x75\x6d"] < 0)) { goto Xp9bJ; } goto DhZEF; NHTZX: $attr = $productService->getAttrInfo($value["\x70\162\x6f\144\165\x63\164\x49\144"], $attr_id_list); goto i3bKZ; dZo98: } goto u0hH2; u0hH2: XhpYS: goto Vwni6; ETaUu: $productService = new ProductService(); goto QPJJd; gy3Sm: } private function checkSendTime($data = array()) { return true; } private function makeWxPreOrder($order) { goto ZCJBv; AvaId: $wxOrderData->SetTotal_fee($order["\157\x5f\141\x6d\157\x75\x6e\164"] * 100); goto cyfAe; ZCJBv: $openid = Token::getCurrentTokenVar("\157\x70\x65\x6e\x69\x64"); goto Ihw5k; cyfAe: $wxOrderData->SetBody($order["\163\156\x61\160\137\x6e\141\x6d\145"]); goto jy_YT; Ihw5k: if ($openid) { goto sBtgT; } goto jSfIb; t9__C: PK2cp: goto hkYCk; k82dB: $wxOrderData->SetMch_id($this->mch_id); goto Vn2hV; jSfIb: throw new TokenException(); goto mrnwx; jy_YT: $wxOrderData->SetOpenid($openid); goto Lj3gy; sytsY: $wxOrderData->SetTrade_type("\112\123\x41\x50\111"); goto AvaId; mrnwx: sBtgT: goto TjBrb; GQI9j: return $this->getPaySignature($wxOrderData); goto KmcEL; TYB0a: $order["\163\x6e\141\160\137\156\x61\x6d\x65"] = mb_strcut($order["\x73\x6e\x61\x70\x5f\x6e\x61\x6d\x65"], "\x30", "\x31\x32\x34") . "\xe7\255\x89"; goto t9__C; LkITM: $wxOrderData->SetOut_trade_no($order["\157\162\144\x65\162\x5f\156\x6f"]); goto sytsY; TjBrb: if (!(strlen($order["\163\156\x61\x70\x5f\156\x61\155\145"]) >= 128)) { goto PK2cp; } goto TYB0a; hkYCk: $wxOrderData = new \WxPayUnifiedOrder(); goto LkITM; Lj3gy: $wxOrderData->SetAppid($this->app_id); goto k82dB; Vn2hV: $wxOrderData->SetNotify_url(config("\x73\145\x74\164\x69\x6e\147\x73\x2e\160\141\171\137\142\x61\143\x6b\137\x75\162\x6c")); goto GQI9j; KmcEL: } private function getPaySignature($wxOrderData) { goto bR4N6; bR4N6: $wxOrder = \WxPayApi::unifiedOrder($wxOrderData); goto gg2A9; fH6ty: $signature = $this->sign($wxOrder); goto X2v5W; gg2A9: $this->recordPreOrder($wxOrder); goto fH6ty; X2v5W: return $signature; goto mOLpb; mOLpb: } private function sign($wxOrder) { goto HjqXj; Dz9PR: unset($rawValues["\x61\x70\x70\x49\144"]); goto UGMOH; SQWST: $rawValues["\160\x61\171\x53\x69\x67\x6e"] = $sign; goto Dz9PR; UGMOH: return $rawValues; goto f0SDO; TPkl9: $jsApiPayData->SetAppid($this->app_id); goto AAyg0; EU86A: $jsApiPayData->SetSignType("\155\x64\65"); goto IzVFo; EyRLU: $jsApiPayData->SetPackage("\x70\162\145\x70\141\171\137\x69\x64\x3d" . $wxOrder["\x70\x72\x65\160\x61\171\x5f\151\x64"]); goto EU86A; AAyg0: $jsApiPayData->SetTimeStamp((string) time()); goto NyoL5; NyoL5: $rand = md5(time() . mt_rand(0, 1000)); goto eTfUV; IzVFo: $sign = $jsApiPayData->MakeSign(); goto ugIWq; eTfUV: $jsApiPayData->SetNonceStr($rand); goto EyRLU; ugIWq: $rawValues = $jsApiPayData->GetValues(); goto SQWST; HjqXj: $jsApiPayData = new \WxPayJsApiPay(); goto TPkl9; f0SDO: } private function recordPreOrder($wxOrder) { OrderModel::where("\x69\144", "\x3d", $this->orderID)->update(["\x70\162\145\x70\141\171\x5f\x69\144" => $wxOrder["\x70\162\x65\160\x61\171\137\x69\144"]]); } private function checkOrderValid() { goto q614K; KjSfq: if (Token::isValidOperate($order->user_id)) { goto q2aa2; } goto uOFKf; CGb6r: if ($order) { goto fUGMQ; } goto FdUXO; OQtrg: Yi6hv: goto Zdh63; BeD0G: q2aa2: goto W0oHw; q614K: $order = OrderModel::where("\x69\x64", "\x3d", $this->orderID)->find(); goto CGb6r; r_5SB: fUGMQ: goto KjSfq; PdXPs: throw new OrderException(["\x6d\163\147" => "\xe8\256\242\xe5\x8d\x95\345\267\xb2\346\x94\257\xe4\xbb\230\xe8\xbf\x87", "\145\x72\162\157\x72\103\x6f\144\x65" => 0, "\x63\157\144\145" => 400]); goto OQtrg; W0oHw: if (!($order->status != OrderStatusEnum::UNPAID)) { goto Yi6hv; } goto PdXPs; FdUXO: throw new OrderException(); goto r_5SB; uOFKf: throw new TokenException(["\155\163\x67" => "\xe8\xae\242\xe5\x8d\225\xe4\xb8\x8e\347\224\250\346\x88\xb7\344\xb8\215\345\x8c\xb9\351\205\215", "\x65\x72\x72\157\162\x43\157\x64\x65" => 0]); goto BeD0G; Zdh63: return true; goto wzXYe; wzXYe: } }