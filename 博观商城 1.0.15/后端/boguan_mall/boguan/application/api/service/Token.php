<?php
 namespace app\api\service; use app\lib\enum\ScopeEnum; use app\lib\exception\ForbiddenException; use app\lib\exception\TokenException; use think\Cache; use think\Controller; use think\Exception; use think\Request; class Token extends Controller { public static function generateToken() { goto GEEn5; GEEn5: $randChars = getRandChar(32); goto mmqmn; mmqmn: $timestamp = $_SERVER["\122\105\x51\x55\x45\x53\124\137\124\111\115\105\137\x46\x4c\117\x41\124"]; goto tm9_m; tm9_m: $salt = config("\163\145\x63\x75\162\x65\56\x74\x6f\x6b\x65\x6e\137\163\x61\154\x74"); goto qIZgG; qIZgG: return md5($randChars . $timestamp . $salt); goto TMWpq; TMWpq: } public static function getCurrentTokenVar($key) { goto SYEof; hbOcj: ql_cQ: goto Gfrl9; hzjjj: QfFhp: goto anmvR; sajIu: if (is_array($vars)) { goto ql_cQ; } goto hU4K1; anmvR: goto Shzrp; goto njL52; njL52: xqYn0: goto BPxjv; VVh_u: xKvik: goto nIaP7; NE5Rq: Shzrp: goto vF3ZX; SYEof: $token = Request::instance()->header("\x74\x6f\x6b\145\156"); goto HCoHF; nIaP7: return $vars[$key]; goto hzjjj; hU4K1: $vars = json_decode($vars, true); goto hbOcj; BPxjv: throw new TokenException(); goto NE5Rq; HCoHF: $vars = Cache::get($token); goto InKfJ; e92KU: goto QfFhp; goto VVh_u; gYD_0: throw new Exception("\xe5\260\235\350\xaf\x95\350\x8e\267\xe5\217\226\347\x9a\x84\x54\157\x6b\x65\x6e\345\x8f\x98\351\x87\217\344\270\x8d\xe5\xad\230\345\234\xa8"); goto e92KU; InKfJ: if (!$vars) { goto xqYn0; } goto sajIu; Gfrl9: if (array_key_exists($key, $vars)) { goto xKvik; } goto gYD_0; vF3ZX: } public static function getCurrentUid() { goto lZVBU; J2wYR: zoRv4: goto k0hZe; aCf3o: gni2w: goto Dp4Fi; IIRwb: throw new ParameterException(["\x6d\163\x67" => "\346\xb2\xa1\xe6\x9c\x89\346\x8c\x87\345\xae\232\xe9\234\200\xe8\246\x81\xe6\223\215\344\275\x9c\xe7\232\x84\xe7\x94\xa8\xe6\210\xb7\xe5\257\xb9\350\xb1\241"]); goto aCf3o; rs3fm: goto VKt0H; goto J2wYR; pcZkP: if ($userID) { goto gni2w; } goto IIRwb; gE7KM: $scope = self::getCurrentTokenVar("\163\x63\x6f\x70\x65"); goto uhz3Z; k0hZe: $userID = input("\147\145\164\56\165\x69\144"); goto pcZkP; uhz3Z: if ($scope == ScopeEnum::Super) { goto zoRv4; } goto ohaSI; lZVBU: $uid = self::getCurrentTokenVar("\x75\x69\x64"); goto gE7KM; Dp4Fi: return $userID; goto Xn37T; Xn37T: VKt0H: goto ZlUFy; ohaSI: return $uid; goto rs3fm; ZlUFy: } public static function needPrimaryScope() { goto BB64s; Dymvq: if ($scope >= ScopeEnum::User) { goto gYrOD; } goto Wgo1o; HLUAy: throw new TokenException(); goto mGScX; NR6Cm: quEKd: goto zXxCl; p7OuI: QIPds: goto NR6Cm; BB64s: $scope = self::getCurrentTokenVar("\163\143\x6f\x70\x65"); goto r05Vt; pgJTM: gYrOD: goto XxA1d; OucAD: kvANY: goto Dymvq; Wgo1o: throw new ForbiddenException(); goto KyZmE; r05Vt: if ($scope) { goto kvANY; } goto HLUAy; XxA1d: return true; goto p7OuI; KyZmE: goto QIPds; goto pgJTM; mGScX: goto quEKd; goto OucAD; zXxCl: } public static function needExclusiveScope() { goto sGAfi; peckF: goto EuYLW; goto C4B41; jK6fG: if ($scope == ScopeEnum::User) { goto CJvSe; } goto K2Rrz; iC2fh: nnCOa: goto gON8U; UsZSq: return true; goto iC2fh; K2Rrz: throw new ForbiddenException(); goto PAaJH; gON8U: EuYLW: goto pJL7i; PAaJH: goto nnCOa; goto Lio7V; sGAfi: $scope = self::getCurrentTokenVar("\x73\143\x6f\x70\145"); goto pVzew; C4B41: jg3uN: goto jK6fG; pVzew: if ($scope) { goto jg3uN; } goto B9Cpg; B9Cpg: throw new TokenException(); goto peckF; Lio7V: CJvSe: goto UsZSq; pJL7i: } public static function isValidOperate($checkedUID) { goto HTnxx; Ho8Jp: $currentOperateUID = self::getCurrentUid(); goto G36j9; NIAu3: Gtoaf: goto adz8T; ZZd2A: return true; goto NIAu3; HTnxx: if ($checkedUID) { goto f27D3; } goto qt1AP; G36j9: if (!($currentOperateUID == $checkedUID)) { goto Gtoaf; } goto ZZd2A; Sydsk: f27D3: goto Ho8Jp; qt1AP: throw new Exception("\xe6\243\200\xe6\237\xa5\125\x49\x44\xe6\x97\xb6\xe5\xbf\x85\351\241\xbb\344\274\240\345\205\245\344\270\200\344\xb8\xaa\x55\111\x44"); goto Sydsk; adz8T: return false; goto MW5Kg; MW5Kg: } public static function verifyToken($token) { goto BcXiG; BcXiG: $exist = Cache::get($token); goto Rm8FF; X5aB1: return false; goto Tc0Iw; UWcBJ: Mj3nf: goto V3Jbx; au4BU: return true; goto UWcBJ; Rm8FF: if ($exist) { goto LwZm0; } goto X5aB1; Tc0Iw: goto Mj3nf; goto x2u7p; x2u7p: LwZm0: goto au4BU; V3Jbx: } }