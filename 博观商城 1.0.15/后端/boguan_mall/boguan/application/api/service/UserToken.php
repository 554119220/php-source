<?php
 namespace app\api\service; use app\api\model\User; use app\lib\enum\ScopeEnum; use app\lib\exception\TokenException; use app\lib\exception\WeChatException; use think\Exception; use app\api\model\PlatformSettings; use app\api\model\UserAccess; use think\Log; class UserToken extends Token { protected $code; protected $wxLoginUrl; protected $wxAppID; protected $wxAppSecret; function __construct($code) { goto U_FAJ; vISqw: $this->wxAppSecret = $platform["\141\160\160\x5f\163\145\x63\162\x65\x74"]; goto CtsrR; qipWT: $this->wxAppID = $platform["\141\x70\x70\x69\x64"]; goto vISqw; CtsrR: $this->wxLoginUrl = sprintf(config("\x73\145\x74\x74\x69\x6e\147\163\x2e\154\x6f\x67\x69\x6e\137\165\x72\154"), $this->wxAppID, $this->wxAppSecret, $this->code); goto pJ_gp; JFrkg: $platform = PlatformSettings::where("\x75\x6e\x69\141\x63\151\x64", session("\x75\156\x69\x61\143\x69\144"))->find(); goto qipWT; U_FAJ: $this->code = $code; goto JFrkg; pJ_gp: } public function get() { goto q_dEq; nWBzR: return $this->processLoginError($wxResult); goto V1u1y; hrToo: if ($loginFail) { goto n_KX1; } goto kS3HY; kS3HY: return $this->grantToken($wxResult); goto Ju0eq; quhg2: $loginFail = array_key_exists("\145\x72\x72\x63\157\x64\x65", $wxResult); goto hrToo; EYYnX: if (empty($wxResult)) { goto Dph6S; } goto quhg2; ftYDZ: throw new Exception("\350\216\267\345\217\226\x73\145\163\163\x69\157\x6e\x5f\x6b\145\171\345\x8f\212\x6f\x70\x65\156\x49\x44\346\x97\xb6\xe5\xbc\x82\345\xb8\xb8\xef\xbc\x8c\345\276\xae\344\xbf\241\xe5\x86\x85\351\x83\xa8\xe9\x94\231\350\xaf\xaf"); goto QknTr; QknTr: k5UnN: goto uEsNg; V1u1y: pJVI8: goto SaQ_g; CUJ5D: $wxResult = json_decode($result, true); goto EYYnX; q_dEq: $result = curl_get($this->wxLoginUrl); goto CUJ5D; Ju0eq: goto pJVI8; goto BW9gm; BW9gm: n_KX1: goto nWBzR; P2i4_: Dph6S: goto ftYDZ; SaQ_g: goto k5UnN; goto P2i4_; uEsNg: } private function processLoginError($wxResult) { throw new WeChatException(["\155\163\147" => $wxResult["\x65\162\x72\x6d\x73\x67"], "\x65\162\x72\x6f\162\103\157\144\145" => $wxResult["\x65\x72\162\143\x6f\144\145"]]); } private function saveToCache($wxResult) { goto pnH31; j1Wv7: $result = cache($key, $value, $expire_in); goto ul4dr; FRjbX: throw new TokenException(["\155\163\147" => "\346\x9c\215\xe5\x8a\241\xe5\231\250\xe7\xbc\x93\345\255\x98\345\274\202\345\xb8\xb8", "\145\162\x72\x6f\162\143\x6f\x64\145" => 10005]); goto SePk0; YLd8e: $value = json_encode($wxResult); goto TTAxa; SePk0: A_t9n: goto SGNui; pnH31: $key = self::generateToken(); goto YLd8e; TTAxa: $expire_in = config("\163\x65\x74\x74\151\x6e\147\x73\56\x74\157\153\x65\x6e\137\x65\170\x70\x69\162\x65\x5f\151\156"); goto j1Wv7; ul4dr: if ($result) { goto A_t9n; } goto FRjbX; SGNui: return $key; goto XcOAK; XcOAK: } private function grantToken($wxResult) { goto h5H30; h5H30: $openid = $wxResult["\x6f\160\145\156\151\144"]; goto gKqmY; R6u59: $uid = $user->id; goto R1SfV; Fs0ty: $cachedValue = $this->prepareCachedValue($wxResult, $uid); goto P1Ur6; Z6L8J: return $token; goto UKBXe; gKqmY: $user = User::getByOpenID($openid); goto VZE0J; PaiXi: Tu6pf: goto jFQyG; VZE0J: if (!$user) { goto ZunPk; } goto R6u59; jFQyG: UserAccess::checkIsAccess($uid); goto Fs0ty; AQbkb: ZunPk: goto H3N86; R1SfV: goto Tu6pf; goto AQbkb; H3N86: $uid = $this->newUser($openid); goto PaiXi; P1Ur6: $token = $this->saveToCache($cachedValue); goto Z6L8J; UKBXe: } private function prepareCachedValue($wxResult, $uid) { goto GOxvA; aDtw5: $cachedValue["\163\x63\157\160\145"] = ScopeEnum::User; goto B2nZ3; B2nZ3: return $cachedValue; goto xcKxo; Nz24i: $cachedValue["\x75\151\144"] = $uid; goto aDtw5; GOxvA: $cachedValue = $wxResult; goto Nz24i; xcKxo: } private function newUser($openid) { goto TlXJF; LPgLQ: $user = User::create($data); goto HgZ20; WI86C: $data["\157\x70\145\156\x69\x64"] = $openid; goto lt2wr; lt2wr: $data["\x63\x72\x65\x61\164\x65\x5f\164\151\x6d\145"] = time(); goto LPgLQ; HgZ20: return $user->id; goto qXYKY; TlXJF: $data["\165\156\151\141\143\x69\144"] = session("\165\156\151\141\143\x69\x64"); goto WI86C; qXYKY: } }