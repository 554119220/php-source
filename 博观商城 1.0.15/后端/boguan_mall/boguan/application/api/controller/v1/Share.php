<?php
 namespace app\api\controller\v1; use app\api\controller\BaseController; use app\api\service\Token as TokenService; use app\api\model\User as UserModel; use app\api\service\User as UserService; use app\api\model\Share as ShareModel; use app\api\model\ShareSetting as ShareSettingModel; use app\api\model\UserShareMoney; use app\api\model\Withdraw as WithdrawModel; use app\api\service\Wechat as WechatService; use app\api\service\Share as ShareService; use app\api\service\Image as ImageService; use think\Request; use Imagick; class Share extends BaseController { function __construct(Request $request = null) { parent::__construct($request); ShareModel::checkDistributor(); } public function bindParent($parentId = 0) { goto WK35F; WK35F: if (!($parentId == 0 || $parentId == '')) { goto Fmcfh; } goto kWeh5; BkXss: return $result; goto hkhZK; kWeh5: return ["\x6d\163\x67" => "\xe6\234\252\xe6\x8c\207\345\256\x9a\347\x88\xb6\xe7\272\247\x69\x64", "\145\x72\162\157\162\103\157\144\x65" => 0]; goto TrZ3W; TrZ3W: Fmcfh: goto tUjh1; tUjh1: $result = ShareService::bindParentById($parentId); goto BkXss; hkhZK: } public function sharePoster() { goto OgGOq; hYfQJ: $thumb = \think\Image::open($savePath . $fileNames); goto oKl5h; DZz8O: $newImage = \think\Image::open($savePath . $newImageSrc); goto tOo2K; oB5I_: unlink($savePath . $qrName); goto VNITY; L_eZr: return ["\x6d\163\147" => "\350\216\267\xe5\x8f\x96\xe6\x88\220\345\x8a\x9f", "\x64\x61\164\141" => $qrCodeUrl, "\x65\162\162\x6f\x72\x43\x6f\x64\145" => 1]; goto m3Ykf; Anbqi: $circleName = $ImageService->getCircleImage($savePath . $avatarName, $savePath); goto ktxZt; Dp3Yc: unlink($savePath . $newImageSrc); goto dm1tJ; BdOpR: $h = $wh[1] * $percent; goto hYfQJ; B8vuF: $savePath = "\x70\165\142\x6c\151\x63" . DS . "\x73\164\141\x74\151\x63" . DS . "\161\x72\x63\x6f\x64\x65" . DS . "\x73\164\x6f\162\x65\137" . session("\165\x6e\x69\x61\143\x69\144") . DS; goto uF2zN; aKEJh: S9pQG: goto qSSOx; fhKqK: $qrCode = WechatService::createQrCode('', $uid, "\x73\x68\141\x72\x65"); goto DkOWh; f59fN: $qrCodeUrl = MINI_WE7_PATH . $savePath . $posterName; goto kxJYI; TxxXH: $saveRoot = ROOT_PATH; goto B8vuF; Qvc79: $wh = getimagesize($savePath . $fileNames); goto MaLol; DkOWh: $user = UserModel::get($uid); goto i0Fr6; YtJdj: $qrName = uniqid() . "\56\x70\156\x67"; goto bUBab; TJXuH: $percent = 0.8; goto Qvc79; ktxZt: $fileNames = uniqid() . "\x2e\160\156\147"; goto DgIWY; tOo2K: $logoName = uniqid() . "\x2e\160\156\147"; goto o82_j; xflFT: if (!file_exists($savePath . $fileNames)) { goto pQ7Sb; } goto IdtyQ; R6VQG: $settings["\x69\155\x61\x67\145"] = str_replace(WE7_PATH, '', $settings["\151\x6d\x61\147\145"]); goto bgV7W; LEXlS: DjeZy: goto Cl2LC; VQorF: unlink($circleName); goto U5oO7; HPyBl: unlink($savePath . $avatarName); goto hYQEA; ODWVs: $poster = $settings["\160\x6f\163\x74\145\162"]; goto WVcUb; yz0UJ: $posterName = uniqid() . "\x2e\160\156\x67"; goto TJXuH; yXsxh: $settings["\151\x6d\x61\x67\145"] = "\x70\x75\x62\154\151\x63\x2f\x62\x6f\x67\x75\141\x6e\57\x69\155\141\147\145\x73\x2f\x70\157\163\x74\145\x72\x2e\x70\x6e\x67"; goto aKEJh; o82_j: $ImageService = new ImageService(); goto p1y5D; U5oO7: Vyc5g: goto L_eZr; KJl1e: $image->thumb(750, 1200, \think\Image::THUMB_CENTER)->save($savePath . $newImageSrc); goto DZz8O; WVcUb: if (file_exists($settings["\151\155\141\147\145"])) { goto S9pQG; } goto yXsxh; qSSOx: $uid = TokenService::getCurrentUid(); goto fhKqK; HRKB1: $user->save(); goto OuKwZ; oKl5h: $thumb->thumb($w, $h, \think\Image::THUMB_FILLED)->save($savePath . $posterName); goto f59fN; Ph_Zn: unlink($userQrCode); goto YETD_; dm1tJ: PcQqq: goto hOTme; bUBab: $thumb = \think\Image::open($savePath . $qrCode); goto oJg7A; ljh0i: if (!file_exists($circleName)) { goto Vyc5g; } goto VQorF; bgV7W: $settings["\151\x6d\141\147\x65"] = str_replace("\x68\x74\x74\x70\x3a", '', $settings["\151\x6d\141\147\145"]); goto iPEr1; p1y5D: $avatar = $ImageService->getRemoteImage($user["\x61\x76\141\x74\x61\162"], $savePath, $logoName); goto VhSdu; xFbft: if (!file_exists($savePath . $qrName)) { goto HNNXg; } goto oB5I_; Xg04S: $fontRoot = "\x70\x75\x62\x6c\x69\x63\57\142\x6f\x67\165\141\156\x2f\146\157\x6e\x74\x73\57\x41\x61\x42\141\x6e\123\157\x6e\x67\x2e\x74\164\146"; goto YtJdj; kxJYI: $user->qr_code = $qrCodeUrl; goto HRKB1; OgGOq: $settings = ShareSettingModel::where("\165\156\x69\141\x63\151\144", "\75", session("\165\156\151\x61\x63\151\x64"))->field("\151\x6d\141\x67\x65\x2c\x70\x6f\x73\x74\145\x72")->find(); goto R6VQG; XqizQ: $newImageSrc = uniqid() . "\56\x70\x6e\147"; goto KJl1e; uF2zN: if (is_dir($saveRoot . $savePath)) { goto VHuM2; } goto BbRBa; hyLuz: YPsL_: goto xFbft; iPEr1: $settings["\x69\x6d\141\147\145"] = str_replace("\150\x74\164\x70\x73\x3a", '', $settings["\151\155\141\x67\145"]); goto ODWVs; BbRBa: mkdir($saveRoot . $savePath, 0777, true); goto enXNr; zW2KS: $thumb->thumb($poster[1]["\x77\x69\144\x74\150"] + 10, $poster[1]["\167\151\144\x74\150"] + 10, \think\Image::THUMB_FIXED)->save($savePath . $avatarName); goto Anbqi; YETD_: yemid: goto TxxXH; Cl2LC: if (!file_exists($savePath . $avatarName)) { goto ESoGk; } goto HPyBl; enXNr: VHuM2: goto Xg04S; IdtyQ: unlink($savePath . $fileNames); goto dhgRB; i0Fr6: $userQrCode = str_replace(WE7_PATH, '', $user["\x71\x72\x5f\143\157\x64\145"]); goto Bt__6; dhgRB: pQ7Sb: goto ljh0i; MaLol: $w = $wh[0] * $percent; goto BdOpR; y6KVd: $thumb = \think\Image::open($savePath . $avatar); goto zW2KS; vgIPL: unlink($savePath . $avatar); goto LEXlS; Gd3em: unlink($savePath . $qrCode); goto hyLuz; VNITY: HNNXg: goto J_Rde; Bt__6: if (!($user["\161\162\x5f\x63\157\144\145"] != '' && file_exists($userQrCode))) { goto yemid; } goto Ph_Zn; OuKwZ: if (!file_exists($savePath . $newImageSrc)) { goto PcQqq; } goto Dp3Yc; OewWd: $image = \think\Image::open($settings["\151\155\141\x67\145"]); goto XqizQ; DgIWY: $newImage->water($savePath . $qrName, array($poster[0]["\154\145\x66\x74"], $poster[0]["\x74\x6f\x70"] - 5))->water($circleName, array($poster[1]["\x6c\x65\x66\164"], $poster[1]["\x74\x6f\x70"]))->text($user["\x6e\151\143\153\x6e\x61\155\x65"] ? $user["\156\151\x63\153\156\x61\x6d\x65"] : "\x6e\151\143\x6b\156\x61\155\x65", $fontRoot, $poster[2]["\x66\157\x6e\164\123\x69\x7a\145"] + 20, "\43" . $poster[2]["\x63\x6f\154\157\162"], array($poster[2]["\x6c\x65\146\x74"] + 8, $poster[2]["\164\x6f\160"] + 26))->save($savePath . $fileNames); goto yz0UJ; VhSdu: $avatarName = uniqid() . "\56\x70\156\x67"; goto y6KVd; hYQEA: ESoGk: goto xflFT; oJg7A: $thumb->thumb($poster[0]["\167\x69\144\x74\x68"] + 10, $poster[0]["\167\x69\x64\x74\150"] + 10, \think\Image::THUMB_FIXED)->save($savePath . $qrName); goto OewWd; hOTme: if (!file_exists($savePath . $qrCode)) { goto YPsL_; } goto Gd3em; J_Rde: if (!file_exists($savePath . $avatar)) { goto DjeZy; } goto vgIPL; m3Ykf: } public function shareWithdraw($page = 0, $size = 12) { goto dW8Z7; dW8Z7: $uid = TokenService::getCurrentUid(); goto iAT_4; a0qdG: return ["\x6d\163\147" => "\350\x8e\xb7\345\217\x96\xe5\244\261\350\264\xa5", "\x65\162\x72\x6f\162\x43\x6f\x64\x65" => 1]; goto Zbw5G; OhNHt: return ["\x6d\x73\147" => "\xe8\x8e\xb7\345\217\x96\346\x88\x90\xe5\x8a\237", "\x64\141\x74\141" => $withdraw, "\x65\x72\162\157\162\x43\157\144\145" => 1]; goto Sw7X6; SCvhM: if (!empty($withdraw)) { goto aVEmO; } goto a0qdG; Zbw5G: aVEmO: goto OhNHt; iAT_4: $withdraw = WithdrawModel::getAllWithdraw($uid, $page, $size); goto SCvhM; Sw7X6: } public function shareData() { goto e3Ryk; dhPOO: return ["\x64\141\164\141" => $data, "\x65\x72\162\x6f\x72\103\x6f\144\x65" => 1]; goto GCic3; O4eK1: $parent = UserModel::get($user["\160\141\x72\145\x6e\164\137\151\x64"]); goto e8nbg; tyQ_g: xPAhP: goto encaB; c1bhv: $userService = new UserService(); goto JsG0X; ww8LA: $referrer = $parent["\x6e\151\143\153\156\141\155\145"]; goto tyQ_g; aT2ff: oxzgB: goto O4eK1; e8nbg: $shareSetting = ShareSettingModel::where("\x75\x6e\151\141\x63\x69\x64", "\75", session("\x75\156\x69\x61\x63\151\144"))->field("\156\157\164\x69\x63\145\x2c\155\x69\x6e\137\x77\x69\164\x68\x64\x72\x61\167\x2c\x61\x67\162\145\x65")->find(); goto MVGma; R2eo9: return ["\x6d\x73\147" => "\346\x82\250\344\270\x8d\xe6\x98\xaf\xe6\216\250\xe5\xb9\277\345\x91\x98", "\x65\x72\162\157\x72\103\157\x64\x65" => 0]; goto aT2ff; MVGma: $referrer = "\346\200\273\345\272\x97"; goto pT_Q0; utMqY: if (!($user["\151\x73\x5f\144\151\x73\164\x72\x69\x62\165\164\157\x72"] != 1)) { goto oxzgB; } goto R2eo9; e3Ryk: $uid = TokenService::getCurrentUid(); goto c1bhv; JsG0X: $user = UserModel::get($uid); goto utMqY; encaB: $data = ["\162\x65\146\145\x72\162\145\162" => $referrer, "\167\151\164\150\144\162\x61\167\137\x6d\x6f\x6e\145\x79" => WithdrawModel::sumUserWithdraw($uid), "\x73\x68\141\162\145\137\x6d\157\156\145\x79" => $user["\163\x68\141\x72\145\x5f\155\157\x6e\x65\x79"], "\155\151\156\x5f\x77\151\x74\x68\x64\x72\x61\167" => $shareSetting["\155\151\x6e\x5f\x77\151\x74\x68\144\x72\141\167"], "\164\157\164\141\x6c\x5f\163\x68\141\162\145\x5f\x6d\157\x6e\x65\x79" => $user["\x74\x6f\164\x61\154\x5f\x73\x68\141\162\145\x5f\x6d\x6f\x6e\145\x79"], "\156\157\x74\x5f\163\145\x74\x74\x6c\145\x5f\x6d\157\x6e\145\x79" => UserShareMoney::sumNotSettleShareMoney($uid), "\167\x61\x69\x74\137\x70\141\171\137\x6d\x6f\x6e\x65\171" => WithdrawModel::sumUserWaitPay($uid), "\x74\145\141\155\137\x73\x75\x6d" => $userService->countDistributors(), "\157\x72\144\145\162\137\163\x75\x6d" => $userService->shareOrderAmount(), "\156\x6f\164\x69\143\x65" => $shareSetting["\156\157\x74\x69\143\145"], "\x71\162\137\143\157\x64\145" => $user["\161\x72\x5f\143\x6f\x64\x65"]]; goto dhPOO; pT_Q0: if (empty($parent)) { goto xPAhP; } goto ww8LA; GCic3: } public function shareSubmit() { goto JA9lm; mu20C: if (!$haveSubmit) { goto NSMSW; } goto anszk; vSfq3: $result = ShareModel::create($data); goto FxNt4; XTrFN: unset($data["\146\x6f\162\155\111\x64"]); goto blml5; PAEzf: if (!isset($data["\146\x6f\162\x6d\x49\144"])) { goto dE1Gn; } goto p2yMK; N9cHt: if ($setting["\x64\151\x73\x74\x72\151\x62\165\164\157\162\137\x63\x6f\156\144\151\x74\151\x6f\x6e"] == "\x31") { goto S5_B9; } goto ct9W6; E5Mle: $haveSubmit = ShareModel::where(["\165\x6e\151\141\x63\x69\x64" => session("\165\x6e\x69\141\x63\151\x64"), "\165\163\x65\x72\137\151\x64" => $uid, "\x73\164\141\164\165\163" => 0])->order("\151\x64", "\144\x65\163\143")->find(); goto mu20C; CRZmH: $msg = "\347\224\263\xe8\xaf\xb7\345\267\xb2\351\200\x9a\xe8\xbf\207"; goto SzBsE; zVjAS: J5CKZ: goto Cnjex; SzBsE: $user->is_distributor = 1; goto Nwp6Q; P1g2T: $data["\x73\x74\x61\x74\165\163"] = 1; goto FblZ1; VAK9B: goto INcGW; goto sJo5b; JA9lm: $post = input("\160\157\163\164\56"); goto V0jGc; RRFkh: return json(["\x6d\x73\147" => $validate->getError(), "\145\162\162\157\162\103\x6f\x64\145" => 0]); goto zVjAS; FxNt4: if ($result !== false) { goto bI5Sn; } goto tC97Z; gYkjw: $validate = \think\Loader::validate("\123\x68\x61\162\x65"); goto n9eA3; Wbx0x: INcGW: goto n7h9g; Kn00r: fFyQ1: goto gYkjw; n7h9g: $user->save(); goto F2seh; F2seh: return json(["\x6d\x73\147" => $msg, "\145\162\162\157\x72\x43\157\144\x65" => 1]); goto raAPZ; E4C4G: RkroE: goto HJ4NK; p2yMK: $data["\160\x72\145\x70\141\x79\x5f\151\x64"] = $data["\x66\x6f\162\155\111\144"]; goto XTrFN; V0jGc: $setting = ShareSettingModel::where(["\165\x6e\151\141\143\x69\x64" => session("\x75\x6e\151\x61\143\151\144")])->find(); goto aCuFP; fd4Iq: $user = UserModel::get($uid); goto XhzMh; xJ24g: $user->is_distributor = 2; goto VAK9B; VAUtx: return json(["\155\x73\x67" => "\346\202\250\xe5\267\xb2\346\230\xaf\xe5\210\206\351\x94\x80\xe5\x95\206", "\x65\162\162\x6f\162\x43\x6f\144\145" => 0]); goto E4C4G; n9eA3: if ($validate->scene("\x73\165\x62\x6d\151\x74")->check($post)) { goto J5CKZ; } goto RRFkh; HJ4NK: $data = ["\165\156\151\141\x63\x69\x64" => session("\165\156\x69\x61\143\x69\x64"), "\x75\x73\145\x72\x5f\151\144" => $uid, "\x70\x61\x72\x65\x6e\x74\x5f\151\x64" => $user["\x70\141\162\x65\156\x74\137\x69\144"], "\156\141\x6d\145" => $post["\x6e\141\155\x65"], "\160\150\157\x6e\145" => $post["\x70\x68\157\x6e\x65"]]; goto wIqbC; Cnjex: $uid = TokenService::getCurrentUid(); goto E5Mle; aCuFP: if (!($setting["\163\167\x69\164\143\x68"] == 0 || $setting["\x64\x69\x73\164\162\x69\x62\x75\164\x6f\162\137\143\x6f\156\x64\151\164\x69\157\156"] > 2)) { goto fFyQ1; } goto AJMFw; xaFTC: NSMSW: goto fd4Iq; raAPZ: mMEQD: goto eCJbw; S_NBE: bI5Sn: goto N9cHt; AJMFw: return json(["\155\x73\147" => "\347\x94\263\350\xaf\xb7\351\x80\232\351\201\x93\xe5\xb7\262\xe5\x85\xb3\351\227\xad", "\x65\162\x72\157\x72\103\157\144\x65" => 0]); goto Kn00r; FblZ1: cjAXU: goto PAEzf; XhzMh: if (!($user["\x69\163\137\144\151\163\164\162\x69\142\x75\x74\157\x72"] == "\x31")) { goto RkroE; } goto VAUtx; wIqbC: if (!($setting["\x64\151\x73\x74\x72\151\142\x75\x74\157\162\137\x63\x6f\x6e\x64\x69\x74\151\157\x6e"] == "\x31")) { goto cjAXU; } goto P1g2T; Nwp6Q: $user->distributor_time = time(); goto Wbx0x; sJo5b: S5_B9: goto CRZmH; HdMvQ: goto mMEQD; goto S_NBE; anszk: return json(["\x6d\163\x67" => "\xe6\x82\250\xe5\xb7\262\xe6\217\220\xe4\272\xa4\xef\274\x8c\xe8\xaf\xb7\345\x8b\xbf\351\207\x8d\345\xa4\215\xe6\223\215\xe4\275\234", "\x65\162\x72\x6f\x72\103\157\x64\x65" => 0]); goto xaFTC; tC97Z: return json(["\155\x73\x67" => "\347\224\263\xe8\xaf\267\xe5\244\261\350\264\245\xef\274\214\xe8\257\267\347\250\x8d\345\200\x99\xe5\206\x8d\350\257\x95", "\x65\162\162\157\x72\103\157\144\x65" => 0]); goto HdMvQ; blml5: dE1Gn: goto vSfq3; ct9W6: $msg = "\346\x8f\x90\344\272\244\xe6\210\x90\345\x8a\237\357\274\214\xe8\xaf\xb7\xe7\xad\x89\345\276\205\345\xae\xa1\346\xa0\xb8"; goto xJ24g; eCJbw: } public function shareTeam() { goto qIXy1; JCsNS: return ["\x64\141\164\141" => $dis, "\x65\162\x72\157\162\103\x6f\144\145" => 1]; goto OmXX_; hhggv: $dis = $userService->getDistributors(); goto JCsNS; qIXy1: $userService = new UserService(); goto hhggv; OmXX_: } public function shareOrder($page = 0, $size = 12) { goto SdOzS; I5Pfq: ik_xf: goto gfPPh; V0ZDo: goto ik_xf; goto oTd1y; lKnuq: if (!empty($dis)) { goto DfrKv; } goto itGnA; lKqLb: return ["\x64\141\x74\x61" => array_page($dis, $size, $page), "\145\162\162\x6f\x72\103\157\144\145" => 1]; goto I5Pfq; oTd1y: DfrKv: goto lKqLb; itGnA: return ["\155\163\x67" => "\xe8\x8e\267\xe5\217\x96\345\xa4\xb1\350\264\245", "\x65\162\x72\157\162\x43\157\x64\145" => 0]; goto V0ZDo; EGG76: $dis = $userUserService->getShareOrder(); goto lKnuq; SdOzS: $userUserService = new UserService(); goto EGG76; gfPPh: } }