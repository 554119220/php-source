<?php
 namespace app\boguan\service; use app\api\service\AccessToken; use app\boguan\model\PublicSettings; use app\boguan\service\Image as ImageService; use app\api\model\PlatformSettings; use think\Log; use app\boguan\model\User as UserModel; use app\boguan\model\PublicUser; use app\boguan\model\PublicTemplate; class Official { public function setTemplateData($data) { goto uvO7v; AiXU4: $tpl = "\124\x4d\60\60\60\x31\65"; goto eQicd; X7Gql: return false; goto XMRz2; gszvp: return false; goto XdZnW; XdZnW: TtzVn: goto MOO1p; LyyZn: $tpl = ''; goto cFQ3q; yZgro: $PublicTpl = new PublicTemplate(); goto efvc9; kgqRu: if (!($data["\x74\171\x70\145"] == "\x70\x61\x69\x64")) { goto hk2tn; } goto AiXU4; eQicd: $pagePath = "\57" . MODEL . "\x2f\x70\x61\147\145\163\57\x41\x64\x6d\151\x6e\x2f\x69\x6e\x64\145\170\57\151\x6e\x64\145\x78"; goto Bka7T; Bka7T: $first = "\347\224\250\xe6\x88\xb7\xe8\256\242\xe5\x8d\225\346\224\xaf\344\273\x98\346\210\220\xe5\x8a\x9f\346\217\220\351\x86\x92"; goto cIplH; cIplH: hk2tn: goto yZgro; XMRz2: GwXZ0: goto LyyZn; mCadh: if (!$user->isEmpty()) { goto GwXZ0; } goto X7Gql; PH3l4: $user = UserModel::where(["\x75\x6e\151\x61\x63\151\x64" => $data["\x75\156\x69\141\143\151\x64"], "\151\x73\x5f\155\x6f\142\x69\154\x65" => 1])->where("\x6f\x66\146\151\143\151\141\x6c\x5f\x69\x64", "\74\76", '')->field("\151\144\54\157\146\x66\x69\x63\151\141\x6c\x5f\x69\144")->select(); goto mCadh; ikmBz: if (!($template == '')) { goto TtzVn; } goto gszvp; MOO1p: foreach ($user as $key => $value) { goto PHVj0; PHVj0: $public_user = PublicUser::get($value["\157\146\x66\151\143\151\141\154\x5f\151\144"]); goto kDvLC; GLIdJ: QcrB1: goto lQ33K; tOdv3: IJhYR: goto GLIdJ; qT3mg: $setData = ["\141\160\x70\x69\x64" => $platform["\x61\x70\160\x69\144"], "\157\160\145\156\x69\x64" => $public_user["\x6f\x70\145\156\151\x64"], "\x74\160\154\x49\x64" => $template, "\160\x61\x67\x65\120\x61\164\150" => $pagePath, "\x66\x69\162\163\x74" => $first, "\153\x65\171\167\x6f\x72\x64\61" => $data["\x6b\x65\171\x77\x6f\x72\144\x31"], "\153\x65\x79\167\157\x72\144\62" => $data["\153\x65\x79\x77\x6f\162\144\x32"], "\x72\145\x6d\141\162\x6b" => $data["\162\145\x6d\141\162\x6b"], "\x75\156\151\x61\143\x69\x64" => $data["\165\156\x69\x61\143\151\144"]]; goto u43EJ; u43EJ: self::sendTemplate($setData, $data["\164\x79\x70\145"]); goto tOdv3; kDvLC: if (empty($public_user)) { goto IJhYR; } goto qT3mg; lQ33K: } goto D8OMh; efvc9: $template = $PublicTpl->getTemplateById($tpl, $data["\x75\x6e\151\x61\x63\x69\144"]); goto ikmBz; uvO7v: $platform = PlatformSettings::where(["\x75\156\151\x61\x63\151\144" => $data["\x75\156\x69\x61\143\151\144"]])->field("\141\160\x70\x69\x64")->find(); goto PH3l4; w6e6l: $first = ''; goto kgqRu; cFQ3q: $pagePath = ''; goto w6e6l; D8OMh: j3wS7: goto ekxvY; ekxvY: } public function sendTemplate($data, $type) { goto yihIN; yihIN: $setData = []; goto leale; yRjUA: $post = ["\x74\x6f\x75\x73\145\x72" => $data["\x6f\x70\x65\x6e\x69\x64"], "\x74\x65\155\x70\154\x61\x74\x65\x5f\151\144" => $data["\164\160\x6c\111\144"], "\165\x72\x6c" => '', "\155\151\x6e\151\x70\162\157\x67\162\x61\x6d" => ["\141\x70\x70\151\x64" => $data["\x61\160\160\x69\x64"], "\160\x61\147\x65\x70\x61\x74\150" => $data["\160\x61\x67\x65\120\x61\164\150"]], "\x64\x61\164\141" => $setData]; goto p0YGf; PNsxT: $request_url = config("\163\145\164\x74\151\156\147\163\x2e\x73\x65\x6e\x64\137\x6f\x66\146\151\143\x69\x61\154\x5f\x74\160\x6c\x5f\x75\162\154"); goto T4b5e; tJPUQ: $result = json_decode(curl_post($url, $post), true); goto O195N; IBUyY: $access_token = $accessToken->get(); goto PNsxT; T4b5e: $url = sprintf($request_url, $access_token); goto tJPUQ; wePr4: lkeTw: goto yRjUA; leale: if (!($type == "\x70\x61\151\144")) { goto lkeTw; } goto LwVr4; O195N: if ($result["\x65\162\162\143\x6f\144\145"] == 0) { goto dQurz; } goto w5ZuZ; C5udc: goto eb65Y; goto u3euE; u3euE: dQurz: goto vq9Tv; j1gEq: return false; goto C5udc; w5ZuZ: Log::record($result); goto j1gEq; p0YGf: $accessToken = new AccessToken("\x6f\146\146\x69\x63\151\x61\x6c", $data["\165\156\151\x61\143\151\144"]); goto IBUyY; EecI_: eb65Y: goto Wt3Hs; vq9Tv: return true; goto EecI_; LwVr4: $setData = ["\x66\151\x72\163\164" => ["\x76\141\154\x75\145" => $data["\146\151\162\163\164"], "\x63\157\154\x6f\x72" => "\x23\x31\x37\63\61\x37\x37"], "\x6f\162\x64\x65\x72\x50\162\157\x64\x75\143\x74\x4e\141\x6d\x65" => ["\166\x61\x6c\165\145" => $data["\153\145\171\x77\157\162\144\x31"], "\x63\157\154\157\162" => "\x23\x31\67\x33\x31\x37\67"], "\157\x72\144\x65\162\115\157\156\145\171\123\x75\x6d" => ["\166\x61\154\x75\145" => $data["\153\x65\171\167\x6f\162\x64\62"], "\143\x6f\154\x6f\x72" => "\43\x31\x37\63\61\x37\67"], "\122\145\155\x61\x72\x6b" => ["\166\141\154\x75\x65" => $data["\162\145\x6d\141\162\x6b"], "\x63\157\x6c\x6f\162" => "\x23\x31\x37\x33\61\67\67"]]; goto wePr4; Wt3Hs: } public function getPublicFans($next_openid = '') { goto aY7Ok; aY7Ok: $accessToken = new AccessToken("\157\x66\x66\151\143\151\x61\x6c"); goto C5RIE; riB0t: $request_url = config("\163\x65\x74\x74\151\156\x67\x73\56\147\145\164\137\146\141\x6e\x73\137\x75\x72\x6c"); goto w14ZE; w14ZE: $url = sprintf($request_url, $token, $next_openid); goto Jpss8; NiFn2: return $result; goto lggvB; C5RIE: $token = $accessToken->get(); goto riB0t; Jpss8: $result = json_decode(curl_get($url), true); goto NiFn2; lggvB: } public function getPublicFanInfo($openid) { goto ybF97; oEAiz: $result = json_decode(curl_get($url), true); goto Z6ona; XPig_: $url = sprintf($request_url, $token, $openid); goto oEAiz; Z6ona: return $result; goto R7Qx4; aySq0: $request_url = config("\163\145\164\164\151\156\x67\x73\x2e\x67\x65\x74\x5f\146\141\156\x73\x5f\151\156\x66\157\137\x75\162\154"); goto XPig_; imLjY: $token = $accessToken->get(); goto aySq0; ybF97: $accessToken = new AccessToken("\x6f\146\x66\x69\143\x69\141\154"); goto imLjY; R7Qx4: } public function getPublicFansData($next_openid = '') { goto OHxRl; SGqKF: hxMV5: goto XhTLz; ebSJZ: goto JVtd5; goto d4Q6l; XhTLz: $i++; goto ebSJZ; eOR1c: if (!($i < $count)) { goto z4qOi; } goto bjYUS; aC7v1: $count = ceil($result["\x74\157\164\141\x6c"] / $result["\x63\x6f\x75\x6e\x74"]); goto TgwLL; bjYUS: $res = self::getPublicFans($result["\x6e\x65\x78\164\x5f\x6f\160\145\x6e\x69\x64"]); goto NvBsm; YZik0: return $data; goto mndl4; FU1BS: $data = []; goto G6HBC; TgwLL: $i = 0; goto WIqp3; G6HBC: if (!($result["\x63\157\x75\156\x74"] > 0)) { goto MPLPW; } goto aC7v1; NvBsm: $data[$i] = $res["\144\x61\164\x61"]; goto SGqKF; WIqp3: JVtd5: goto eOR1c; OHxRl: $result = self::getPublicFans($next_openid); goto FU1BS; ZEC2c: array_map(function ($value) use(&$openidData) { $openidData = array_merge($openidData, array_values($value)); }, $data); goto YZik0; d4Q6l: z4qOi: goto sz5VL; IObtc: $openidData = []; goto ZEC2c; sz5VL: MPLPW: goto IObtc; mndl4: } public function getPublicOauthQrCode() { goto dUB4n; gF2b1: return $qrCodeUrl; goto o0YZK; dq0MX: $request = ["\x72\145\144\x69\162\145\x63\164\x5f\x75\162\x69" => urlencode(config("\x73\x65\x74\x74\151\x6e\147\163\56\162\145\x64\x69\162\145\143\164\137\x75\x72\x69") . "\77\165\156\x69\141\x63\151\144\x3d" . session("\165\x6e\151\141\x63\x69\144")), "\163\143\x6f\160\145" => "\163\x6e\x73\141\x70\x69\x5f\x75\163\145\x72\x69\156\146\157", "\x73\x74\141\164\145" => md5(uniqid())]; goto kS0sh; uW1Gg: $qrCodeUrl = $ImageService->getQrCode($oauth_url); goto gF2b1; dUB4n: $ImageService = new ImageService(); goto URnZu; UcgIA: $oauth_url = "\150\164\164\x70\x73\x3a\x2f\x2f\x6f\160\x65\156\x2e\167\x65\151\x78\151\156\56\161\x71\x2e\x63\x6f\x6d\x2f\x63\x6f\156\156\x65\143\164\x2f\x6f\141\x75\164\150\x32\x2f\x61\x75\x74\150\x6f\162\x69\x7a\145\77\x61\x70\x70\x69\144\x3d{$publicSettings["\141\x70\160\151\144"]}\46\x72\x65\144\151\x72\145\x63\x74\x5f\165\x72\x69\75{$request["\x72\x65\x64\x69\162\x65\143\x74\x5f\x75\162\151"]}\x26\x72\145\163\160\157\x6e\163\x65\137\164\x79\x70\145\75\x63\x6f\144\x65\46\x73\x63\157\160\x65\75{$request["\163\143\x6f\x70\145"]}\46\x73\164\141\x74\x65\x3d{$request["\163\x74\141\x74\x65"]}\x26\x75\156\x69\x61\143\x69\x64\75{$uniacid}\43\x77\145\x63\x68\141\164\x5f\x72\x65\144\x69\x72\x65\143\164"; goto uW1Gg; kS0sh: $uniacid = session("\165\x6e\x69\x61\143\x69\x64"); goto UcgIA; URnZu: $publicSettings = PublicSettings::where("\165\x6e\x69\x61\143\151\x64", session("\x75\156\151\141\x63\151\x64"))->find(); goto dq0MX; o0YZK: } public function getTemplateId($data) { goto S9xRs; S9xRs: $accessToken = new AccessToken("\x6f\x66\x66\151\143\x69\x61\154"); goto cYcU5; cYcU5: $token = $accessToken->get(); goto OBvt7; QwAp9: return $result; goto h_tG6; OBvt7: $url = sprintf(config("\x73\145\x74\x74\151\156\x67\x73\x2e\141\144\x64\137\x6f\x66\146\x69\143\151\141\154\x5f\164\x70\154\x5f\165\x72\x6c"), $token); goto Ac5yF; Ac5yF: $post = ["\164\x65\155\x70\x6c\141\x74\145\x5f\x69\144\x5f\x73\x68\157\x72\164" => $data["\x69\144"]]; goto Gqz3W; Gqz3W: $result = curl_post($url, $post); goto QwAp9; h_tG6: } public function deleteTemplateId($data) { goto WbhPt; NLaX9: $url = sprintf(config("\163\145\x74\164\x69\x6e\147\163\x2e\144\145\154\x5f\157\x66\146\x69\143\x69\x61\154\x5f\164\x70\154\x5f\165\x72\x6c"), $token); goto IK3yW; KtdnY: return $result; goto CdrV5; IK3yW: $post = ["\x74\145\x6d\x70\x6c\x61\x74\145\x5f\151\x64" => $data["\164\160\154"]]; goto TSfu5; WbhPt: $accessToken = new AccessToken("\x6f\x66\x66\151\x63\151\141\154"); goto WmFu5; WmFu5: $token = $accessToken->get(); goto NLaX9; TSfu5: $result = curl_post($url, $post); goto KtdnY; CdrV5: } }